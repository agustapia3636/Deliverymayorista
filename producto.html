<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | Delivery Mayorista</title>
  <link rel="stylesheet" href="css/estilos.css" />

  <style>
    :root{
      --bg: #0f0f1a;
      --card: #0c0c17;
      --card2: #0a0a12;
      --txt: #ffffff;
      --muted: rgba(255,255,255,.75);
      --accent: #ffa400;
      --btn: #202432;
      --shadow: rgba(0,0,0,.55);
    }

    body{ background: var(--bg); }

    main.producto-pagina { padding: 28px 16px 60px; min-height: 70vh; }

    /* contenedor central (mejor “uso del espacio”) */
    .producto-wrapper{
      max-width:1200px;
      margin: 0 auto;
      display:flex;
      gap: 42px;
      align-items:flex-start;

      opacity:0;
      transform:translateY(10px);
      transition:opacity .25s ease,transform .25s ease;
    }
    .producto-wrapper.visible{ opacity:1; transform:translateY(0); }

    /* caja de imagen */
    .producto-imagen{
      flex: 0 0 52%;
      background: radial-gradient(900px 520px at 50% 0%, rgba(255,164,0,.06), transparent 60%),
                  var(--card);
      border-radius: 24px;
      padding: 18px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 18px 40px rgba(0,0,0,0.35);
    }
    .producto-imagen img{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background: var(--card2);
      object-fit: contain;
      display:block;
    }

    /* caja info */
    .producto-info{
      flex: 0 0 42%;
      background: radial-gradient(900px 520px at 50% -120px, rgba(255,0,93,.05), transparent 60%),
                  var(--card);
      border-radius: 24px;
      padding: 18px 18px 20px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 18px 40px rgba(0,0,0,0.35);
    }

    .producto-codigo{ opacity:.8; margin:0 0 6px; color: var(--muted); }
    .producto-titulo{ margin:0 0 10px; font-size:34px; line-height:1.08; letter-spacing: .2px; }
    .producto-categoria{ opacity:.9; margin:0 0 12px; color: #c9c9ff; font-weight: 600; }
    .producto-descripcion{ opacity:.95; margin:0 0 14px; color: rgba(255,255,255,.88); line-height: 1.35; }
    .producto-precio{ font-size:30px; font-weight:900; margin:12px 0 10px; color: var(--accent); }
    .producto-stock{ margin:0; opacity:.95; color: rgba(255,255,255,.85); }
    .producto-stock.stock-sin{ color:#ff4d4f; font-weight:800; }
    .producto-stock.stock-bajo{ color:#ffd666; font-weight:800; }

    .producto-acciones{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:16px;
    }
    .btn-secundario,.btn-whatsapp,.btn-nav{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 18px;
      border-radius: 12px;
      border:none;
      cursor:pointer;
      font-size: 15px;
      text-decoration:none;
      background: var(--btn);
      color:#fff;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      transition: transform .08s ease, filter .08s ease;
      white-space: nowrap;
    }
    .btn-secundario:hover,.btn-nav:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .btn-whatsapp{
      background:#1ebe57;
      font-weight:900;
    }
    .btn-whatsapp:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    .producto-nav{
      max-width:1200px;
      margin: 18px auto 0;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    #producto-loading{
      max-width:1200px;
      margin: 0 auto 14px;
      display:none;
      opacity:.85;
      color:#c9c9ff;
    }

    /* mobile */
    @media (max-width: 900px){
      main.producto-pagina{ padding:18px 12px 42px; }
      .producto-wrapper{ flex-direction:column; gap:16px; }
      .producto-imagen,.producto-info{ width:100%; flex:1 1 auto; }
      .producto-acciones a,.producto-acciones button{ width:100%; }
      .producto-titulo{ font-size:28px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
  <div class="topbar-inner">
    <span class="logo-link">Delivery Mayorista</span>
    <a href="catalogo.html" class="topbar-link">Ver catálogo</a>
  </div>
</header>

  <main class="producto-pagina contenedor">
    <div id="producto-loading">Cargando producto...</div>

    <div class="producto-wrapper">
      <div class="producto-imagen">
        <img id="imagen-principal" src="" alt="Producto" />
      </div>

      <div id="producto-info" class="producto-info"></div>
    </div>

    <div id="producto-nav" class="producto-nav"></div>
  </main>

  <footer class="footer">Catálogo mayorista · Delivery Mayorista</footer>

  <script type="module">
    import { db } from "./js/firebase-init.js";
    import {
      collection, getDocs, getDoc, doc, query, where, limit
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ====== CONFIG ======
    const COL_PRODUCTOS = "productos";
    const BASE_IMG = "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

    const CLAVE_CACHE_CATALOGO = "cache_catalogo_v2"; // mismo nombre que en catalogo.html
    const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6h
    const CACHE_IMG_NAME = "dm-img-v1";

    // cache por producto
    const cacheProdKey = (codigo) => `cache_producto_${String(codigo || "").trim()}_v1`;

    // ====== DOM ======
    const loadingEl = document.getElementById("producto-loading");
    const wrapper   = document.querySelector(".producto-wrapper");
    const infoDiv   = document.getElementById("producto-info");
    const imgEl     = document.getElementById("imagen-principal");
    const navEl     = document.getElementById("producto-nav");

    // ====== Loader solo si tarda ======
    if (loadingEl) loadingEl.style.display = "none";
    let tLoading = setTimeout(() => {
      if (loadingEl) loadingEl.style.display = "block";
    }, 300);

    function visible() {
      clearTimeout(tLoading);
      if (loadingEl) loadingEl.style.display = "none";
      if (wrapper) wrapper.classList.add("visible");
    }

    // ====== Helpers ======
    function getCodigoURL() {
      return new URLSearchParams(location.search).get("codigo");
    }

    function volverAlCatalogo() {
      const ref = document.referrer || "";
      if (ref.includes("catalogo.html")) history.back();
      else location.href = "catalogo.html";
    }
    window.__dm_back = volverAlCatalogo;

    function parsearPrecio(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string") {
        const limpio = v.replace(/\./g, "").replace(",", ".");
        const n = Number(limpio);
        return isNaN(n) ? null : n;
      }
      const n = Number(v);
      return isNaN(n) ? null : n;
    }

    function normalizarProducto(raw, codigoFallback) {
      const p = raw || {};
      const codigo = p.codigo ?? p.Codigo ?? codigoFallback ?? p.id ?? "";
      const nombre = p.nombre ?? p.Nombre ?? "";
      const categoria = p.categoria ?? p.Categoria_Princ ?? "";
      const subcategoria = p.subcategoria ?? p.Sub_Categoria ?? "";
      const descripcion = p.descripcionLarga ?? p.descripcion ?? p.Descripcion ?? "";
      const precio = parsearPrecio(p.precio ?? p.PrecioMayorista);
      const stock = Number(p.stock ?? p.Stock ?? 0);
      const imagen = p.imagen ?? p.Imagen ?? "";
      return { ...p, codigo: String(codigo), nombre, categoria, subcategoria, descripcion, precio, stock, imagen };
    }

    // ====== Cache helpers (producto) ======
    function cacheProductoLeer(codigo) {
      try {
        const raw = localStorage.getItem(cacheProdKey(codigo));
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ts || !obj.data) return null;
        if ((Date.now() - obj.ts) > CACHE_TTL_MS) return null;
        return obj.data;
      } catch {
        return null;
      }
    }

    function cacheProductoGuardar(codigo, data) {
      try {
        localStorage.setItem(cacheProdKey(codigo), JSON.stringify({ ts: Date.now(), data }));
      } catch {}
    }

    // ====== Imágenes: precarga + warm cache ======
    async function warmCacheImage(url) {
      try {
        if (!("caches" in window)) return;
        const cache = await caches.open(CACHE_IMG_NAME);
        const hit = await cache.match(url, { ignoreSearch: true });
        if (hit) return;
        await cache.add(url);
      } catch {}
    }

    function candidatosImagen(p) {
      const codigo = p.codigo || "";
      const urlDirecta = p.imagen || "";

      const c = [
        urlDirecta,
        `${BASE_IMG}/${codigo}.jpg`,
        `${BASE_IMG}/${codigo}.JPG`,
        `${BASE_IMG}/${codigo}.jpeg`,
        `${BASE_IMG}/${codigo}.JPEG`,
        `${BASE_IMG}/${codigo}.png`,
        `${BASE_IMG}/${codigo}.PNG`,
        `${BASE_IMG}/${codigo}.webp`,
        `${BASE_IMG}/${codigo}.WEBP`,
      ].filter(Boolean);

      return [...new Set(c)];
    }

    async function setImagenProducto(p) {
      const cands = candidatosImagen(p);

      imgEl.loading = "eager";
      imgEl.decoding = "async";
      imgEl.referrerPolicy = "no-referrer";

      // warm-up del primer candidato (si existe)
      if (cands[0]) warmCacheImage(cands[0]);

      // elegimos el primero que cargue OK
      let i = 0;
      const probar = () => {
        if (i >= cands.length) return;
        imgEl.src = cands[i];
        i++;
      };

      imgEl.onerror = probar;
      imgEl.onload = () => warmCacheImage(imgEl.src);

      // precarga paralela suave (no bloquea)
      for (const u of cands.slice(0, 3)) {
        const im = new Image();
        im.decoding = "async";
        im.referrerPolicy = "no-referrer";
        im.onload = () => warmCacheImage(u);
        im.src = u;
      }

      probar();
    }

    function armarWhatsApp(p) {
      const precioTxt = (p.precio != null)
        ? `$ ${p.precio.toLocaleString("es-AR", { maximumFractionDigits: 0 })}`
        : "Consultar";

      const msg = [
        "Hola! Me interesa este producto:",
        "",
        `Código: ${p.codigo}`,
        `Producto: ${p.nombre}`,
        `Precio mayorista: ${precioTxt}`,
        "",
        "¿Me pasás disponibilidad y cantidades mínimas?"
      ].join("\n");

      return `https://wa.me/?text=${encodeURIComponent(msg)}`;
    }

    function renderNav(codigoActual) {
      if (!navEl) return;

      let catalogo = null;
      try {
        const raw = localStorage.getItem(CLAVE_CACHE_CATALOGO);
        if (raw) {
          const obj = JSON.parse(raw);
          if (Array.isArray(obj?.data)) catalogo = obj.data;
          // si el cache está en formato {ts,data} (como en catalogo.html)
          if (!catalogo && Array.isArray(obj?.data) === false && Array.isArray(obj?.data) !== true) {
            // no hacemos nada
          }
        }
      } catch {}

      // soporta ambos formatos:
      if (!catalogo || !catalogo.length) {
        // intento formato {ts,data}
        try {
          const raw2 = localStorage.getItem(CLAVE_CACHE_CATALOGO);
          if (raw2) {
            const obj2 = JSON.parse(raw2);
            if (Array.isArray(obj2?.data)) catalogo = obj2.data;
          }
        } catch {}
      }

      if (!catalogo || !catalogo.length) {
        navEl.innerHTML = `
          <button class="btn-nav" type="button" onclick="window.__dm_back()">Volver al listado</button>
        `;
        return;
      }

      // normalizamos para buscar por codigo
      const catNorm = catalogo.map(x => (x && typeof x === "object") ? x : {}).map(x => ({
        ...x,
        codigo: String(x.codigo ?? x.Codigo ?? x.id ?? "")
      }));

      const idx = catNorm.findIndex(x => String(x.codigo) === String(codigoActual));
      if (idx === -1) {
        navEl.innerHTML = `
          <button class="btn-nav" type="button" onclick="window.__dm_back()">Volver al listado</button>
        `;
        return;
      }

      const ant = catNorm[(idx - 1 + catNorm.length) % catNorm.length]?.codigo || "";
      const sig = catNorm[(idx + 1) % catNorm.length]?.codigo || "";

      window.__dm_ir = (c) => location.href = `producto.html?codigo=${encodeURIComponent(c)}`;

      navEl.innerHTML = `
        <button class="btn-nav" type="button" onclick="window.__dm_ir('${ant}')">← ${ant}</button>
        <button class="btn-nav" type="button" onclick="window.__dm_back()">Volver al listado</button>
        <button class="btn-nav" type="button" onclick="window.__dm_ir('${sig}')">${sig} →</button>
      `;
    }

    function renderProducto(raw, codigoFallback) {
      const p = normalizarProducto(raw, codigoFallback);

      setImagenProducto(p);
      renderNav(p.codigo);

      let stockCls = "producto-stock";
      if (!isNaN(p.stock)) {
        if (p.stock === 0) stockCls += " stock-sin";
        else if (p.stock > 0 && p.stock <= 5) stockCls += " stock-bajo";
      }

      const categoriaHtml = (p.categoria || p.subcategoria)
        ? `<p class="producto-categoria">${p.categoria || ""}${(p.categoria && p.subcategoria) ? " · " : ""}${p.subcategoria || ""}</p>`
        : "";

      const precioHtml = (p.precio != null)
        ? `<p class="producto-precio">$ ${p.precio.toLocaleString("es-AR", { maximumFractionDigits: 0 })}</p>`
        : "";

      const descHtml = p.descripcion
        ? `<p class="producto-descripcion">${escapeHtml(p.descripcion)}</p>`
        : "";

      infoDiv.innerHTML = `
        <p class="producto-codigo">${escapeHtml(p.codigo)}</p>
        <h1 class="producto-titulo">${escapeHtml(p.nombre || "Producto")}</h1>
        ${categoriaHtml}
        ${descHtml}
        ${precioHtml}
        <p class="${stockCls}">Stock: ${Number.isFinite(p.stock) ? p.stock : 0}</p>
        <div class="producto-acciones">
          <button class="btn-secundario" type="button" onclick="window.__dm_back()">← Volver</button>
          <a class="btn-whatsapp" href="${armarWhatsApp(p)}" target="_blank" rel="noopener">
            Consultar por WhatsApp
          </a>
        </div>
      `;

      visible();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ====== Firestore ======
    async function cargarDesdeFirestore(codigo) {
      // 1) por campo codigo
      const ref = collection(db, COL_PRODUCTOS);
      const q = query(ref, where("codigo", "==", codigo), limit(1));
      const snap = await getDocs(q);

      if (!snap.empty) {
        const d = snap.docs[0];
        return { id: d.id, ...d.data() };
      }

      // 2) fallback por doc.id
      const docRef = doc(db, COL_PRODUCTOS, codigo);
      const one = await getDoc(docRef);
      if (one.exists()) return { id: one.id, ...one.data() };

      return null;
    }

    // ====== Init ======
    async function init() {
      const codigo = getCodigoURL();

      if (!codigo) {
        infoDiv.innerHTML = "<h2>Producto no encontrado</h2><p>Falta el código en la URL.</p>";
        visible();
        return;
      }

      renderNav(codigo);

      // 1) cache local por producto (instantáneo)
      const cached = cacheProductoLeer(codigo);
      if (cached) {
        renderProducto(cached, codigo);

        // 2) refresh background
        cargarDesdeFirestore(codigo)
          .then(prod => {
            if (prod) {
              cacheProductoGuardar(codigo, prod);
              renderProducto(prod, codigo);
            }
          })
          .catch(() => {});
        return;
      }

      // 2) Firestore directo
      try {
        const prod = await cargarDesdeFirestore(codigo);

        if (!prod) {
          infoDiv.innerHTML = `
            <h2>Producto no encontrado</h2>
            <p>No existe el código <b>${escapeHtml(codigo)}</b> en Firestore.</p>
            <div class="producto-acciones">
              <button class="btn-secundario" type="button" onclick="window.__dm_back()">← Volver</button>
            </div>
          `;
          visible();
          return;
        }

        cacheProductoGuardar(codigo, prod);
        renderProducto(prod, codigo);
      } catch (e) {
        console.error("Error producto:", e);
        infoDiv.innerHTML = `
          <h2>Error cargando producto</h2>
          <p>No se pudo obtener el producto desde Firestore.</p>
          <div class="producto-acciones">
            <button class="btn-secundario" type="button" onclick="window.__dm_back()">← Volver</button>
          </div>
        `;
        visible();
      }
    }

    init();
  </script>
</body>
</html>
