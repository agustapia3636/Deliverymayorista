<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | Delivery Mayorista</title>
  <link rel="stylesheet" href="css/estilos.css" />

  <style>
    /* ====== LAYOUT DESKTOP ====== */
    main.producto-pagina {
      padding: 40px 16px 60px;
    }

    main.producto-pagina .producto-wrapper {
      max-width: 1200px;
      margin: 0 auto 24px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 48px;
    }

    /* Imagen a la izquierda */
    .producto-imagen {
      flex: 0 0 48%;
    }

    .producto-imagen img {
      width: 100%;
      height: auto;
      border-radius: 22px;
      object-fit: contain;
      background: #0a0a12;
      display: block;
    }

    /* Info a la derecha */
    .producto-info {
      flex: 0 0 42%;
    }

    .producto-acciones {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      flex-wrap: wrap;
    }

    .btn-secundario,
    .btn-whatsapp,
    .btn-nav {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      text-decoration: none;
      border: none;
    }

    .btn-secundario {
      background: #202432;
      color: #fff;
    }

    .btn-whatsapp {
      background: #1ebe57;
      color: #fff;
      font-weight: 600;
    }

    .btn-nav {
      background: #202432;
      color: #fff;
    }

    .producto-nav {
      max-width: 1200px;
      margin: 20px auto 0;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* ====== MOBILE / TABLET ====== */
    @media (max-width: 900px) {
      main.producto-pagina {
        padding: 24px 12px 36px;
      }

      main.producto-pagina .producto-wrapper {
        flex-direction: column;
        gap: 20px;
      }

      .producto-imagen,
      .producto-info {
        flex: 1 1 auto;
        width: 100%;
      }

      .producto-acciones {
        flex-direction: column;
        width: 100%;
      }

      .producto-acciones a {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="index.html" class="logo-link">Delivery Mayorista</a>
      <a href="catalogo.html" class="topbar-link">Ver catálogo</a>
    </div>
  </header>

  <!-- PÁGINA DE PRODUCTO -->
  <main class="producto-pagina contenedor">
    <div class="producto-wrapper">
      <!-- Imagen -->
      <div id="producto-imagen" class="producto-imagen">
        <img id="imagen-principal" src="" alt="producto" />
        <div id="miniaturas" class="miniaturas"></div>
      </div>

      <!-- Info -->
      <div id="producto-info" class="producto-info"></div>
    </div>

    <!-- Navegación anterior / siguiente -->
    <div id="producto-nav" class="producto-nav"></div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    Catálogo mayorista · Delivery Mayorista
  </footer>

  <!-- ============ LÓGICA JS ============ -->
  <script>
    const BASE_IMG =
      "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

    // Convierte "1992,2" → 1992.2
    function parsearPrecio(valor) {
      if (typeof valor === "number") return valor;
      if (typeof valor === "string") {
        const limpio = valor.replace(/\./g, "").replace(",", ".");
        const num = Number(limpio);
        return isNaN(num) ? null : num;
      }
      return null;
    }

    function obtenerCodigoDeURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("codigo");
    }

    async function cargarProducto() {
      const codigoURL = obtenerCodigoDeURL();
      const infoDiv = document.getElementById("producto-info");

      if (!codigoURL) {
        infoDiv.innerHTML =
          "<h2>Producto no encontrado</h2><p>Falta el código en la URL.</p>";
        return;
      }

      try {
        const resp = await fetch("productos.json");
        if (!resp.ok)
          throw new Error("No se pudo cargar productos.json: " + resp.status);

        const data = await resp.json();
        const productos = Array.isArray(data) ? data : data.productos || [];

        // Usa las claves de tu JSON
        const index = productos.findIndex((p) => p["Codigo"] === codigoURL);

        if (index === -1) {
          infoDiv.innerHTML =
            "<h2>Producto no encontrado</h2><p>Verificá el código.</p>";
          return;
        }

        const prod = productos[index];

        const codigo = prod["Codigo"] || "";
        const nombreCorto = prod["Nombre Corto"] || "";
        const categoria = prod["Categoria Princ"] || "";
        const descLarga = prod["Descripción Larga"] || "";
        const precioMayor = parsearPrecio(prod["Precio Mayorista"]);
        const precioCliente = parsearPrecio(prod["Precio Cliente"]);
        const precioUsado = precioMayor ?? precioCliente;
        const stock = prod["Stock"];

        /* ========== IMAGEN ========== */
        const imgPrincipal = document.getElementById("imagen-principal");
        if (imgPrincipal) {
          const urls = [
            `${BASE_IMG}/${codigo}.jpg`,
            `${BASE_IMG}/${codigo}.JPG`,
          ];
          let intento = 0;
          const probar = () => {
            if (intento >= urls.length) return;
            imgPrincipal.src = urls[intento];
            intento++;
          };
          imgPrincipal.alt = nombreCorto || codigo;
          imgPrincipal.loading = "lazy";
          imgPrincipal.onerror = probar;
          probar();
        }

        const miniaturasDiv = document.getElementById("miniaturas");
        if (miniaturasDiv) miniaturasDiv.innerHTML = "";

        /* ========== INFO ========== */
        const precioTexto =
          precioUsado != null
            ? `$ ${precioUsado.toLocaleString("es-AR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}`
            : "";

        const stockTexto =
          stock != null ? `Stock: ${stock} unidades` : "";

        infoDiv.innerHTML = `
          <p class="producto-codigo">${codigo}</p>
          <h1 class="producto-titulo">${nombreCorto}</h1>
          ${categoria ? `<p class="producto-categoria">${categoria}</p>` : ""}
          ${
            descLarga
              ? `<p class="producto-descripcion">${descLarga}</p>`
              : ""
          }
          ${precioTexto ? `<p class="producto-precio">${precioTexto}</p>` : ""}
          ${stockTexto ? `<p class="producto-stock">${stockTexto}</p>` : ""}
          <div class="producto-acciones">
            <a href="catalogo.html" class="btn-secundario">← Volver al catálogo</a>
            <a href="${armarLinkWhatsApp(prod)}" target="_blank" class="btn-whatsapp">
              Consultar por WhatsApp
            </a>
          </div>
        `;

        /* ========== NAVEGACIÓN ========== */
        const nav = document.getElementById("producto-nav");
        if (nav) {
          const anterior =
            productos[(index - 1 + productos.length) % productos.length];
          const siguiente = productos[(index + 1) % productos.length];

          const codAnt = anterior["Codigo"] || "";
          const codSig = siguiente["Codigo"] || "";

          nav.innerHTML = `
            <button class="btn-nav" onclick="irAProducto('${codAnt}')">← ${codAnt}</button>
            <button class="btn-nav" onclick="window.location.href='catalogo.html'">Volver al listado</button>
            <button class="btn-nav" onclick="irAProducto('${codSig}')">${codSig} →</button>
          `;
        }
      } catch (err) {
        console.error("Error en cargarProducto:", err);
        const infoDiv = document.getElementById("producto-info");
        infoDiv.innerHTML =
          "<h2>Error</h2><p>No se pudo cargar el producto.</p>";
      }
    }

    function armarLinkWhatsApp(prod) {
      const codigo = prod["Codigo"] || "";
      const nombreCorto = prod["Nombre Corto"] || "";
      const precioMayor = parsearPrecio(prod["Precio Mayorista"]);
      const precioTxt =
        precioMayor != null
          ? `$ ${precioMayor.toLocaleString("es-AR", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            })}`
          : "Consultar";

      const mensaje = [
        "Hola! Me interesa este producto:",
        "",
        `Código: ${codigo}`,
        `Producto: ${nombreCorto}`,
        `Precio mayorista: ${precioTxt}`,
        "",
        "¿Me pasás disponibilidad y cantidades mínimas?",
      ].join("\n");

      // Podés cambiar wa.me/?text= por wa.me/TUNUMERO?text= si querés número fijo
      return `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    }

    function irAProducto(codigo) {
      window.location.href = `producto.html?codigo=${encodeURIComponent(
        codigo
      )}`;
    }

    cargarProducto();
  </script>
</body>
</html>
