<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | Delivery Mayorista</title>
  <link rel="stylesheet" href="css/estilos.css" />

  <style>
    main.producto-pagina { padding: 40px 16px 60px; }

    main.producto-pagina .producto-wrapper {
      max-width: 1200px;
      margin: 0 auto 24px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 48px;

      opacity: 0;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
    }
    main.producto-pagina .producto-wrapper.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .producto-imagen { flex: 0 0 48%; }
    .producto-imagen img {
      width: 100%;
      height: auto;
      border-radius: 22px;
      object-fit: contain;
      background: #0a0a12;
      display: block;
    }

    .producto-info { flex: 0 0 42%; }
    .producto-acciones {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      flex-wrap: wrap;
    }

    .btn-secundario, .btn-whatsapp {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      text-decoration: none;
      border: none;
    }

    .btn-secundario { background: #202432; color: #fff; }
    .btn-whatsapp { background: #1ebe57; color: #fff; font-weight: 600; }

    .producto-stock { margin-top: 6px; }
    .producto-stock.stock-sin { color: #ff4d4f; font-weight: 600; }
    .producto-stock.stock-bajo { color: #ffd666; font-weight: 600; }

    .producto-loading {
      max-width: 1200px;
      margin: 0 auto;
      opacity: 0.85;
    }

    @media (max-width: 900px) {
      main.producto-pagina { padding: 24px 12px 36px; }
      main.producto-pagina .producto-wrapper { flex-direction: column; gap: 20px; }
      .producto-imagen, .producto-info { flex: 1 1 auto; width: 100%; }
      .producto-acciones { flex-direction: column; width: 100%; }
      .producto-acciones a { width: 100%; text-align: center; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a href="index.html" class="logo-link">Delivery Mayorista</a>
      <a href="catalogo.html" class="topbar-link">Ver catálogo</a>
    </div>
  </header>

  <main class="producto-pagina contenedor">
    <div id="producto-loading" class="producto-loading">Cargando producto...</div>

    <div class="producto-wrapper">
      <div id="producto-imagen" class="producto-imagen">
        <img id="imagen-principal" src="" alt="producto" />
      </div>
      <div id="producto-info" class="producto-info"></div>
    </div>
  </main>

  <footer class="footer">Catálogo mayorista · Delivery Mayorista</footer>

  <!-- =========================
       LÓGICA FIRESTORE
  ========================== -->
  <script type="module">
    import { db } from "./js/firebase-init.js";
    import {
      collection,
      getDocs,
      getDoc,
      doc,
      query,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const BASE_IMG = "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

    const loadingEl = document.getElementById("producto-loading");
    const wrapper = document.querySelector(".producto-wrapper");
    const infoDiv = document.getElementById("producto-info");
    const imgPrincipal = document.getElementById("imagen-principal");

    function visible() {
      if (loadingEl) loadingEl.style.display = "none";
      if (wrapper) wrapper.classList.add("visible");
    }

    function parsearPrecio(valor) {
      if (typeof valor === "number") return valor;
      if (typeof valor === "string") {
        const limpio = valor.replace(/\./g, "").replace(",", ".");
        const num = Number(limpio);
        return isNaN(num) ? null : num;
      }
      return null;
    }

    function getCodigoURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("codigo");
    }

    function armarLinkWhatsApp(prod) {
      const codigo = prod.codigo || "";
      const nombre = prod.nombre || "";
      const precio = parsearPrecio(prod.precio);
      const precioTxt = (precio != null)
        ? `$ ${precio.toLocaleString("es-AR", { maximumFractionDigits: 0 })}`
        : "Consultar";

      const mensaje = [
        "Hola! Me interesa este producto:",
        "",
        `Código: ${codigo}`,
        `Producto: ${nombre}`,
        `Precio mayorista: ${precioTxt}`,
        "",
        "¿Me pasás disponibilidad y cantidades mínimas?"
      ].join("\n");

      return `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    }

    function setImagen(codigo, urlDirecta) {
      const urls = [
        urlDirecta,
        `${BASE_IMG}/${codigo}.jpg`,
        `${BASE_IMG}/${codigo}.JPG`,
        `${BASE_IMG}/${codigo}.png`,
        `${BASE_IMG}/${codigo}.PNG`,
      ].filter(Boolean);

      let i = 0;
      const next = () => {
        if (i >= urls.length) return;
        imgPrincipal.src = urls[i];
        i++;
      };

      imgPrincipal.loading = "lazy";
      imgPrincipal.decoding = "async";
      imgPrincipal.onerror = next;
      next();
    }

    function renderProducto(p) {
      const codigo = p.codigo || "";
      const nombre = p.nombre || "";
      const categoria = p.categoria || "";
      const subcategoria = p.subcategoria || "";
      const descripcion = p.descripcionLarga || p.descripcion || "";
      const precio = parsearPrecio(p.precio);
      const stock = (p.stock ?? "");
      const stockNum = Number(stock);

      setImagen(codigo, p.imagen || "");

      let stockCls = "producto-stock";
      if (!isNaN(stockNum)) {
        if (stockNum === 0) stockCls += " stock-sin";
        else if (stockNum > 0 && stockNum <= 5) stockCls += " stock-bajo";
      }

      const categoriaHtml = (categoria || subcategoria)
        ? `<p class="producto-categoria">${categoria}${(categoria && subcategoria) ? " · " : ""}${subcategoria}</p>`
        : "";

      const precioHtml = (precio != null)
        ? `<p class="producto-precio">$ ${precio.toLocaleString("es-AR", { maximumFractionDigits: 0 })}</p>`
        : "";

      const stockHtml = (stock !== "" && stock != null)
        ? `<p class="${stockCls}">Stock: ${stock} unidades</p>`
        : "";

      infoDiv.innerHTML = `
        <p class="producto-codigo">${codigo}</p>
        <h1 class="producto-titulo">${nombre}</h1>
        ${categoriaHtml}
        ${descripcion ? `<p class="producto-descripcion">${descripcion}</p>` : ""}
        ${precioHtml}
        ${stockHtml}
        <div class="producto-acciones">
          <a href="catalogo.html" class="btn-secundario">← Volver al catálogo</a>
          <a href="${armarLinkWhatsApp(p)}" target="_blank" class="btn-whatsapp" rel="noopener">
            Consultar por WhatsApp
          </a>
        </div>
      `;

      visible();
    }

    async function cargarDesdeFirestore(codigo) {
      // 1) buscar por campo "codigo"
      const ref = collection(db, "productos");
      const q = query(ref, where("codigo", "==", codigo), limit(1));
      const snap = await getDocs(q);

      if (!snap.empty) {
        const docSnap = snap.docs[0];
        return { id: docSnap.id, ...docSnap.data() };
      }

      // 2) fallback: buscar por doc.id (si usás el código como id)
      const docRef = doc(db, "productos", codigo);
      const one = await getDoc(docRef);
      if (one.exists()) {
        return { id: one.id, ...one.data() };
      }

      return null;
    }

    async function init() {
      const codigo = getCodigoURL();

      if (!codigo) {
        infoDiv.innerHTML = "<h2>Producto no encontrado</h2><p>Falta el código en la URL.</p>";
        visible();
        return;
      }

      try {
        const prod = await cargarDesdeFirestore(codigo);
        if (!prod) {
          infoDiv.innerHTML = `<h2>Producto no encontrado</h2><p>No existe el código <b>${codigo}</b> en Firestore.</p>`;
          visible();
          return;
        }

        // Aseguro codigo si no viene
        prod.codigo = prod.codigo || codigo;

        renderProducto(prod);
      } catch (e) {
        console.error("Error cargando producto:", e);
        infoDiv.innerHTML = "<h2>Error</h2><p>No se pudo cargar el producto. Revisá consola.</p>";
        visible();
      }
    }

    init();
  </script>
</body>
</html>
