<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Producto | Delivery Mayorista</title>
  <link rel="stylesheet" href="css/estilos.css">
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <a href="index.html" class="logo-link">Delivery Mayorista</a>
    <a href="catalogo.html" class="topbar-link">Ver cat√°logo</a>
  </div>
</header>

<main class="producto-page">
  <section class="producto-layout">
    <!-- Contenedores donde se inyecta el producto -->
    <div id="producto-imagen" class="producto-imagen"></div>
    <div id="producto-info" class="producto-info"></div>
  </section>

  <nav id="producto-nav" class="producto-nav"></nav>
</main>

<footer class="footer">
  Cat√°logo mayorista ¬∑ Delivery Mayorista
</footer>

<!-- üî• C√≥digo JS de la ficha directamente en la p√°gina -->
<script>
// Mismo repo de im√°genes que en el cat√°logo
const BASE_IMG = "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

async function cargarProducto() {
  try {
    const params = new URLSearchParams(window.location.search);
    const codigo = params.get("codigo");
    console.log("C√≥digo en URL:", codigo);

    const infoDiv = document.getElementById("producto-info");

    if (!codigo) {
      if (infoDiv) {
        infoDiv.innerHTML =
          "<h2>Producto no encontrado</h2><p>Falta el c√≥digo en la URL.</p>";
      }
      return;
    }

    // productos.json est√° en la ra√≠z del repo
    const resp = await fetch("productos.json");
    if (!resp.ok) {
      throw new Error("No se pudo cargar productos.json: " + resp.status);
    }

    const productos = await resp.json();
    console.log("Productos cargados:", productos.length);

    const index = productos.findIndex(p => p.codigo === codigo);
    console.log("√çndice encontrado:", index);

    if (index === -1) {
      if (infoDiv) {
        infoDiv.innerHTML =
          "<h2>Producto no encontrado</h2><p>Verific√° el c√≥digo.</p>";
      }
      return;
    }

    const prod = productos[index];

    // Imagen grande
    const imgContainer = document.getElementById("producto-imagen");
    if (imgContainer) {
      imgContainer.innerHTML = "";
      const img = document.createElement("img");
      img.src = `${BASE_IMG}/${prod.codigo}.JPG`;
      img.alt = prod.nombre_corto || prod.codigo;
      img.loading = "lazy";
      img.onerror = () => {
        img.src = `${BASE_IMG}/${prod.codigo}.jpg`;
      };
      imgContainer.appendChild(img);
    }

    // Info del producto
    if (infoDiv) {
      const precioFormateado = prod.precio
        ? `$ ${Number(prod.precio).toLocaleString("es-AR", {
            minimumFractionDigits: 2,
          })}`
        : "";

      infoDiv.innerHTML = `
        <p class="producto-codigo">${prod.codigo}</p>
        <h1 class="producto-titulo">${prod.nombre_corto}</h1>
        ${
          prod.categoria
            ? `<p class="producto-categoria">${prod.categoria}</p>`
            : ""
        }
        ${
          prod.descripcion_larga
            ? `<p class="producto-descripcion">${prod.descripcion_larga}</p>`
            : ""
        }
        ${
          precioFormateado
            ? `<p class="producto-precio">${precioFormateado}</p>`
            : ""
        }
        <div class="producto-acciones">
          <a href="catalogo.html" class="btn-secundario">‚Üê Volver al cat√°logo</a>
          <a href="${armarLinkWhatsApp(prod)}" target="_blank" class="btn-whatsapp">
            Consultar por WhatsApp
          </a>
        </div>
      `;
    }

    // Navegaci√≥n anterior / siguiente
    const nav = document.getElementById("producto-nav");
    if (nav) {
      const anterior = productos[(index - 1 + productos.length) % productos.length];
      const siguiente = productos[(index + 1) % productos.length];

      nav.innerHTML = `
        <button class="btn-nav" onclick="irAProducto('${anterior.codigo}')">
          ‚Üê ${anterior.codigo}
        </button>
        <button class="btn-nav" onclick="window.location.href='catalogo.html'">
          Volver al listado
        </button>
        <button class="btn-nav" onclick="irAProducto('${siguiente.codigo}')">
          ${siguiente.codigo} ‚Üí
        </button>
      `;
    }
  } catch (error) {
    console.error("Error en cargarProducto:", error);
    const infoDiv = document.getElementById("producto-info");
    if (infoDiv) {
      infoDiv.innerHTML = "<h2>Error</h2><p>No se pudo cargar el producto.</p>";
    }
  }
}

function armarLinkWhatsApp(prod) {
  const precio = prod.precio
    ? `$ ${Number(prod.precio).toLocaleString("es-AR", {
        minimumFractionDigits: 2,
      })}`
    : "‚Äî";

  const mensaje = [
    "Hola! Me interesa este producto:",
    "",
    `C√≥digo: ${prod.codigo}`,
    `Producto: ${prod.nombre_corto}`,
    `Precio mayorista: ${precio}`,
    "",
    "¬øMe pas√°s disponibilidad y cantidades m√≠nimas?"
  ].join("\n");

  return `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
}

function irAProducto(codigo) {
  window.location.href = `producto.html?codigo=${encodeURIComponent(codigo)}`;
}

cargarProducto();
</script>

</body>
</html>
