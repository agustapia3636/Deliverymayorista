<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | Delivery Mayorista</title>
  <link rel="stylesheet" href="css/estilos.css" />

  <style>
    :root{
      --bg: #0f0f1a;
      --card: #0c0c17;
      --card2: #0a0a12;
      --txt: #ffffff;
      --muted: rgba(255,255,255,.75);
      --accent: #ffa400;
      --btn: #202432;
      --shadow: rgba(0,0,0,.55);
    }

    body{ background: var(--bg); }

    main.producto-pagina { padding: 28px 16px 60px; min-height: 70vh; }

    .producto-wrapper{
      max-width:1200px;
      margin: 0 auto;
      display:flex;
      gap: 42px;
      align-items:flex-start;

      opacity:0;
      transform:translateY(10px);
      transition:opacity .25s ease,transform .25s ease;
    }
    .producto-wrapper.visible{ opacity:1; transform:translateY(0); }

    .producto-imagen{
      flex: 0 0 52%;
      background: radial-gradient(900px 520px at 50% 0%, rgba(255,164,0,.06), transparent 60%),
                  var(--card);
      border-radius: 24px;
      padding: 18px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 18px 40px rgba(0,0,0,0.35);
    }
    .producto-imagen img{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background: var(--card2);
      object-fit: contain;
      display:block;
    }

    .producto-info{
      flex: 0 0 42%;
      background: radial-gradient(900px 520px at 50% -120px, rgba(255,0,93,.05), transparent 60%),
                  var(--card);
      border-radius: 24px;
      padding: 18px 18px 20px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 18px 40px rgba(0,0,0,0.35);
    }

    .producto-codigo{ opacity:.8; margin:0 0 6px; color: var(--muted); }
    .producto-titulo{ margin:0 0 10px; font-size:34px; line-height:1.08; letter-spacing: .2px; }
    .producto-categoria{ opacity:.9; margin:0 0 12px; color: #c9c9ff; font-weight: 600; }
    .producto-descripcion{ opacity:.95; margin:0 0 14px; color: rgba(255,255,255,.88); line-height: 1.35; }
    .producto-precio{ font-size:30px; font-weight:900; margin:12px 0 10px; color: var(--accent); }

    .producto-stock{ margin:0; opacity:.95; color: rgba(255,255,255,.85); }
    .producto-stock.stock-sin{ color:#ff4d4f; font-weight:800; }
    .producto-stock.stock-bajo{ color:#ffd666; font-weight:800; }

    .producto-acciones{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:16px;
    }

    .btn-secundario,.btn-whatsapp,.btn-nav,.btn-agregar{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 18px;
      border-radius: 12px;
      border:none;
      cursor:pointer;
      font-size: 15px;
      text-decoration:none;
      background: var(--btn);
      color:#fff;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      transition: transform .08s ease, filter .08s ease;
      white-space: nowrap;
      user-select: none;
    }
    .btn-secundario:hover,.btn-nav:hover,.btn-agregar:hover{ filter: brightness(1.06); transform: translateY(-1px); }

    .btn-whatsapp{
      background:#1ebe57;
      font-weight:900;
    }
    .btn-whatsapp:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    .btn-agregar{
      font-weight: 900;
      gap: 8px;
    }
    .btn-agregar:disabled{
      opacity: .55;
      cursor: not-allowed;
      transform: none;
      filter: none;
    }

    .producto-nav{
      max-width:1200px;
      margin: 18px auto 0;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    #producto-loading{
      max-width:1200px;
      margin: 0 auto 14px;
      display:none;
      opacity:.85;
      color:#c9c9ff;
    }

    /* Qty */
    .qty-row{
      margin-top: 14px;
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .qty-control{
      display:flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .qty-btn{
      width: 34px; height: 34px;
      border-radius: 999px;
      border:none;
      cursor:pointer;
      background: var(--btn);
      color:#fff;
      font-size: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.2);
      transition: transform .08s ease, filter .08s ease;
    }
    .qty-btn:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .qty-input{
      width: 70px;
      text-align:center;
      border-radius: 999px;
      border:none;
      padding: 8px 10px;
      font-size: 15px;
      outline:none;
      background: #fff;
      color:#000;
    }

    /* mobile */
    @media (max-width: 900px){
      main.producto-pagina{ padding:18px 12px 42px; }
      .producto-wrapper{ flex-direction:column; gap:16px; }
      .producto-imagen,.producto-info{ width:100%; flex:1 1 auto; }
      .producto-acciones a,.producto-acciones button{ width:100%; }
      .producto-titulo{ font-size:28px; }
    }

    .topbar-link {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.15);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .topbar-link:hover {
      background: rgba(255,255,255,0.28);
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <span class="logo-link">Delivery Mayorista</span>
      <a id="linkCatalogo" href="catalogo.html" class="topbar-link">Ver cat√°logo</a>
    </div>
  </header>

  <main class="producto-pagina contenedor">
    <div id="producto-loading">Cargando producto...</div>

    <div class="producto-wrapper">
      <div class="producto-imagen">
        <img id="imagen-principal" src="" alt="Producto" />
      </div>

      <div id="producto-info" class="producto-info"></div>
    </div>

    <div id="producto-nav" class="producto-nav"></div>
  </main>

  <footer class="footer">Cat√°logo mayorista ¬∑ Delivery Mayorista</footer>

  <script type="module">
    import { db } from "./js/firebase-init.js";
    import { collection, getDocs, getDoc, doc, query, where, limit }
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ====== CONFIG ======
    const COL_PRODUCTOS = "productos";
    const BASE_IMG = "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

    // ‚úÖ mismo cache que tu catalogo.html (el que armamos)
    const CLAVE_CACHE_CATALOGO = "dm_catalogo_cache_v2";
    const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6h
    const CACHE_IMG_NAME = "dm_img_cache_v1";

    // ‚úÖ misma key de carrito que tu cat√°logo
    const CART_KEY = "carrito_dm_v1";

    // ====== BACK / VOLVER (con filtros) ======
    const linkCatalogo = document.getElementById("linkCatalogo");

    function getParam(name){
      return new URLSearchParams(location.search).get(name);
    }

    function sanitizeBackUrl(raw){
      if (!raw) return null;
      let v = String(raw).trim();
      if (!v) return null;

      try { v = decodeURIComponent(v); } catch {}

      const low = v.toLowerCase();
      if (low.startsWith("javascript:")) return null;
      if (low.includes("://")) return null;
      if (low.startsWith("//")) return null;

      const ok =
        low.startsWith("catalogo.html") ||
        low.startsWith("./catalogo.html") ||
        low.startsWith("/catalogo.html");

      if (!ok) return null;
      return v;
    }

    const backRaw = getParam("back") || getParam("backUrl");
    const backSafe = sanitizeBackUrl(backRaw);
    const CATALOGO_FALLBACK = "catalogo.html";
    const CATALOGO_TARGET = backSafe || CATALOGO_FALLBACK;

    if (linkCatalogo) linkCatalogo.href = CATALOGO_TARGET;

    function volverAlCatalogo(){
      if (backSafe) { location.href = backSafe; return; }
      const ref = document.referrer || "";
      if (ref.includes("catalogo.html")) { history.back(); return; }
      location.href = CATALOGO_FALLBACK;
    }
    window.__dm_back = volverAlCatalogo;

    function buildProductoUrl(codigo){
      const base = `producto.html?codigo=${encodeURIComponent(codigo)}`;
      return backSafe ? `${base}&back=${encodeURIComponent(backSafe)}` : base;
    }

    // cache por producto
    const cacheProdKey = (codigo) => `cache_producto_${String(codigo || "").trim()}_v1`;

    // ====== DOM ======
    const loadingEl = document.getElementById("producto-loading");
    const wrapper   = document.querySelector(".producto-wrapper");
    const infoDiv   = document.getElementById("producto-info");
    const imgEl     = document.getElementById("imagen-principal");
    const navEl     = document.getElementById("producto-nav");

    // ====== Loader solo si tarda ======
    if (loadingEl) loadingEl.style.display = "none";
    let tLoading = setTimeout(() => {
      if (loadingEl) loadingEl.style.display = "block";
    }, 300);

    function visible() {
      clearTimeout(tLoading);
      if (loadingEl) loadingEl.style.display = "none";
      if (wrapper) wrapper.classList.add("visible");
    }

    // ====== Helpers ======
    function getCodigoURL() {
      return new URLSearchParams(location.search).get("codigo");
    }

    function parsearPrecio(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string") {
        const limpio = v.replace(/\./g, "").replace(",", ".");
        const n = Number(limpio);
        return Number.isFinite(n) ? n : null;
      }
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizarProducto(raw, codigoFallback) {
      const p = raw || {};
      const codigo = p.codigo ?? p.Codigo ?? codigoFallback ?? p.id ?? "";
      const nombre = p.nombre ?? p.Nombre ?? "";
      const categoria = p.categoria ?? p.Categoria_Princ ?? "";
      const subcategoria = p.subcategoria ?? p.Sub_Categoria ?? "";
      const descripcion = p.descripcionLarga ?? p.descripcion ?? p.Descripcion ?? "";
      const precio = parsearPrecio(p.precio ?? p.PrecioMayorista);
      const stock = Number(p.stock ?? p.Stock ?? 0);
      const imagen = p.imagen ?? p.Imagen ?? "";
      return { ...p, codigo: String(codigo), nombre, categoria, subcategoria, descripcion, precio, stock, imagen };
    }

    function formatoARS(n) {
      if (n == null || !Number.isFinite(n)) return "";
      return n.toLocaleString("es-AR", { maximumFractionDigits: 0 });
    }

    // ====== Carrito helpers (sincronizaci√≥n stock) ======
    function leerCarrito(){
      try {
        const raw = localStorage.getItem(CART_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function guardarCarrito(arr){
      try { localStorage.setItem(CART_KEY, JSON.stringify(arr)); } catch {}
      // evento (sirve dentro de esta p√°gina; el cat√°logo recalcula al volver con pageshow/focus)
      window.dispatchEvent(new CustomEvent("dm-carrito-update", { detail: arr }));
    }

    function carritoAgregar(p, cantidad){
      const qty = Math.max(1, Math.floor(Number(cantidad) || 1));
      const cart = leerCarrito();
      const idx = cart.findIndex(x => String(x.codigo) === String(p.codigo));
      if (idx >= 0) cart[idx].cantidad = (Number(cart[idx].cantidad) || 0) + qty;
      else cart.push({
        codigo: p.codigo,
        nombre: p.nombre,
        precio: p.precio ?? null,
        stock: p.stock ?? 0,
        imagen: p.imagen ?? "",
        cantidad: qty
      });
      guardarCarrito(cart);
    }

    function cantidadEnCarrito(codigo){
      const cart = leerCarrito();
      const it = cart.find(x => String(x.codigo) === String(codigo));
      return it ? (Number(it.cantidad) || 0) : 0;
    }

    // ====== Cache producto ======
    function cacheProductoLeer(codigo) {
      try {
        const raw = localStorage.getItem(cacheProdKey(codigo));
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ts || !obj.data) return null;
        if ((Date.now() - obj.ts) > CACHE_TTL_MS) return null;
        return obj.data;
      } catch { return null; }
    }

    function cacheProductoGuardar(codigo, data) {
      try { localStorage.setItem(cacheProdKey(codigo), JSON.stringify({ ts: Date.now(), data })); } catch {}
    }

    // ====== Im√°genes ======
    async function warmCacheImage(url) {
      try {
        if (!("caches" in window)) return;
        const cache = await caches.open(CACHE_IMG_NAME);
        const hit = await cache.match(url, { ignoreSearch: true });
        if (hit) return;
        await cache.add(url);
      } catch {}
    }

    function candidatosImagen(p) {
      const codigo = p.codigo || "";
      const urlDirecta = p.imagen || "";
      const c = [
        urlDirecta,
        `${BASE_IMG}/${codigo}.jpg`,
        `${BASE_IMG}/${codigo}.JPG`,
        `${BASE_IMG}/${codigo}.jpeg`,
        `${BASE_IMG}/${codigo}.JPEG`,
        `${BASE_IMG}/${codigo}.png`,
        `${BASE_IMG}/${codigo}.PNG`,
        `${BASE_IMG}/${codigo}.webp`,
        `${BASE_IMG}/${codigo}.WEBP`,
      ].filter(Boolean);
      return [...new Set(c)];
    }

    async function setImagenProducto(p) {
      const cands = candidatosImagen(p);

      imgEl.loading = "eager";
      imgEl.decoding = "async";
      imgEl.referrerPolicy = "no-referrer";

      if (cands[0]) warmCacheImage(cands[0]);

      let i = 0;
      const probar = () => {
        if (i >= cands.length) return;
        imgEl.src = cands[i];
        i++;
      };

      imgEl.onerror = probar;
      imgEl.onload = () => warmCacheImage(imgEl.src);

      // precarga liviana
      for (const u of cands.slice(0, 3)) {
        const im = new Image();
        im.decoding = "async";
        im.referrerPolicy = "no-referrer";
        im.onload = () => warmCacheImage(u);
        im.src = u;
      }

      probar();
    }

    function armarWhatsApp(p) {
      const precioTxt = (p.precio != null)
        ? `$ ${formatoARS(p.precio)}`
        : "Consultar";

      const msg = [
        "Hola! Me interesa este producto:",
        "",
        `C√≥digo: ${p.codigo}`,
        `Producto: ${p.nombre}`,
        `Precio mayorista: ${precioTxt}`,
        "",
        "¬øMe pas√°s disponibilidad y cantidades m√≠nimas?"
      ].join("\n");

      return `https://wa.me/?text=${encodeURIComponent(msg)}`;
    }

    // ====== Nav anterior/siguiente (desde cache del cat√°logo) ======
    function renderNav(codigoActual) {
      if (!navEl) return;

      let catalogo = null;
      try {
        const raw = localStorage.getItem(CLAVE_CACHE_CATALOGO);
        if (raw) {
          const obj = JSON.parse(raw);
          if (Array.isArray(obj?.data)) catalogo = obj.data;
        }
      } catch {}

      if (!catalogo || !catalogo.length) {
        navEl.innerHTML = `<button class="btn-nav" type="button" onclick="window.__dm_back()">Volver al listado</button>`;
        return;
      }

      const catNorm = catalogo
        .map(x => (x && typeof x === "object") ? x : {})
        .map(x => ({ ...x, codigo: String(x.codigo ?? x.Codigo ?? x.id ?? "") }));

      const idx = catNorm.findIndex(x => String(x.codigo) === String(codigoActual));
      if (idx === -1) {
        navEl.innerHTML = `<button class="btn-nav" type="button" onclick="window.__dm_back()">Volver al listado</button>`;
        return;
      }

      const ant = catNorm[(idx - 1 + catNorm.length) % catNorm.length]?.codigo || "";
      const sig = catNorm[(idx + 1) % catNorm.length]?.codigo || "";

      window.__dm_ir = (c) => location.href = buildProductoUrl(c);

      navEl.innerHTML = `
        <button class="btn-nav" type="button" onclick="window.__dm_ir('${ant}')">‚Üê ${ant}</button>
        <button class="btn-nav" type="button" onclick="window.__dm_back()">Volver al listado</button>
        <button class="btn-nav" type="button" onclick="window.__dm_ir('${sig}')">${sig} ‚Üí</button>
      `;
    }

    // ====== Render producto (sincronizado stock con carrito) ======
    let productoActual = null;

    function calcularDisponible(p){
      const enCart = cantidadEnCarrito(p.codigo);
      const disp = Math.max(0, (Number(p.stock) || 0) - enCart);
      return { enCart, disp };
    }

    function renderProducto(raw, codigoFallback) {
      const p = normalizarProducto(raw, codigoFallback);
      productoActual = p;

      setImagenProducto(p);
      renderNav(p.codigo);

      const { enCart, disp } = calcularDisponible(p);

      let stockCls = "producto-stock";
      if (disp <= 0) stockCls += " stock-sin";
      else if (disp <= 5) stockCls += " stock-bajo";

      const categoriaHtml = (p.categoria || p.subcategoria)
        ? `<p class="producto-categoria">${escapeHtml(p.categoria || "")}${(p.categoria && p.subcategoria) ? " ¬∑ " : ""}${escapeHtml(p.subcategoria || "")}</p>`
        : "";

      const precioHtml = (p.precio != null)
        ? `<p class="producto-precio">$ ${formatoARS(p.precio)}</p>`
        : "";

      const descHtml = p.descripcion
        ? `<p class="producto-descripcion">${escapeHtml(p.descripcion)}</p>`
        : "";

      infoDiv.innerHTML = `
        <p class="producto-codigo">${escapeHtml(p.codigo)}</p>
        <h1 class="producto-titulo">${escapeHtml(p.nombre || "Producto")}</h1>
        ${categoriaHtml}
        ${descHtml}
        ${precioHtml}

        <p id="stockLine" class="${stockCls}">
          Stock: <b>${disp}</b> u
          <span style="opacity:.7; font-weight:600;">(en carrito: ${enCart})</span>
        </p>

        <div class="qty-row">
          <div class="qty-control">
            <button id="btnMenos" class="qty-btn" type="button">‚àí</button>
            <input id="qtyInput" class="qty-input" type="number" min="1" value="1" />
            <button id="btnMas" class="qty-btn" type="button">+</button>
          </div>

          <button id="btnAgregar" class="btn-agregar" type="button">
            üõí Agregar
          </button>
        </div>

        <div class="producto-acciones">
          <button class="btn-secundario" type="button" onclick="window.__dm_back()">‚Üê Volver</button>
          <a class="btn-whatsapp" href="${armarWhatsApp(p)}" target="_blank" rel="noopener">
            Consultar por WhatsApp
          </a>
        </div>
      `;

      // Handlers qty + add
      const btnMenos = document.getElementById("btnMenos");
      const btnMas = document.getElementById("btnMas");
      const qtyInput = document.getElementById("qtyInput");
      const btnAgregar = document.getElementById("btnAgregar");

      function clampQty(v){
        const n = Math.max(1, Math.floor(Number(v) || 1));
        return n;
      }

      function actualizarStockUI(){
        if (!productoActual) return;
        const { enCart, disp } = calcularDisponible(productoActual);

        const stockLine = document.getElementById("stockLine");
        if (stockLine){
          let cls = "producto-stock";
          if (disp <= 0) cls += " stock-sin";
          else if (disp <= 5) cls += " stock-bajo";
          stockLine.className = cls;
          stockLine.innerHTML = `Stock: <b>${disp}</b> u <span style="opacity:.7; font-weight:600;">(en carrito: ${enCart})</span>`;
        }

        const q = clampQty(qtyInput?.value);
        if (qtyInput) qtyInput.value = String(q);

        if (btnAgregar){
          if (disp <= 0){
            btnAgregar.disabled = true;
            btnAgregar.textContent = "Sin stock";
          } else {
            btnAgregar.disabled = false;
            btnAgregar.textContent = "üõí Agregar";
          }
        }

        // si la qty es mayor que disponible, la ajustamos (UX pro)
        if (qtyInput && disp > 0){
          const q2 = Math.min(clampQty(qtyInput.value), disp);
          qtyInput.value = String(q2);
        }
      }

      btnMenos?.addEventListener("click", () => {
        const v = clampQty(qtyInput.value) - 1;
        qtyInput.value = String(Math.max(1, v));
      });
      btnMas?.addEventListener("click", () => {
        const { disp } = calcularDisponible(productoActual);
        const v = clampQty(qtyInput.value) + 1;
        if (disp > 0) qtyInput.value = String(Math.min(v, disp));
        else qtyInput.value = "1";
      });

      qtyInput?.addEventListener("input", () => {
        actualizarStockUI();
      });

      btnAgregar?.addEventListener("click", () => {
        if (!productoActual) return;
        actualizarStockUI();
        const { disp } = calcularDisponible(productoActual);
        if (disp <= 0) return;

        const qty = clampQty(qtyInput.value);
        const qtyReal = Math.min(qty, disp);

        carritoAgregar(productoActual, qtyReal);
        // feedback r√°pido
        btnAgregar.classList.add("btn-agregar-carrito-activo");
        btnAgregar.textContent = "‚úÖ Agregado";
        setTimeout(() => {
          btnAgregar.classList.remove("btn-agregar-carrito-activo");
          actualizarStockUI();
        }, 650);

        actualizarStockUI();
      });

      // si cambia el carrito en esta misma p√°gina
      window.addEventListener("dm-carrito-update", actualizarStockUI);

      // y al volver desde otra p√°gina/cach√©
      window.addEventListener("pageshow", actualizarStockUI);
      window.addEventListener("focus", actualizarStockUI);

      actualizarStockUI();
      visible();
    }

    // ====== Firestore ======
    async function cargarDesdeFirestore(codigo) {
      const ref = collection(db, COL_PRODUCTOS);
      const q = query(ref, where("codigo", "==", codigo), limit(1));
      const snap = await getDocs(q);

      if (!snap.empty) {
        const d = snap.docs[0];
        return { id: d.id, ...d.data() };
      }

      const docRef = doc(db, COL_PRODUCTOS, codigo);
      const one = await getDoc(docRef);
      if (one.exists()) return { id: one.id, ...one.data() };

      return null;
    }

    // ====== Init ======
    async function init() {
      const codigo = getCodigoURL();

      if (!codigo) {
        infoDiv.innerHTML = "<h2>Producto no encontrado</h2><p>Falta el c√≥digo en la URL.</p>";
        visible();
        return;
      }

      renderNav(codigo);

      const cached = cacheProductoLeer(codigo);
      if (cached) {
        renderProducto(cached, codigo);

        cargarDesdeFirestore(codigo)
          .then(prod => {
            if (prod) {
              cacheProductoGuardar(codigo, prod);
              renderProducto(prod, codigo);
            }
          })
          .catch(() => {});
        return;
      }

      try {
        const prod = await cargarDesdeFirestore(codigo);

        if (!prod) {
          infoDiv.innerHTML = `
            <h2>Producto no encontrado</h2>
            <p>No existe el c√≥digo <b>${escapeHtml(codigo)}</b> en Firestore.</p>
            <div class="producto-acciones">
              <button class="btn-secundario" type="button" onclick="window.__dm_back()">‚Üê Volver</button>
              <a class="btn-secundario" href="${CATALOGO_TARGET}">Ver cat√°logo</a>
            </div>
          `;
          visible();
          return;
        }

        cacheProductoGuardar(codigo, prod);
        renderProducto(prod, codigo);
      } catch (e) {
        console.error("Error producto:", e);
        infoDiv.innerHTML = `
          <h2>Error cargando producto</h2>
          <p>No se pudo obtener el producto desde Firestore.</p>
          <div class="producto-acciones">
            <button class="btn-secundario" type="button" onclick="window.__dm_back()">‚Üê Volver</button>
            <a class="btn-secundario" href="${CATALOGO_TARGET}">Ver cat√°logo</a>
          </div>
        `;
        visible();
      }
    }

    init();
  </script>
</body>
</html>
