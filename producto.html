<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Producto | Delivery Mayorista</title>
  <link rel="stylesheet" href="css/estilos.css">
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <a href="index.html" class="logo-link">Delivery Mayorista</a>
      <a href="catalogo.html" class="topbar-link">Ver cat√°logo</a>
    </div>
  </header>

  <!-- P√ÅGINA DE PRODUCTO -->
  <main class="producto-pagina contenedor">

    <div class="producto-wrapper">

      <!-- Imagen / Galer√≠a -->
      <div id="producto-imagen" class="producto-imagen">
        <img id="imagen-principal" src="" alt="producto" />
        <div id="miniaturas" class="miniaturas"></div>
      </div>

      <!-- Info del producto (se completa por JS) -->
      <div id="producto-info" class="producto-info"></div>

    </div>

    <!-- Navegaci√≥n anterior / siguiente (se completa por JS) -->
    <div id="producto-nav" class="producto-nav"></div>

  </main>

  <!-- FOOTER -->
  <footer class="footer">
    Cat√°logo mayorista ¬∑ Delivery Mayorista
  </footer>

  <!-- üî• L√ìGICA DE LA FICHA DE PRODUCTO -->
  <script>
  // Mismo repo de im√°genes que en el cat√°logo
  const BASE_IMG = "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

  // Convierte "2276,8" -> n√∫mero 2276.8
  function parsearPrecio(valor) {
    if (typeof valor === "number") return valor;
    if (typeof valor === "string") {
      const limpio = valor.replace(/\./g, "").replace(",", ".");
      const num = Number(limpio);
      return isNaN(num) ? null : num;
    }
    return null;
  }

  function obtenerCodigoDeURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("codigo");
  }

  async function cargarProducto() {
    const codigoURL = obtenerCodigoDeURL();
    const infoDiv = document.getElementById("producto-info");

    if (!codigoURL) {
      if (infoDiv) {
        infoDiv.innerHTML = "<h2>Producto no encontrado</h2><p>Falta el c√≥digo en la URL.</p>";
      }
      return;
    }

    try {
      const resp = await fetch("productos.json");
      if (!resp.ok) {
        throw new Error("No se pudo cargar productos.json: " + resp.status);
      }

      const data = await resp.json();
      const productos = Array.isArray(data) ? data : (data.productos || []);

      // ATENCI√ìN: en tu JSON la clave es "Codigo"
      const index = productos.findIndex(p => p["Codigo"] === codigoURL);

      if (index === -1) {
        if (infoDiv) {
          infoDiv.innerHTML = "<h2>Producto no encontrado</h2><p>Verific√° el c√≥digo.</p>";
        }
        return;
      }

      const prod = productos[index];

      const codigo       = prod["Codigo"] || "";
      const nombreCorto  = prod["Nombre Corto"] || "";
      const categoria    = prod["Categoria Princ"] || "";
      const descLarga    = prod["Descripci√≥n Larga"] || "";
      const precioMayor  = parsearPrecio(prod["Precio Mayorista"]);
      const precioCliente= parsearPrecio(prod["Precio Cliente"]);
      const precioUsado  = precioMayor ?? precioCliente;
      const stock        = prod["Stock"];

      // ==========================
      //   IMAGEN PRINCIPAL
      // ==========================
      const imgPrincipal = document.getElementById("imagen-principal");
      if (imgPrincipal) {
        const urls = [
          `${BASE_IMG}/${codigo}.jpg`,
          `${BASE_IMG}/${codigo}.JPG`
        ];
        let intento = 0;

        const probar = () => {
          if (intento >= urls.length) return;
          imgPrincipal.src = urls[intento];
          intento++;
        };

        imgPrincipal.alt = nombreCorto || codigo;
        imgPrincipal.loading = "lazy";
        imgPrincipal.onerror = probar;

        probar();
      }

      // Miniaturas (por ahora vac√≠o, pero listo para futuro)
      const miniaturasDiv = document.getElementById("miniaturas");
      if (miniaturasDiv) {
        miniaturasDiv.innerHTML = "";
      }

      // ==========================
      //   INFO DEL PRODUCTO
      // ==========================
      if (infoDiv) {
        const precioTexto = precioUsado != null
          ? `$ ${precioUsado.toLocaleString("es-AR", { minimumFractionDigits: 0 })}`
          : "";

        const stockTexto = stock != null
          ? `Stock: ${stock} unidades`
          : "";

        infoDiv.innerHTML = `
          <p class="producto-codigo">${codigo}</p>
          <h1 class="producto-titulo">${nombreCorto}</h1>
          ${categoria ? `<p class="producto-categoria">${categoria}</p>` : ""}
          ${descLarga ? `<p class="producto-descripcion">${descLarga}</p>` : ""}
          ${precioTexto ? `<p class="producto-precio">${precioTexto}</p>` : ""}
          ${stockTexto ? `<p class="producto-stock">${stockTexto}</p>` : ""}
          <div class="producto-acciones">
            <a href="catalogo.html" class="btn-secundario">‚Üê Volver al cat√°logo</a>
            <a href="${armarLinkWhatsApp(prod)}" target="_blank" class="btn-whatsapp">
              Consultar por WhatsApp
            </a>
          </div>
        `;
      }

      // ==========================
      //   NAVEGACI√ìN ANTERIOR / SIGUIENTE
      // ==========================
      const nav = document.getElementById("producto-nav");
      if (nav) {
        const anterior = productos[(index - 1 + productos.length) % productos.length];
        const siguiente = productos[(index + 1) % productos.length];

        const codAnt = anterior["Codigo"] || "";
        const codSig = siguiente["Codigo"] || "";

        nav.innerHTML = `
          <button class="btn-nav" onclick="irAProducto('${codAnt}')">
            ‚Üê ${codAnt}
          </button>
          <button class="btn-nav" onclick="window.location.href='catalogo.html'">
            Volver al listado
          </button>
          <button class="btn-nav" onclick="irAProducto('${codSig}')">
            ${codSig} ‚Üí
          </button>
        `;
      }

    } catch (error) {
      console.error("Error en cargarProducto:", error);
      if (infoDiv) {
        infoDiv.innerHTML = "<h2>Error</h2><p>No se pudo cargar el producto.</p>";
      }
    }
  }

  // Arma el link de WhatsApp con datos del producto (usando claves de tu JSON)
  function armarLinkWhatsApp(prod) {
    const codigo      = prod["Codigo"] || "";
    const nombreCorto = prod["Nombre Corto"] || "";
    const precioMayor = parsearPrecio(prod["Precio Mayorista"]);
    const precioTxt   = precioMayor != null
      ? `$ ${precioMayor.toLocaleString("es-AR", { minimumFractionDigits: 0 })}`
      : "Consultar";

    const mensaje = [
      "Hola! Me interesa este producto:",
      "",
      `C√≥digo: ${codigo}`,
      `Producto: ${nombreCorto}`,
      `Precio mayorista: ${precioTxt}`,
      "",
      "¬øMe pas√°s disponibilidad y cantidades m√≠nimas?"
    ].join("\n");

    // Si despu√©s quer√©s tu n√∫mero fijo, cambi√°s esta URL a: https://wa.me/TUNUMERO?text=...
    return `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
  }

  // Cambia de producto desde los botones de navegaci√≥n
  function irAProducto(codigo) {
    window.location.href = `producto.html?codigo=${encodeURIComponent(codigo)}`;
  }

  // Dispara la carga al entrar a la p√°gina
  cargarProducto();
  </script>

</body>
</html>
