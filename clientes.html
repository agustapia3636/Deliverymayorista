<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto de Venta | Delivery Mayorista</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg-body: #f8fafc; --bg-card: #ffffff;
      --primary: #ff005d; --primary2: #ffa400; --secondary: #64748b;
      --success: #10b981; --mixed: #8b5cf6; --danger: #ef4444;
      --text-main: #1e293b; --border: #cbd5e1;
    }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    header { background: linear-gradient(90deg,var(--primary),var(--primary2)); color:#fff; padding: 10px 20px; box-shadow: 0 8px 20px rgba(2,6,23,.12); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,.18); flex-shrink: 0; z-index: 10; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    header h1 { margin: 0; font-size: 1.1rem; font-weight: 900; display: flex; align-items: center; gap: 10px; letter-spacing: .2px; }

    .search-box { background: rgba(255,255,255,0.16); border: 1px solid rgba(255,255,255,0.28); padding: 8px 12px; border-radius: 12px; width: min(520px, 46vw); display: flex; align-items: center; transition: all 0.2s; color:#fff; }
    .search-box:focus-within { background: rgba(255,255,255,0.22); border-color: rgba(255,255,255,0.45); box-shadow: 0 0 0 4px rgba(255,0,93,0.18); }
    .search-box input { border: none; background: transparent; outline: none; width: 100%; font-size: 0.95rem; margin-left: 8px; color:#fff; }
    .search-box input::placeholder{color:rgba(255,255,255,0.85)}

    .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap:wrap; }
    .btn-header { background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.28); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; transition: 0.2s; }
    .btn-header:hover { background: rgba(255,255,255,0.28); }
    .btn-historial { background: rgba(255,255,255,0.22); color: #fff; }
    .btn-historial:hover { background: rgba(255,255,255,0.30); }
    .date-display { font-size: 0.85rem; color: rgba(255,255,255,0.95); font-weight: 800; background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.28); padding: 6px 12px; border-radius: 999px; }

    /* ‚úÖ Cajero / Turno */
    .caja-pill {
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.28);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      color:#fff;
    }
    .caja-pill input{
      width: 140px;
      border:none; outline:none;
      background: rgba(255,255,255,0.16);
      color:#fff;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
    }
    .caja-pill input::placeholder{ color: rgba(255,255,255,0.85); }
    .caja-pill .turno-tag{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.24);
      font-weight: 900;
      white-space: nowrap;
    }

    .main-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; width:100%; }
    .left-column { flex: 1; display: flex; flex-direction: column; min-width: 320px; overflow: hidden; transition: all 0.3s ease; }
    .right-column { width: clamp(360px, 28vw, 520px); min-width: 320px; display: flex; flex-direction: column; overflow: hidden; background: white; border-left: 1px solid var(--border); transition: all 0.3s ease; }
    .panel-top { flex: 1; overflow: hidden; padding: 18px; display: flex; flex-direction: column; }
    .panel-bottom { height: 260px; min-height: 120px; overflow: hidden; display: flex; flex-direction: column; background: white; border-top: 1px solid var(--border); transition: height 0.3s ease; }

    .fullscreen-mode .panel-bottom { display: none !important; }
    .fullscreen-mode .resizer-horiz { display: none !important; }

    .resizer-vert-main { width: 8px; background: transparent; cursor: ew-resize; flex-shrink: 0; display: flex; align-items: center; justify-content: center; z-index: 5; margin-left: -4px; }
    .resizer-horiz { height: 8px; background: transparent; cursor: ns-resize; display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 5; margin-top: -4px; }

    .catalog-container { flex: 1; overflow-y: auto; padding-right: 6px; }
    .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; padding-bottom: 20px; }

    .card { background: white; border-radius: 18px; padding: 12px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; height: 100%; align-items: center; text-align: center; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-3px); border-color: rgba(255,0,93,0.65); box-shadow: 0 10px 22px rgba(2,6,23,.10); }
    .card-img { width: 100%; height: 110px; object-fit: contain; background: #fff; margin-bottom: 8px; flex-shrink: 0; }
    .card h3 { font-size: 0.9rem; margin: 0 0 6px; line-height: 1.25; font-weight: 700; color: #0f172a; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; max-height: 3.75em; }
    .price { font-weight: 1000; color: #0f172a; font-size: 1.05rem; margin-top: auto; }
    .stock-badge { font-size: 0.70rem; padding: 3px 8px; border-radius: 999px; margin-bottom: 6px; font-weight: 900; text-transform: uppercase; border:1px solid rgba(2,6,23,.08); }
    .stock-critico { background: #fee2e2; color: #dc2626; }
    .stock-bajo { background: #ffedd5; color: #c2410c; }
    .stock-ok { background: #ecfdf5; color: #047857; }

    .cart-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .cart-header { padding: 12px 15px; font-weight: 900; background: #f8fafc; border-bottom: 1px solid var(--border); font-size: 0.95rem; }

    .cart-header-flex { display:flex; justify-content: space-between; align-items:center; gap:10px; }
    .cliente-inline { display:flex; gap:8px; align-items:center; }
    .cliente-inline input{
      width: 220px; max-width: 34vw;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-weight: 900;
      outline: none;
      background: #fff;
      color: #0f172a;
    }
    .cliente-inline input:focus{
      border-color: rgba(255,0,93,0.55);
      box-shadow: 0 0 0 4px rgba(255,0,93,0.10);
    }
    .cliente-inline button{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 900;
      color: #0f172a;
    }
    .cliente-inline button:hover{
      border-color: rgba(255,0,93,0.55);
    }

    .cliente-autocomplete{ position:relative; }
    .cliente-dd{
      position:absolute;
      top: calc(100% + 8px);
      right: 0;
      width: min(360px, 60vw);
      max-height: 280px;
      overflow:auto;
      background: #ffffff;
      border: 1px solid rgba(2,6,23,.12);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(2,6,23,.18);
      padding: 6px;
      z-index: 9999;
    }
    .cliente-dd.hidden{ display:none; }
    .cliente-dd .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      color:#0f172a;
    }
    .cliente-dd .item:hover{ background: rgba(255,0,93,.08); }
    .cliente-dd .item.active{ background: rgba(255,0,93,.12); }
    .cliente-dd .sub{
      font-weight: 800;
      font-size: 12px;
      color:#64748b;
    }
    .cliente-dd .empty{
      padding: 10px;
      color:#64748b;
      font-weight: 800;
    }

    .cart-items { flex: 1; overflow-y: auto; padding: 0 15px; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
    .qty-controls { display: flex; align-items: center; gap: 6px; background: #f1f5f9; border-radius: 12px; padding: 4px 6px; width: fit-content; margin-top: 6px; }
    .qty-btn { width: 26px; height: 26px; border: 1px solid #e2e8f0; background: white; cursor: pointer; border-radius: 10px; font-weight: 900; color: #334155; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .qty-btn:hover { background: linear-gradient(90deg,var(--primary),var(--primary2)); color: white; border-color: rgba(255,255,255,.0); }
    .cart-footer { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); }
    .total-amount { font-size: 1.9rem; font-weight: 1000; color: #0f172a; display: block; text-align: right; margin-bottom: 10px; }
    .payment-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .btn { border: none; padding: 12px 0; border-radius: 12px; font-weight: 900; cursor: pointer; color: white; font-size: 0.85rem; transition: transform .08s ease, opacity 0.2s; }
    .btn:hover { opacity: 0.95; }
    .btn:active{ transform: translateY(1px); }
    .btn-cash { background: var(--success); }
    .btn-transfer { background: linear-gradient(90deg,var(--primary),var(--primary2)); }
    .btn-mixed { background: var(--mixed); }

    .panel-header { padding: 10px 15px; font-weight: 800; background: #f8fafc; border-bottom: 1px solid var(--border); font-size: 0.85rem; color: #475569; display: flex; justify-content: space-between; align-items: center; }
    .table-container { flex: 1; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead { background: white; position: sticky; top: 0; z-index: 2; }
    th { text-align: left; padding: 10px 15px; color: #64748b; font-weight: 900; border-bottom: 1px solid #e2e8f0; }
    td { padding: 8px 15px; border-bottom: 1px solid #f1f5f9; color: #0f172a; vertical-align: top; }
    .sum-row { display: flex; justify-content: space-between; font-size: 0.95rem; color: #475569; margin-bottom: 6px; }
    .sum-total { margin-top: 10px; padding-top: 10px; border-top: 2px dashed #e2e8f0; font-weight: 1000; font-size: 1.2rem; color: #0f172a; display: flex; justify-content: space-between; }
    .btn-close-box { background: #fee2e2; color: #dc2626; border: none; padding: 10px; border-radius: 14px; font-weight: 900; cursor: pointer; margin-top: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-close-box:hover { background: #dc2626; color: white; }

    /* ‚úÖ chips estado venta */
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px; border-radius: 999px;
      font-weight: 900; font-size: 11px;
      border: 1px solid rgba(2,6,23,.10);
      white-space: nowrap;
    }
    .chip-ok{ background:#ecfdf5; color:#047857; }
    .chip-anulada{ background:#fee2e2; color:#dc2626; }
    .mini-btn{
      padding: 6px 10px; border-radius: 10px;
      border: 1px solid rgba(2,6,23,.12);
      background: #fff;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .mini-btn:hover{ border-color: rgba(255,0,93,0.45); }
    .mini-btn.danger{ background:#fee2e2; color:#dc2626; border-color:#fecaca; }
    .mini-btn.danger:hover{ background:#dc2626; color:#fff; border-color:#dc2626; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-card { background: white; width: 90%; max-width: 420px; border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; transform: translateY(10px); transition: transform 0.2s; position: relative; }
    .modal-overlay.active .modal-card { transform: translateY(0); }
    .modal-header-hero { padding: 20px; text-align: center; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    .modal-header-hero h2 { margin: 0; font-size: 0.9rem; text-transform: uppercase; color: #64748b; letter-spacing: 1px; }
    .modal-price-hero { font-size: 2.5rem; font-weight: 1000; color: #1e293b; margin: 5px 0 0; }
    .modal-body { padding: 20px; }
    .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 1.05rem; outline: none; box-sizing: border-box; font-weight:800; }
    .input-field:focus { border-color: rgba(255,0,93,0.55); box-shadow: 0 0 0 4px rgba(255,0,93,0.10); }
    .modal-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; }
    .btn-modal-cancel { background: white; border: 1px solid #cbd5e1; padding: 10px; border-radius: 12px; font-weight: 900; cursor: pointer; color: #475569; }
    .btn-modal-confirm { background: #0f172a; color: white; border: none; padding: 10px; border-radius: 12px; font-weight: 900; cursor: pointer; }
    .theme-cash .btn-confirm { background: var(--success); }
    .theme-trans .btn-confirm { background: linear-gradient(90deg,var(--primary),var(--primary2)); }
    .theme-mixed .btn-confirm { background: var(--mixed); }
    .vuelto-box { margin-top: 10px; background: #dcfce7; color: #166534; padding: 8px; border-radius: 12px; font-weight: 900; font-size: 1rem; display: none; }

    #alertModal .modal-card, #confirmModal .modal-card { max-width: 380px; text-align: center; }

    #reporteModal { align-items: flex-start; padding-top: 20px; overflow-y: auto; }
    .report-toolbar { background: white; padding: 10px; border-radius: 14px; display: flex; gap: 10px; margin-bottom: 10px; box-shadow: 0 6px 16px rgba(0,0,0,0.10); width: 620px; justify-content: center; }
    .report-btn { padding: 10px 16px; border-radius: 14px; border: none; font-weight: 900; color: white; cursor: pointer; font-size: 0.92rem; display: flex; align-items: center; gap: 7px; }
    .btn-print { background: #64748b; }
    .btn-dl { background: #0d9488; }
    .btn-close-day { background: #ef4444; }
    .close-x { position: absolute; right: 15px; top: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
    .report-paper { background: white; width: 620px; padding: 40px; border-radius: 8px; min-height: 600px; font-family: 'Segoe UI', serif; color: #333; position: relative; margin-bottom: 50px; }
    .report-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
    .report-section h4 { border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; color: var(--secondary); font-size: 0.8rem; text-transform: uppercase; }
    .row-detail { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .row-detail.total { font-weight: 900; font-size: 1.2rem; border-top: 1px solid #000; padding-top: 5px; margin-top: 10px; }
    .audit-ok { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

    #historialCierresModal .modal-card { max-width: 900px; width: 96%; }
    #historialTable { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    #historialTable th { background: #f1f5f9; padding: 10px; text-align: left; }
    #historialTable td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

    /* ‚úÖ PRINT TICKET 80mm (solo ventana ticket) */
    @media print {
      body { background:#fff; }
    }

    @media (max-width: 900px) {
      body{overflow:auto;height:auto}
      .main-wrapper { display: block; overflow: auto; }
      .left-column, .right-column { width: 100%!important; height: auto!important; }
      .resizer-horiz, .resizer-vert-main { display: none; }
      .panel-top, .panel-bottom { height: auto!important; min-height: 300px; margin-bottom: 20px; }
      .search-box { width: 100%; }
      .close-x { right: 5px; top: 5px; }
      .report-toolbar, .report-paper { width: 95%; }
      .cliente-inline input{ width: 100%; max-width: 58vw; }
      .caja-pill input{ width: 120px; }
    }
  </style>
</head>

<body>

<header>
  <div class="header-left">
    <h1>üõí Punto de Venta</h1>

    <div class="search-box">
      <span>üîç</span>
      <input type="text" id="buscador" placeholder="Buscar por nombre..." onkeyup="filtrarProductos()">
    </div>
  </div>

  <div class="header-controls">
    <!-- ‚úÖ CAJERO / TURNO -->
    <div class="caja-pill" title="Cajero / Turno">
      <span>üë§</span>
      <input id="cajeroInput" placeholder="Cajero..." autocomplete="off">
      <span class="turno-tag" id="turnoTag">Turno: ‚Äî</span>
      <button class="btn-header" style="padding:6px 10px; border-radius:999px;" onclick="nuevoTurno()">üîÑ Turno</button>
    </div>

    <button class="btn-header btn-historial" onclick="abrirHistorialCierres()">üìú Historial Cierres</button>
    <button class="btn-header btn-toggle" onclick="togglePaneles()">üëÅÔ∏è Ocultar Paneles</button>
    <div class="date-display" id="reloj">--:--</div>
  </div>
</header>

<div class="main-wrapper" id="mainWrapper">
  <div class="left-column">
    <div class="panel-top">
      <div class="catalog-container">
        <div id="grid-productos" class="grid-products"></div>
      </div>
    </div>

    <div class="resizer-horiz"></div>

    <div class="panel-bottom" id="historyPanel">
      <div class="panel-header">
        <span>üìë Historial Hoy</span>
        <button onclick="cargarHistorial()" style="border:none; background:none; cursor:pointer; font-size: 18px;">üîÑ</button>
      </div>
      <div class="table-container">
        <table id="tabla-ventas">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Pago</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody-ventas"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="resizer-vert-main"></div>

  <div class="right-column" id="rightColumn">
    <div class="panel-top">
      <div class="cart-panel">
        <div class="cart-header cart-header-flex">
          <span>Orden Actual</span>

          <div class="cliente-inline">
            <div class="cliente-autocomplete">
              <input id="clienteHeader" placeholder="Cliente..." autocomplete="off" />
              <div id="clienteDropdown" class="cliente-dd hidden"></div>
            </div>
            <button id="btnClearCliente" title="Limpiar cliente">‚úï</button>
          </div>
        </div>

        <div class="cart-items" id="lista-carrito">
          <div style="text-align:center; color:var(--secondary); margin-top:40px;">Carrito vac√≠o</div>
        </div>

        <div class="cart-footer">
          <div class="total-amount">$<span id="total-precio">0</span></div>
          <div class="payment-buttons">
            <button class="btn btn-cash" onclick="abrirModalPago('efectivo')">üíµ Efec.</button>
            <button class="btn btn-mixed" onclick="abrirModalPago('mixto')">‚öñÔ∏è Mixto</button>
            <button class="btn btn-transfer" onclick="abrirModalPago('transferencia')">üè¶ Transf.</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel-bottom" id="summaryPanel">
      <div class="panel-header">
        <span>üìä Resumen del D√≠a</span>
        <button onclick="abrirReporte()" style="border:none; background:none; cursor:pointer; font-size: 18px;">üìÑ</button>
      </div>
      <div style="padding:15px;">
        <div class="sum-row"><span>Total General</span><b id="sumTotal">$0</b></div>
        <div class="sum-row"><span>Efectivo</span><b id="sumEf">$0</b></div>
        <div class="sum-row"><span>Transferencia</span><b id="sumTr">$0</b></div>
        <div class="sum-row"><span>Mixto</span><b id="sumMx">$0</b></div>
        <div class="sum-total"><span>Ventas</span><span id="sumVentas">0</span></div>
        <button class="btn-close-box" onclick="cerrarDia()">üîí Cerrar Caja del D√≠a</button>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="pagoModal">
  <div class="modal-card">
    <div class="modal-header-hero">
      <h2>Total a Cobrar</h2>
      <div class="modal-price-hero">$<span id="modalTotal">0</span></div>
    </div>
    <div class="modal-body">
      <input class="input-field" id="clienteInput" placeholder="Cliente (opcional)">
      <div style="height:10px"></div>
      <input class="input-field" id="montoInput" type="number" placeholder="Monto recibido (solo efectivo)">
      <div class="vuelto-box" id="vueltoBox">Vuelto: $0</div>

      <!-- ‚úÖ WhatsApp toggle -->
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px; gap:10px;">
        <div style="font-weight:900; color:#475569;">üì≤ Enviar comprobante por WhatsApp</div>
        <label style="display:flex; align-items:center; gap:8px; font-weight:900; color:#0f172a;">
          <input type="checkbox" id="chkWhats" checked>
          <span>Enviar</span>
        </label>
      </div>

      <!-- ‚úÖ Ticket toggle -->
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px; gap:10px;">
        <div style="font-weight:900; color:#475569;">üßæ Imprimir ticket 80mm</div>
        <label style="display:flex; align-items:center; gap:8px; font-weight:900; color:#0f172a;">
          <input type="checkbox" id="chkTicket" checked>
          <span>Imprimir</span>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="cerrarModales()">Cancelar</button>
      <button class="btn-modal-confirm btn-confirm" id="btnConfirmPago">Confirmar</button>
    </div>
    <button class="close-x" onclick="cerrarModales()">√ó</button>
  </div>
</div>

<div class="modal-overlay" id="alertModal">
  <div class="modal-card">
    <div class="modal-header-hero"><h2>Mensaje</h2></div>
    <div class="modal-body"><div id="alertMsg"></div></div>
    <div class="modal-footer" style="grid-template-columns: 1fr;">
      <button class="btn-modal-confirm" onclick="cerrarModales()">OK</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal-card">
    <div class="modal-header-hero"><h2 id="confirmTitle">Confirmar</h2></div>
    <div class="modal-body"><div id="confirmMsg"></div></div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="cerrarModales()">No</button>
      <button class="btn-modal-confirm" id="btnConfirmYes">S√≠</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="reporteModal">
  <div>
    <div class="report-toolbar">
      <button class="report-btn btn-print" onclick="window.print()">üñ® Imprimir</button>
      <button class="report-btn btn-dl" onclick="descargarPDF()">‚¨á PDF</button>
      <button class="report-btn btn-close-day" onclick="cerrarDia()">üîí Cerrar D√≠a</button>
    </div>
    <div class="report-paper" id="reportePaper">
      <div class="report-header">
        <div>
          <div style="font-weight:900; font-size:18px;">DELIVERY <span style="opacity:.7">MAYORISTA</span></div>
          <div style="font-size:12px; color:#64748b;">Reporte de ventas del d√≠a</div>
          <div style="font-size:12px; color:#64748b; margin-top:4px;">
            Cajero: <b id="repCajero">‚Äî</b> ‚Ä¢ Turno: <b id="repTurno">‚Äî</b>
          </div>
        </div>
        <div style="text-align:right; font-size:12px; color:#64748b;">
          <div id="repFecha">‚Äî</div>
          <div id="repHora">‚Äî</div>
        </div>
      </div>

      <div class="report-section">
        <h4>Resumen</h4>
        <div class="row-detail"><span>Total General</span><b id="repTotal">$0</b></div>
        <div class="row-detail"><span>Efectivo</span><b id="repEf">$0</b></div>
        <div class="row-detail"><span>Transferencia</span><b id="repTr">$0</b></div>
        <div class="row-detail"><span>Mixto</span><b id="repMx">$0</b></div>
        <div class="row-detail total"><span>Ventas</span><span id="repVentas">0</span></div>
      </div>

      <div class="report-section" style="margin-top:25px;">
        <h4>Detalle de Ventas</h4>
        <div id="repDetalle"></div>
      </div>

      <div class="report-section" style="margin-top:25px;">
        <h4>Auditor√≠a</h4>
        <div class="row-detail"><span>Estado</span><span class="audit-ok">OK</span></div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="historialCierresModal">
  <div class="modal-card">
    <div class="modal-header-hero">
      <h2>Historial de Cierres</h2>
      <button class="close-x" onclick="cerrarModales()">√ó</button>
    </div>
    <div class="modal-body">
      <table id="historialTable">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Total</th>
            <th>Ventas</th>
            <th>Efectivo</th>
            <th>Transferencia</th>
            <th>Mixto</th>
            <th>Cajero</th>
            <th>Turno</th>
          </tr>
        </thead>
        <tbody id="tbody-cierres"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
 import {
  getFirestore, collection, getDocs, addDoc, updateDoc, doc,
  serverTimestamp, query, where, orderBy, limit,
  runTransaction, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCH2dJRTPXpOPUhaERNAkcj_avqbEYCSXE",
    authDomain: "deliverymayorista-8c042.firebaseapp.com",
    projectId: "deliverymayorista-8c042",
    storageBucket: "deliverymayorista-8c042.firebasestorage.app",
    messagingSenderId: "98776210634",
    appId: "1:98776210634:web:6938a8cdbf497b2353e833"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== Cliente precargado desde URL =====
  const sp = new URLSearchParams(location.search);
  const CLIENTE_PRE = (sp.get('cliente') || '').trim();
  const CLIENTE_ID_PRE = (sp.get('clienteId') || '').trim();
  const TEL_PRE = (sp.get('tel') || '').trim();

  let carrito = [];
  let listaProductos = [];

  let totalDiaEfectivo = 0, totalDiaTransf = 0, totalDiaMixto = 0, totalDiaGeneral = 0;
  let totalRaw = 0;
  let modoPago = "";
  let panelesVisibles = true;

  const money = (n) => '$' + (Number(n||0)).toLocaleString('es-AR');
  const norm = (s) => (s || '').toString().trim().toLowerCase();
  const digits = (s) => (s || '').toString().replace(/\D+/g,'');
  const pad2 = (n) => String(n).padStart(2,'0');

  // ===== CAJA / TURNO =====
  const cajeroInput = document.getElementById('cajeroInput');
  const turnoTag = document.getElementById('turnoTag');

  function loadCaja(){
    const caj = localStorage.getItem('pos_cajero') || '';
    const turno = localStorage.getItem('pos_turno') || '';
    if(cajeroInput) cajeroInput.value = caj;
    if(turnoTag) turnoTag.textContent = 'Turno: ' + (turno || '‚Äî');
  }

  function saveCaja(){
    const caj = (cajeroInput?.value || '').trim();
    localStorage.setItem('pos_cajero', caj);
  }

  window.nuevoTurno = () => {
    const caj = (cajeroInput?.value || '').trim();
    if(!caj) return customAlert('Pon√© el nombre del cajero antes de abrir un turno.');
    const d = new Date();
    const turno = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}-${caj.replace(/\s+/g,'_')}`;
    localStorage.setItem('pos_turno', turno);
    if(turnoTag) turnoTag.textContent = 'Turno: ' + turno;
    customAlert('‚úÖ Turno iniciado: ' + turno);
  };

  function getCaja(){
    const caj = (cajeroInput?.value || localStorage.getItem('pos_cajero') || '').trim();
    const turno = (localStorage.getItem('pos_turno') || '').trim();
    return { cajero: caj || '‚Äî', turno: turno || null };
  }

  cajeroInput?.addEventListener('input', saveCaja);

  setInterval(() => {
    const el = document.getElementById('reloj');
    if (el) el.innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }, 1000);

  window.customAlert = (msg) => {
    document.getElementById('alertMsg').innerText = msg;
    document.getElementById('alertModal').classList.add('active');
  };

  window.customConfirm = (title, msg, callback) => {
    document.getElementById('confirmTitle').innerText = title;
    document.getElementById('confirmMsg').innerText = msg;
    const btn = document.getElementById('btnConfirmYes');
    btn.onclick = () => {
      document.getElementById('confirmModal').classList.remove('active');
      callback();
    };
    document.getElementById('confirmModal').classList.add('active');
  };

  window.cerrarModales = () => {
    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
  };

  window.togglePaneles = () => {
    panelesVisibles = !panelesVisibles;
    document.getElementById('mainWrapper').classList.toggle('fullscreen-mode');
    document.querySelector('.btn-toggle').innerHTML = panelesVisibles ? "üëÅÔ∏è Ocultar Paneles" : "üëÅÔ∏è Mostrar Paneles";
  };

  // ‚úÖ Cliente visible arriba (Orden Actual)
  const clienteHeader = document.getElementById('clienteHeader');
  const btnClearCliente = document.getElementById('btnClearCliente');

  function getClienteActual(){
    const h = (clienteHeader?.value || '').trim();
    const m = (document.getElementById('clienteInput')?.value || '').trim();
    return h || m || CLIENTE_PRE || '';
  }

  function setClienteActual(nombre){
    const v = (nombre || '').trim();
    if (clienteHeader) clienteHeader.value = v;
    const mi = document.getElementById('clienteInput');
    if (mi) mi.value = v;
  }

  if (CLIENTE_PRE) setClienteActual(CLIENTE_PRE);

  // ===============================
  // ‚úÖ AUTOCOMPLETE CLIENTES PRO
  // ===============================
  let clientesCache = [];
  let ddIndex = -1;

  const dd = document.getElementById('clienteDropdown');

  function openDD(){ dd?.classList.remove('hidden'); }
  function closeDD(){ ddIndex = -1; dd?.classList.add('hidden'); }

  function setDDActive(i){
    const items = dd?.querySelectorAll('.item') || [];
    items.forEach(el => el.classList.remove('active'));
    if(i >= 0 && i < items.length){
      items[i].classList.add('active');
      items[i].scrollIntoView({block:'nearest'});
    }
  }

  function pickCliente(c){
    if(!c) return;
    clienteHeader.value = c.nombre;
    clienteHeader.dataset.clienteId = c.id;
    clienteHeader.dataset.tel = c.tel || '';
    const mi = document.getElementById('clienteInput');
    if(mi) mi.value = c.nombre;
    closeDD();
  }

  function renderDD(list){
    if(!dd) return;
    if(!list.length){
      dd.innerHTML = `<div class="empty">Sin resultados</div>`;
      return;
    }
    dd.innerHTML = list.map((c, idx) => `
      <div class="item" data-idx="${idx}">
        <div>
          <div>${c.nombre}</div>
          <div class="sub">${c.tel ? c.tel : '‚Äî'}</div>
        </div>
        <div class="sub">‚Üµ</div>
      </div>
    `).join('');

    dd.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('mousedown', (e)=>{
        e.preventDefault();
        const i = Number(el.dataset.idx);
        pickCliente(list[i]);
      });
    });
  }

  function filteredClientes(){
    const q = norm(clienteHeader.value);
    if(!q) return clientesCache.slice(0, 30);
    return clientesCache.filter(c => norm(c.nombre).includes(q)).slice(0, 30);
  }

  function syncClienteSeleccionado(){
    if(!clienteHeader) return;

    const val = (clienteHeader.value || '').trim();
    const exact = clientesCache.find(c => norm(c.nombre) === norm(val));

    if(exact){
      clienteHeader.dataset.clienteId = exact.id;
      clienteHeader.dataset.tel = exact.tel || '';
    } else {
      clienteHeader.dataset.clienteId = '';
      clienteHeader.dataset.tel = '';
    }

    const mi = document.getElementById('clienteInput');
    if(mi) mi.value = val;
  }

  async function cargarClientes(){
    try{
      const snap = await getDocs(collection(db, 'clientes'));
      clientesCache = [];

      snap.forEach(d => {
        const c = d.data() || {};
        const nombre = (c.nombre || c.Nombre || c.name || c.cliente || '').toString().trim();
        if(!nombre) return;
        const tel = (c.tel || c.telefono || c.Telefono || c.whatsapp || '').toString().trim();
        clientesCache.push({ id: d.id, nombre, tel });
      });

      clientesCache.sort((a,b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity:'base' }));

      if (clienteHeader){
        if (CLIENTE_ID_PRE) clienteHeader.dataset.clienteId = CLIENTE_ID_PRE;
        if (TEL_PRE) clienteHeader.dataset.tel = TEL_PRE;
      }
      syncClienteSeleccionado();

    }catch(e){
      console.error('‚ùå Error cargando clientes:', e);
    }
  }

  clienteHeader?.addEventListener('focus', ()=>{
    const list = filteredClientes();
    renderDD(list);
    openDD();
  });

  clienteHeader?.addEventListener('input', ()=>{
    syncClienteSeleccionado();
    const list = filteredClientes();
    renderDD(list);
    openDD();
  });

  clienteHeader?.addEventListener('keydown', (e)=>{
    const list = filteredClientes();
    const max = list.length - 1;

    if(e.key === 'ArrowDown'){
      e.preventDefault();
      ddIndex = Math.min(max, ddIndex + 1);
      setDDActive(ddIndex);
      openDD();
    }
    if(e.key === 'ArrowUp'){
      e.preventDefault();
      ddIndex = Math.max(0, ddIndex - 1);
      setDDActive(ddIndex);
      openDD();
    }
    if(e.key === 'Enter'){
      if(dd && !dd.classList.contains('hidden') && ddIndex >= 0 && ddIndex <= max){
        e.preventDefault();
        pickCliente(list[ddIndex]);
      } else {
        closeDD();
      }
    }
    if(e.key === 'Escape'){
      closeDD();
    }
  });

  document.addEventListener('click', (e)=>{
    const wrap = document.querySelector('.cliente-autocomplete');
    if(!wrap) return;
    if(!wrap.contains(e.target)) closeDD();
  });

  btnClearCliente?.addEventListener('click', () => {
    if (clienteHeader){
      clienteHeader.dataset.clienteId = '';
      clienteHeader.dataset.tel = '';
      clienteHeader.value = '';
    }
    const mi = document.getElementById('clienteInput');
    if(mi) mi.value = '';
    closeDD();
  });

  // ===== Helpers producto =====
  function getStock(p){
    if(p.stock !== undefined) return Number(p.stock||0);
    if(p.Stock !== undefined) return Number(p.Stock||0);
    if(p.cantidad !== undefined) return Number(p.cantidad||0);
    if(p.Cantidad !== undefined) return Number(p.Cantidad||0);
    if(p.qty !== undefined) return Number(p.qty||0);
    return 0;
  }
  function getPrecio(p){
    if(p.precioMayorista !== undefined) return Number(p.precioMayorista||0);
    if(p.PrecioMayorista !== undefined) return Number(p.PrecioMayorista||0);
    if(p.precio !== undefined) return Number(p.precio||0);
    if(p.Precio !== undefined) return Number(p.Precio||0);
    return 0;
  }
  function getNombre(p){ return p.nombre || p.Nombre || p.name || 'Sin nombre'; }
  function getCodigo(p){ return (p.codigo || p.Codigo || p.code || p.id || '').toString().toUpperCase(); }

  // ===== Cargar y render cat√°logo =====
  async function cargarProductos(){
    try{
      const snap = await getDocs(collection(db, 'productos'));
      listaProductos = [];
      snap.forEach(d => {
        const p = d.data();
        p.id = d.id;
        p._id = d.id;
        listaProductos.push(p);
      });
      renderCatalogo(listaProductos);
    }catch(e){
      console.error('‚ùå Error cargando productos:', e);
      customAlert('ERROR cargando productos: ' + (e?.message || e));
    }
  }

  function renderCatalogo(lista) {
    const grid = document.getElementById('grid-productos');
    grid.innerHTML = "";
    lista.forEach(p => {
      const stock = getStock(p);
      const img = p.imagenUrl || p.imagen || p.img || 'https://placehold.co/240x180?text=Sin+Foto';
      const precio = getPrecio(p);

      const div = document.createElement('div');
      div.className = 'card';

      let stockClass = 'stock-ok';
      if(stock <= 0) stockClass = 'stock-critico';
      else if(stock <= 3) stockClass = 'stock-bajo';

      div.innerHTML = `
        <img src="${img}" class="card-img" alt="">
        <h3>${getNombre(p)}</h3>
        <div class="stock-badge ${stockClass}">Stock: ${stock}</div>
        <div class="price">${money(precio)}</div>
      `;
      div.onclick = () => addCart(p);
      grid.appendChild(div);
    });
  }

  window.filtrarProductos = () => {
    const q = (document.getElementById('buscador').value||'').toLowerCase();
    renderCatalogo(listaProductos.filter(p => getNombre(p).toLowerCase().includes(q)));
  };

  window.addCart = (p) => {
    const id = p.id;
    const nombre = getNombre(p);
    const precio = getPrecio(p);
    const codigo = getCodigo(p);
    const stock = getStock(p);

    const ex = carrito.find(i => i.id === id);
    if(ex){
      if(ex.cantidad + 1 > stock) return customAlert('No hay stock suficiente.');
      ex.cantidad++;
    }else{
      if(stock <= 0) return customAlert('Sin stock.');
      carrito.push({id, nombre, precio, codigo, stock, cantidad: 1});
    }

    if(document.getElementById('buscador').value) {
      document.getElementById('buscador').value="";
      renderCatalogo(listaProductos);
    }
    renderCart();
  };

  window.modQty = (i, delta) => {
    carrito[i].cantidad += delta;
    if(carrito[i].cantidad <= 0) carrito.splice(i,1);
    renderCart();
  };

  window.eliminarItem = (i) => {
    carrito.splice(i,1);
    renderCart();
  };

  function renderCart() {
    const list = document.getElementById('lista-carrito');
    list.innerHTML = "";
    let t = 0;

    if(carrito.length === 0){
      list.innerHTML = `<div style="text-align:center; color:var(--secondary); margin-top:40px;">Carrito vac√≠o</div>`;
      document.getElementById('total-precio').innerText = "0";
      totalRaw = 0;
      return;
    }

    carrito.forEach((p, i) => {
      t += p.precio * p.cantidad;
      list.innerHTML += `
        <div class="cart-item">
          <div style="max-width: 70%;">
            <b>${p.nombre}</b>
            <div style="font-size:12px;color:#64748b;margin-top:2px;">${p.codigo}</div>
            <div class="qty-controls">
              <button class="qty-btn" onclick="modQty(${i},-1)">‚àí</button>
              <span class="qty-val" style="min-width:18px;display:inline-block;text-align:center;font-weight:900;">${p.cantidad}</span>
              <button class="qty-btn" onclick="modQty(${i},1)">+</button>
              <small style="margin-left:6px;color:#64748b;font-weight:800;">x ${money(p.precio)}</small>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#64748b;">Stock: <b>${p.stock}</b></div>
          </div>
          <div style="text-align:right; min-width: 110px;">
            <b>${money(p.precio*p.cantidad)}</b><br>
            <span style="color:var(--danger);cursor:pointer;font-size:0.85rem;font-weight:900;" onclick="eliminarItem(${i})">Eliminar</span>
          </div>
        </div>
      `;
    });

    totalRaw = t;
    document.getElementById('total-precio').innerText = t.toLocaleString('es-AR');
  }

  window.abrirModalPago = (modo) => {
    if(carrito.length === 0) return customAlert("El carrito est√° vac√≠o.");
    modoPago = modo;

    document.getElementById('modalTotal').innerText = totalRaw.toLocaleString('es-AR');
    document.getElementById('montoInput').value = "";
    document.getElementById('vueltoBox').style.display = "none";

    setClienteActual(getClienteActual());
    syncClienteSeleccionado();

    const modal = document.getElementById('pagoModal');
    modal.classList.add('active');

    const btn = document.getElementById('btnConfirmPago');
    btn.onclick = () => confirmarPago();

    const card = modal.querySelector('.modal-card');
    card.classList.remove('theme-cash','theme-trans','theme-mixed');
    if(modo === 'efectivo') card.classList.add('theme-cash');
    if(modo === 'transferencia') card.classList.add('theme-trans');
    if(modo === 'mixto') card.classList.add('theme-mixed');

    document.getElementById('montoInput').style.display = (modo === 'efectivo') ? 'block' : 'none';
  };

  document.addEventListener('input', () => {
    if(!document.getElementById('pagoModal').classList.contains('active')) return;
    if(modoPago !== 'efectivo') return;

    const recibido = Number(document.getElementById('montoInput').value || 0);
    const vuelto = recibido - totalRaw;

    const box = document.getElementById('vueltoBox');
    if(recibido > 0){
      box.style.display = 'block';
      box.innerText = `Vuelto: ${money(vuelto)}`;
      box.style.background = (vuelto < 0) ? '#fee2e2' : '#dcfce7';
      box.style.color = (vuelto < 0) ? '#dc2626' : '#166534';
    } else {
      box.style.display = 'none';
    }
  });

  // ===============================
  // ‚úÖ 1) TICKET 80mm
  // ===============================
  function buildTicketHTML(venta){
    const fecha = new Date(venta.fecha);
    const items = (venta.items||[]);
    const lines = items.map(it => {
      const sub = Number(it.precio||0) * Number(it.cant||0);
      return `
        <div class="row">
          <div class="name">${it.nombre || it.codigo}</div>
          <div class="meta">${it.cant} x ${money(it.precio)} = <b>${money(sub)}</b></div>
        </div>
      `;
    }).join('');

    return `
      <html>
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Ticket</title>
        <style>
          @page { size: 80mm auto; margin: 6mm; }
          body { font-family: Arial, sans-serif; color:#000; }
          .wrap { width: 68mm; }
          .center { text-align:center; }
          .h1 { font-size: 16px; font-weight: 900; }
          .sub { font-size: 12px; margin-top: 2px; }
          .hr { border-top: 1px dashed #000; margin: 8px 0; }
          .row { margin: 6px 0; }
          .name { font-size: 13px; font-weight: 900; }
          .meta { font-size: 12px; }
          .tot { display:flex; justify-content:space-between; font-size: 14px; font-weight: 900; margin-top: 8px; }
          .small { font-size: 11px; }
        </style>
      </head>
      <body onload="window.print(); setTimeout(()=>window.close(), 300);">
        <div class="wrap">
          <div class="center">
            <div class="h1">DELIVERY MAYORISTA</div>
            <div class="sub">Comprobante de venta</div>
          </div>
          <div class="hr"></div>

          <div class="small"><b>Fecha:</b> ${fecha.toLocaleString('es-AR')}</div>
          <div class="small"><b>Cliente:</b> ${venta.cliente || 'Cliente'}</div>
          <div class="small"><b>Pago:</b> ${venta.pago || '‚Äî'}</div>
          <div class="small"><b>Cajero:</b> ${venta.cajero || '‚Äî'}</div>
          <div class="small"><b>Turno:</b> ${venta.turno || '‚Äî'}</div>

          <div class="hr"></div>
          ${lines}
          <div class="hr"></div>

          <div class="tot"><span>TOTAL</span><span>${money(venta.total||0)}</span></div>

          <div class="hr"></div>
          <div class="center small">¬°Gracias por su compra!</div>
        </div>
      </body>
      </html>
    `;
  }

  function imprimirTicket80(venta){
    const w = window.open('', '_blank', 'width=380,height=650');
    if(!w) return;
    w.document.open();
    w.document.write(buildTicketHTML(venta));
    w.document.close();
  }

  // ===============================
  // ‚úÖ 2) WHATSAPP
  // ===============================
  function normalizePhoneAR(raw){
    const d = digits(raw);
    if(!d) return '';
    // Si ya trae 54...
    if(d.startsWith('54')) return d;
    // Si trae 0...
    if(d.startsWith('0')) return '54' + d.slice(1);
    // Default: asumir Argentina
    return '54' + d;
  }

  function buildWhatsMsg(venta){
    const fecha = new Date(venta.fecha).toLocaleString('es-AR');
    const items = (venta.items||[]).map(it => {
      const sub = Number(it.precio||0) * Number(it.cant||0);
      return `- ${it.cant} x ${it.nombre || it.codigo} (${money(it.precio)}) = ${money(sub)}`;
    }).join('\n');

    return (
`üßæ *Comprobante - Delivery Mayorista*
üìÖ ${fecha}
üë§ Cliente: *${venta.cliente || 'Cliente'}*
üí≥ Pago: *${venta.pago || '‚Äî'}*
üë§ Cajero: *${venta.cajero || '‚Äî'}*
üîñ Turno: *${venta.turno || '‚Äî'}*

üõí *Detalle*
${items}

‚úÖ *TOTAL:* ${money(venta.total||0)}`
    );
  }

  function abrirWhatsApp(venta){
    const tel = normalizePhoneAR(venta.tel || '');
    const msg = encodeURIComponent(buildWhatsMsg(venta));
    const url = tel ? `https://wa.me/${tel}?text=${msg}` : `https://wa.me/?text=${msg}`;
    window.open(url, '_blank');
  }

  // ===============================
  // ‚úÖ 4) ANULAR VENTA (devuelve stock)
  // ===============================
  window.anularVenta = async (ventaId) => {
  if (!ventaId) return;

  const venta = (window._ventasDia || []).find(v => v.id === ventaId);
  if (!venta) return customAlert('No se encontr√≥ la venta.');
  if (venta.anulada) return customAlert('Esta venta ya est√° anulada.');

  customConfirm(
    'Anular venta',
    '¬øConfirm√°s anular esta venta?\nSe devolver√° el stock de forma segura.',
    async () => {
      try {
        await runTransaction(db, async (transaction) => {

          // 1Ô∏è‚É£ Leer venta en tiempo real
          const ventaRef = doc(db, 'ventas', ventaId);
          const ventaSnap = await transaction.get(ventaRef);

          if (!ventaSnap.exists()) {
            throw new Error('La venta no existe.');
          }

          const ventaData = ventaSnap.data();
          if (ventaData.anulada) {
            throw new Error('La venta ya estaba anulada.');
          }

          // 2Ô∏è‚É£ Devolver stock producto por producto
          for (const it of (ventaData.items || [])) {
            if (!it.id) continue;

            const prodRef = doc(db, 'productos', it.id);
            const prodSnap = await transaction.get(prodRef);

            if (!prodSnap.exists()) {
              throw new Error(`Producto eliminado: ${it.nombre || it.codigo}`);
            }

            const stockActual = Number(prodSnap.data().stock || 0);
            const devolver = Number(it.cant || 0);

            transaction.update(prodRef, {
              stock: stockActual + devolver
            });
          }

          // 3Ô∏è‚É£ Marcar venta como anulada
          transaction.update(ventaRef, {
            anulada: true,
            anuladaAt: serverTimestamp()
          });
        });

        customAlert('‚úÖ Venta anulada correctamente. Stock restaurado.');
        await cargarProductos();
        await cargarHistorial();

      } catch (e) {
        console.error(e);
        customAlert('ERROR al anular venta: ' + (e.message || e));
      }
    }
  );
};
  // ‚úÖ Confirma venta
  async function confirmarPago(){
    const cliente = getClienteActual();

    const clienteIdSeleccionado = (clienteHeader?.dataset?.clienteId || '').trim();
    const telSeleccionado = (clienteHeader?.dataset?.tel || '').trim();

    if(modoPago === 'efectivo'){
      const recibido = Number(document.getElementById('montoInput').value || 0);
      if(recibido <= 0) return customAlert("Ingres√° el monto recibido.");
      if(recibido < totalRaw) return customAlert("El monto recibido es menor al total.");
    }

    for(const it of carrito){
      if(it.cantidad > it.stock){
        return customAlert(`Stock insuficiente para ${it.nombre}.`);
      }
    }

    // ‚úÖ caja
    const caja = getCaja();
    if(!caja.cajero || caja.cajero === '‚Äî'){
      return customAlert('Pon√© el nombre del CAJERO antes de cobrar.');
    }
    if(!caja.turno){
      return customAlert('Abr√≠ un TURNO (bot√≥n "Turno") antes de cobrar.');
    }

    const ventaPayload = {
      fecha: new Date(),
      cliente: cliente || 'Cliente',
      clienteId: clienteIdSeleccionado || CLIENTE_ID_PRE || null,
      tel: telSeleccionado || TEL_PRE || null,
      pago: modoPago,
      total: totalRaw,
      items: carrito.map(p => ({
        id: p.id,
        codigo: p.codigo,
        nombre: p.nombre,
        precio: p.precio,
        cant: p.cantidad
      })),
      cajero: caja.cajero,
      turno: caja.turno,
      anulada: false,
      createdAt: serverTimestamp()
    };

    try{
      const ventaRef = await addDoc(collection(db, 'ventas'), ventaPayload);

      for(const it of carrito){
        const ref = doc(db, 'productos', it.id);
        const nuevo = Math.max(0, Number(it.stock) - Number(it.cantidad));
        await updateDoc(ref, { stock: nuevo });
      }

      // ‚úÖ acciones post venta (ticket + whatsapp)
      const chkW = document.getElementById('chkWhats');
      const chkT = document.getElementById('chkTicket');
      const ventaFinal = { ...ventaPayload, id: ventaRef.id, fecha: new Date() };

      carrito = [];
      renderCart();
      cerrarModales();

      customAlert("‚úÖ Venta guardada y stock actualizado.");

      await cargarProductos();
      await cargarHistorial();

      // ‚úÖ ticket
      if(chkT?.checked) imprimirTicket80(ventaFinal);

      // ‚úÖ whatsapp
      if(chkW?.checked) abrirWhatsApp(ventaFinal);

    }catch(e){
      console.error(e);
      customAlert("ERROR: " + (e?.message || e));
    }
  }

  // ===== Historial del d√≠a (incluye ID para anular) =====
  async function cargarHistorial(){
    const hoy = new Date();
    const start = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 0,0,0,0);
    const end = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 23,59,59,999);

    const ventasRef = collection(db, 'ventas');
    const qy = query(ventasRef, where('fecha', '>=', start), where('fecha', '<=', end), orderBy('fecha','desc'), limit(200));
    const snap = await getDocs(qy);

    const ventas = [];
    totalDiaEfectivo=0; totalDiaTransf=0; totalDiaMixto=0; totalDiaGeneral=0;

    snap.forEach(d => {
      const v = d.data();
      ventas.push({ id: d.id, ...v });

      const anulada = !!v.anulada;
      const total = Number(v.total||0);

      if(!anulada){
        totalDiaGeneral += total;
        const p = (v.pago||'').toLowerCase();
        if(p.includes('efec')) totalDiaEfectivo += total;
        else if(p.includes('transf')) totalDiaTransf += total;
        else if(p.includes('mixt')) totalDiaMixto += total;
      }
    });

    window._ventasDia = ventas;
    renderHistorial();
    renderResumen();
  }

  function renderHistorial(){
    const tb = document.getElementById('tbody-ventas');
    tb.innerHTML = '';

    const arr = window._ventasDia || [];
    if(!arr.length){
      tb.innerHTML = `<tr><td colspan="5" style="color:#64748b;">No hay ventas hoy.</td></tr>`;
      return;
    }

    arr.forEach(v => {
      const fecha = v.fecha?.toDate ? v.fecha.toDate() : (v.fecha instanceof Date ? v.fecha : null);
      const hora = fecha ? fecha.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'}) : '‚Äî';

      const estado = v.anulada
        ? `<span class="chip chip-anulada">‚õî ANULADA</span>`
        : `<span class="chip chip-ok">‚úÖ OK</span>`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${hora}<div style="margin-top:6px;">${estado}</div></td>
        <td>${v.cliente || 'Cliente'}<div style="color:#64748b;font-size:12px;margin-top:4px;">${v.cajero || '‚Äî'} ‚Ä¢ ${v.turno || '‚Äî'}</div></td>
        <td>${v.pago || '‚Äî'}</td>
        <td>${money(v.total || 0)}</td>
        <td>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="mini-btn" onclick='imprimirTicket80(${JSON.stringify({
              fecha: (v.fecha?.toDate ? v.fecha.toDate() : new Date()),
              cliente: v.cliente || 'Cliente',
              pago: v.pago || '‚Äî',
              total: v.total || 0,
              items: v.items || [],
              cajero: v.cajero || '‚Äî',
              turno: v.turno || '‚Äî',
              tel: v.tel || ''
            }).replaceAll("'", "\\'")})'>üßæ Ticket</button>

            <button class="mini-btn" onclick='abrirWhatsApp(${JSON.stringify({
              fecha: (v.fecha?.toDate ? v.fecha.toDate() : new Date()),
              cliente: v.cliente || 'Cliente',
              pago: v.pago || '‚Äî',
              total: v.total || 0,
              items: v.items || [],
              cajero: v.cajero || '‚Äî',
              turno: v.turno || '‚Äî',
              tel: v.tel || ''
            }).replaceAll("'", "\\'")})'>üì≤ Whats</button>

            ${v.anulada ? '' : `<button class="mini-btn danger" onclick="anularVenta('${v.id}')">‚õî Anular</button>`}
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderResumen(){
    document.getElementById('sumTotal').innerText = money(totalDiaGeneral);
    document.getElementById('sumEf').innerText = money(totalDiaEfectivo);
    document.getElementById('sumTr').innerText = money(totalDiaTransf);
    document.getElementById('sumMx').innerText = money(totalDiaMixto);
    document.getElementById('sumVentas').innerText = (window._ventasDia||[]).filter(v => !v.anulada).length;
  }

  window.abrirReporte = () => {
    const ahora = new Date();
    document.getElementById('repFecha').innerText = ahora.toLocaleDateString('es-AR');
    document.getElementById('repHora').innerText = ahora.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});

    document.getElementById('repTotal').innerText = money(totalDiaGeneral);
    document.getElementById('repEf').innerText = money(totalDiaEfectivo);
    document.getElementById('repTr').innerText = money(totalDiaTransf);
    document.getElementById('repMx').innerText = money(totalDiaMixto);
    document.getElementById('repVentas').innerText = (window._ventasDia||[]).filter(v => !v.anulada).length;

    const caja = getCaja();
    document.getElementById('repCajero').innerText = caja.cajero || '‚Äî';
    document.getElementById('repTurno').innerText = caja.turno || '‚Äî';

    const detalle = document.getElementById('repDetalle');
    detalle.innerHTML = '';

    (window._ventasDia||[]).forEach(v => {
      const anulada = !!v.anulada;
      const items = (v.items||[]).map(it => `${it.cant}√ó ${it.nombre||it.codigo}`).join(', ');
      const div = document.createElement('div');
      div.style.padding = "8px 0";
      div.style.borderBottom = "1px solid #e2e8f0";
      div.innerHTML = `
        <b>${money(v.total)}</b> ‚Ä¢ ${v.pago || '‚Äî'} ‚Ä¢ <span style="color:#64748b">${v.cliente||'Cliente'}</span>
        <div style="color:#64748b;font-size:12px;margin-top:4px">${items}</div>
        <div style="margin-top:6px;">${anulada ? `<span class="chip chip-anulada">‚õî ANULADA</span>` : `<span class="chip chip-ok">‚úÖ OK</span>`}</div>
      `;
      detalle.appendChild(div);
    });

    document.getElementById('reporteModal').classList.add('active');
  };

  window.descargarPDF = () => {
    const element = document.getElementById('reportePaper');
    html2pdf().from(element).set({
      margin: 10,
      filename: `reporte_${new Date().toISOString().slice(0,10)}.pdf`,
      html2canvas: { scale: 2 }
    }).save();
  };

  window.cerrarDia = async () => {
    const caja = getCaja();
    customConfirm('Cerrar d√≠a', '¬øConfirm√°s cerrar el d√≠a y guardar el cierre?', async () => {
      try{
        await addDoc(collection(db, 'cierres_caja'), {
          fecha: new Date(),
          total: totalDiaGeneral,
          ventas: (window._ventasDia||[]).filter(v => !v.anulada).length,
          efectivo: totalDiaEfectivo,
          transferencia: totalDiaTransf,
          mixto: totalDiaMixto,
          cajero: caja.cajero || '‚Äî',
          turno: caja.turno || null,
          createdAt: serverTimestamp()
        });
        customAlert('‚úÖ Cierre guardado.');
      }catch(e){
        customAlert('ERROR: ' + (e?.message || e));
      }
    });
  };

  window.abrirHistorialCierres = async () => {
    try{
      const ref = collection(db, 'cierres_caja');
      const qy = query(ref, orderBy('fecha','desc'), limit(50));
      const snap = await getDocs(qy);

      const tb = document.getElementById('tbody-cierres');
      tb.innerHTML = '';
      snap.forEach(docu => {
        const d = docu.data();
        const fecha = d.fecha?.toDate ? d.fecha.toDate() : (d.fecha instanceof Date ? d.fecha : null);
        const ftxt = fecha ? fecha.toLocaleString('es-AR') : '‚Äî';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ftxt}</td>
          <td>${money(d.total||0)}</td>
          <td>${d.ventas||0}</td>
          <td>${money(d.efectivo||0)}</td>
          <td>${money(d.transferencia||0)}</td>
          <td>${money(d.mixto||0)}</td>
          <td>${d.cajero || '‚Äî'}</td>
          <td>${d.turno || '‚Äî'}</td>
        `;
        tb.appendChild(tr);
      });

      document.getElementById('historialCierresModal').classList.add('active');
    }catch(e){
      customAlert('ERROR: ' + (e?.message || e));
    }
  };

  // Init
  loadCaja();
  if(!localStorage.getItem('pos_turno')){
    // no molestar, pero mostrar ‚Äî
    if(turnoTag) turnoTag.textContent = 'Turno: ‚Äî';
  }

  cargarClientes();
  cargarProductos();
  cargarHistorial();
</script>

</body>
</html>
