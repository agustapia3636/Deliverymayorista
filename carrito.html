<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tu carrito | Delivery Mayorista</title>

  <style>
    :root {
      --color-fondo: #05030f;
      --color-card: #0d0c1a;
      --color-texto: #ffffff;
      --color-secundario: #b3b3d9;
      --color-rosa: #ff0080;
      --color-naranja: #ff9800;
      --color-verde: #00c853;
      --color-rojo: #ff5252;
      --radio: 18px;
      --fuente: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--fuente);
      background: radial-gradient(circle at top, #16152b 0, var(--color-fondo) 60%);
      color: var(--color-texto);
    }

    header {
      background: linear-gradient(90deg, #ff005d, #ffa400);
      padding: 16px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
    }

    .header-titulo { font-weight: 700; letter-spacing: .06em; }
    .header-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.6);
      padding: 8px 14px;
      font-size: 13px;
      background: rgba(0,0,0,.2);
      color: #fff;
      cursor: pointer;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    .volver-link {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      color: #c9c9ff;
      text-decoration: none;
      font-weight: 600;
      opacity: .9;
      margin: 6px 0 10px;
    }

    h1 { font-size: 26px; margin: 6px 0 18px; }

    .carrito-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .carrito-layout { grid-template-columns: 1fr; }
    }

    .carrito-items,
    .carrito-resumen {
      background: rgba(7,7,22,.9);
      border-radius: var(--radio);
      padding: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.05);
    }

    .carrito-items { min-height: 240px; }

    .carrito-vacio {
      text-align: center;
      padding: 20px;
      color: var(--color-secundario);
    }

    .item {
      background: #101022;
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: 74px 1fr;
      gap: 10px;
      border: 1px solid rgba(255,255,255,.05);
    }

    .item-img {
      width: 74px;
      height: 74px;
      border-radius: 12px;
      background: #05040f;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .item-img img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    .item-info { font-size: 13px; color: var(--color-secundario); }
    .item-nombre { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 2px; }
    .item-codigo { opacity: .9; }

    .item-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .cant-box {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
    }

    .btn-cant {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: #26263d;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 22px rgba(0,0,0,.2);
      transition: transform .08s ease, filter .08s ease;
    }
    .btn-cant:hover { filter: brightness(1.06); transform: translateY(-1px); }

    .cant-num {
      min-width: 36px;
      background: #fff;
      color: #000;
      border-radius: 999px;
      text-align: center;
      font-weight: 800;
      padding: 4px 10px;
      font-size: 13px;
    }

    .precio-box { text-align: right; }
    .precio-unit { opacity: .95; }
    .precio-sub { color: #ffd56c; font-weight: 900; }

    .btn-del {
      border-radius: 999px;
      border: none;
      background: rgba(255,82,82,.18);
      color: #ff9ca9;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 800;
    }

    .carrito-resumen { position: sticky; top: 14px; }
    @media (max-width: 980px) { .carrito-resumen { position: static; } }

    .resumen-titulo { font-weight: 900; margin-bottom: 10px; }
    .resumen-linea { display: flex; justify-content: space-between; margin: 6px 0; color: #c9c9ff; font-size: 13px; }
    .resumen-total { font-size: 22px; font-weight: 900; margin: 10px 0 12px; }

    .btn {
      width: 100%;
      border-radius: 999px;
      padding: 12px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      margin-top: 10px;
    }
    .btn-outline { background: transparent; border: 1px solid #373757; color: #fff; }
    .btn-rojo { background: linear-gradient(90deg, #ff1744, #ff6f61); color: #fff; }
    .btn-verde { background: linear-gradient(90deg, #00c853, #00e676); color: #01210e; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    .nota {
      margin-top: 10px;
      font-size: 11px;
      opacity: .78;
      color: #c9c9ff;
      line-height: 1.35;
    }
    .nota b { color: #fff; }

    footer {
      text-align: center;
      color: rgba(255,255,255,.55);
      padding: 24px 10px 30px;
      font-size: 12px;
    }

    /* Sticky resumen mobile */
    .sticky-resumen-mobile {
      display: none;
    }

    @media (max-width: 768px) {
      .sticky-resumen-mobile {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(90deg, #00c853, #00e676);
        color: #01210e;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        font-weight: 900;
        z-index: 999;
        box-shadow: 0 -10px 30px rgba(0,0,0,.35);
      }

      .sticky-resumen-mobile button {
        border-radius: 999px;
        border: none;
        padding: 10px 16px;
        background: #01210e;
        color: #00e676;
        font-weight: 900;
        cursor: pointer;
      }

      body {
        padding-bottom: 80px; /* evita que tape contenido */
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-titulo">DELIVERY MAYORISTA</div>
    <button class="header-btn" onclick="location.href='catalogo.html'">Ver catálogo</button>
  </header>

  <main>
    <a class="volver-link" href="catalogo.html">← Ir al catálogo</a>
    <h1>Tu carrito</h1>

    <div class="carrito-layout">
      <section class="carrito-items" id="contenedor-items"></section>

      <aside class="carrito-resumen">
        <div class="resumen-titulo">Resumen</div>

        <div class="resumen-linea">
          <span>Cantidad de productos</span>
          <span id="cantidad-total">0</span>
        </div>

        <div class="resumen-total">
          Total: $<span id="total-carrito">0</span>
        </div>

        <div class="nota">Total estimado sujeto a stock disponible y últimas actualizaciones.</div>

        <button class="btn btn-outline" id="btn-seguir">← Seguir comprando</button>
        <button class="btn btn-rojo" id="btn-vaciar">Vaciar carrito</button>
        <button class="btn btn-verde" id="btn-whatsapp">Enviar pedido por WhatsApp</button>

        <label style="font-size:13px; color:#c9c9ff; margin-top:8px;">Observaciones del pedido</label>
        <textarea
          id="nota-pedido"
          placeholder="Ej: entregar martes, factura A, revisar stock…"
          style="
            width:100%;
            min-height:70px;
            border-radius:12px;
            border:none;
            padding:10px;
            font-size:13px;
            margin-top:4px;
          "
        ></textarea>

        <div class="nota" style="margin-top:12px">
          Se enviará un detalle con <b>código</b>, <b>nombre</b>, <b>cantidad</b> y <b>total</b> directamente a tu WhatsApp.
          <br /><br />
          <b>IMPORTANTE:</b> este pedido también se guarda en tu Firestore (colección "ventas") para que puedas llevar el control de pedidos desde el panel Admin.
        </div>
      </aside>
    </div>

    <!-- Sticky resumen mobile -->
    <div id="sticky-resumen-mobile" class="sticky-resumen-mobile">
      <span>
        Total: $<b id="sticky-total">0</b>
      </span>
      <button id="sticky-enviar">Enviar pedido</button>
    </div>
  </main>

  <footer>Catálogo mayorista · Delivery Mayorista</footer>

  <script type="module">
    import { db } from "./js/firebase-init.js";
    import { collection, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const CLAVE_CARRITO = "carrito_dm_v1";

    const contenedorItems = document.getElementById("contenedor-items");
    const spanCantidad = document.getElementById("cantidad-total");
    const spanTotal = document.getElementById("total-carrito");
    const btnVaciar = document.getElementById("btn-vaciar");
    const btnWhatsapp = document.getElementById("btn-whatsapp");
    const btnSeguir = document.getElementById("btn-seguir");
    const stickyTotal = document.getElementById("sticky-total");
    const stickyEnviar = document.getElementById("sticky-enviar");

    function leerCarrito() {
      try {
        const raw = localStorage.getItem(CLAVE_CARRITO);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function guardarCarrito(carrito) {
      try {
        localStorage.setItem(CLAVE_CARRITO, JSON.stringify(carrito));
      } catch (e) {
        console.error("Error guardando carrito", e);
      }

      window.dispatchEvent(new CustomEvent("dm-carrito-update", { detail: carrito }));
    }

    function formatearPrecio(valor) {
      return Number(valor || 0).toLocaleString("es-AR");
    }

    function totalizar(carrito) {
      let total = 0;
      let cant = 0;
      for (const it of carrito) {
        const q = Number(it.cantidad || 0);
        const p = Number(it.precio || 0);
        cant += q;
        total += p * q;
      }
      return { total, cant };
    }

    function renderCarrito() {
      const carrito = leerCarrito();

      if (!carrito.length) {
        contenedorItems.innerHTML =
          '<div class="carrito-vacio">Tu carrito está vacío. Agregá productos desde el catálogo.</div>';
        spanCantidad.textContent = "0";
        spanTotal.textContent = "0";
        btnVaciar.disabled = true;
        btnWhatsapp.disabled = true;
        return;
      }

      btnVaciar.disabled = false;
      btnWhatsapp.disabled = false;

      contenedorItems.innerHTML = "";

      for (let i = 0; i < carrito.length; i++) {
        const it = carrito[i];

        const precio = Number(it.precio || 0);
        const qty = Number(it.cantidad || 1);
        const sub = precio * qty;

        const div = document.createElement("div");
        div.className = "item";

        const imgHtml = it.imagen
          ? `<img src="${it.imagen}" alt="${(it.nombre || it.codigo || "Producto")}" referrerpolicy="no-referrer" loading="lazy" decoding="async" />`
          : "";

        div.innerHTML = `
          <div class="item-img">${imgHtml}</div>

          <div class="item-info">
            <div class="item-nombre">${it.nombre || "Producto"}</div>
            <div class="item-codigo">Código: <b>${it.codigo || ""}</b></div>

            <div class="item-row">
              <div class="cant-box">
                <button class="btn-cant" data-i="${i}" data-d="-1">−</button>
                <div class="cant-num">${qty}</div>
                <button class="btn-cant" data-i="${i}" data-d="1">+</button>
              </div>

              <div class="precio-box">
                <div class="precio-unit">$${formatearPrecio(precio)}</div>
                <div class="precio-sub">$${formatearPrecio(sub)}</div>
              </div>

              <button class="btn-del" data-del="${i}">Eliminar</button>
            </div>
          </div>
        `;

        contenedorItems.appendChild(div);
      }

      const { total, cant } = totalizar(carrito);
      spanCantidad.textContent = String(cant);
      spanTotal.textContent = formatearPrecio(total);

      if (stickyTotal) stickyTotal.textContent = total.toLocaleString("es-AR");

      // listeners qty
      contenedorItems.querySelectorAll(".btn-cant").forEach((b) => {
        b.addEventListener("click", () => {
          const i = Number(b.dataset.i);
          const d = Number(b.dataset.d);

          const c = leerCarrito();
          if (!c[i]) return;

          c[i].cantidad = Math.max(1, (Number(c[i].cantidad || 1) + d));
          guardarCarrito(c);
          renderCarrito();
        });
      });

      // listeners delete
      contenedorItems.querySelectorAll(".btn-del").forEach((b) => {
        b.addEventListener("click", () => {
          const i = Number(b.dataset.del);
          const c = leerCarrito();
          c.splice(i, 1);
          guardarCarrito(c);
          renderCarrito();
        });
      });
    }

    // Sticky resumen mobile
    stickyEnviar?.addEventListener("click", () => btnWhatsapp.click());

    btnSeguir.addEventListener("click", () => {
      location.href = "catalogo.html";
    });

    btnVaciar.addEventListener("click", () => {
      if (!confirm("¿Vaciar carrito?")) return;
      guardarCarrito([]);
      renderCarrito();
    });

    btnWhatsapp.addEventListener("click", async () => {
      const carrito = leerCarrito();
      if (!carrito.length) return;

      let total = 0;
      let msg = "Hola! Pedido mayorista:%0A%0A";

      for (const it of carrito) {
        const sub = (Number(it.precio || 0) * Number(it.cantidad || 0));
        total += sub;
        msg += `• ${it.codigo} - ${it.nombre} x ${it.cantidad}u = $${formatearPrecio(sub)}
