<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tu carrito | Delivery Mayorista</title>

  <style>
    :root {
      --color-fondo: #05030f;
      --color-card: #0d0c1a;
      --color-texto: #ffffff;
      --color-secundario: #b3b3d9;
      --color-rosa: #ff0080;
      --color-naranja: #ff9800;
      --color-verde: #00c853;
      --color-rojo: #ff5252;
      --radio: 18px;
      --fuente: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--fuente);
      background: radial-gradient(circle at top, #16152b 0, var(--color-fondo) 60%);
      color: var(--color-texto);
    }

    header {
      background: linear-gradient(90deg, #ff005d, #ffa400);
      padding: 16px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
    }

    .header-titulo { font-weight: 700; letter-spacing: .06em; }
    .header-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.6);
      padding: 8px 14px;
      font-size: 13px;
      background: rgba(0,0,0,.2);
      color: #fff;
      cursor: pointer;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    .volver-link {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      color: #c9c9ff;
      text-decoration: none;
      font-weight: 600;
      opacity: .9;
      margin: 6px 0 10px;
    }

    h1 { font-size: 26px; margin: 6px 0 18px; }

    .carrito-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .carrito-layout { grid-template-columns: 1fr; }
    }

    .carrito-items,
    .carrito-resumen {
      background: rgba(7,7,22,.9);
      border-radius: var(--radio);
      padding: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.05);
    }

    .carrito-items { min-height: 240px; }

    .carrito-vacio {
      text-align: center;
      padding: 20px;
      color: var(--color-secundario);
    }

    .item {
      background: #101022;
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: 74px 1fr;
      gap: 10px;
      border: 1px solid rgba(255,255,255,.05);
    }

    .item-img {
      width: 74px;
      height: 74px;
      border-radius: 12px;
      background: #05040f;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .item-img img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    .item-info { font-size: 13px; color: var(--color-secundario); }
    .item-nombre { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 2px; }
    .item-codigo { opacity: .9; }

    .item-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .cant-box {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
    }

    .btn-cant {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: #26263d;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 22px rgba(0,0,0,.2);
      transition: transform .08s ease, filter .08s ease;
    }
    .btn-cant:hover { filter: brightness(1.06); transform: translateY(-1px); }

    .cant-num {
      min-width: 36px;
      background: #fff;
      color: #000;
      border-radius: 999px;
      text-align: center;
      font-weight: 800;
      padding: 4px 10px;
      font-size: 13px;
    }

    .precio-box { text-align: right; }
    .precio-unit { opacity: .95; }
    .precio-sub { color: #ffd56c; font-weight: 900; }

    .btn-del {
      border-radius: 999px;
      border: none;
      background: rgba(255,82,82,.18);
      color: #ff9ca9;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 800;
    }

    .carrito-resumen { position: sticky; top: 14px; }
    @media (max-width: 980px) { .carrito-resumen { position: static; } }

    .resumen-titulo { font-weight: 900; margin-bottom: 10px; }
    .resumen-linea { display: flex; justify-content: space-between; margin: 6px 0; color: #c9c9ff; font-size: 13px; }
    .resumen-total { font-size: 22px; font-weight: 900; margin: 10px 0 12px; }

    .btn {
      width: 100%;
      border-radius: 999px;
      padding: 12px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      margin-top: 10px;
    }
    .btn-outline { background: transparent; border: 1px solid #373757; color: #fff; }
    .btn-rojo { background: linear-gradient(90deg, #ff1744, #ff6f61); color: #fff; }
    .btn-verde { background: linear-gradient(90deg, #00c853, #00e676); color: #01210e; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    .nota {
      margin-top: 10px;
      font-size: 11px;
      opacity: .78;
      color: #c9c9ff;
      line-height: 1.35;
    }
    .nota b { color: #fff; }

    footer {
      text-align: center;
      color: rgba(255,255,255,.55);
      padding: 24px 10px 30px;
      font-size: 12px;
    }
  
    /* ===== Stock en carrito ===== */
    .stock-line{
      margin-top: 6px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      width: fit-content;
      position: relative;
    }
    .stock-line.stock-ok { color: #9dffd1; border-color: rgba(0,200,83,.25); }
    .stock-line.stock-bajo { color: #ffe08a; border-color: rgba(255,152,0,.25); }
    .stock-line.stock-sin { color: #ff9aa6; border-color: rgba(255,82,82,.25); }

    /* Feedback stock PRO: "Sin stock" 1s */
    .stock-flash-text{
      position: absolute;
      right: -6px;
      top: -10px;
      font-size: 11px;
      font-weight: 900;
      background: #ff5252;
      color: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      opacity: 0;
      transform: translateY(4px) scale(.95);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
      white-space: nowrap;
    }
    .stock-flash-text.show{
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    .btn-cant.stock-bloqueado{
      opacity: .45;
      cursor: not-allowed;
      filter: grayscale(.2);
    }

    /* ===== Observaciones ===== */
    .nota-label{
      margin-top: 10px;
      font-size: 13px;
      color: #c9c9ff;
      font-weight: 700;
      display:block;
    }
    .nota-textarea{
      width: 100%;
      min-height: 70px;
      border-radius: 12px;
      border: none;
      padding: 10px;
      font-size: 13px;
      margin-top: 6px;
      outline: none;
    }

    /* ===== Sticky resumen mobile ===== */
    .sticky-resumen-mobile { display: none; }

    @media (max-width: 768px) {
      body { padding-bottom: 92px; } /* evita que tape contenido */

      .sticky-resumen-mobile{
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: 10px;
        z-index: 999;
        border-radius: 18px;
        background: linear-gradient(90deg, #00c853, #00e676);
        color: #01210e;
        box-shadow: 0 18px 40px rgba(0,0,0,.45);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 12px 12px 14px;
        gap: 10px;
      }

      .sticky-resumen-mobile .sticky-left{
        display:flex;
        flex-direction:column;
        line-height: 1.05;
      }
      .sticky-resumen-mobile .sticky-left small{
        font-weight: 800;
        opacity: .85;
      }
      .sticky-resumen-mobile .sticky-left b{
        font-size: 18px;
        font-weight: 1000;
      }

      .sticky-resumen-mobile button{
        border-radius: 999px;
        border: none;
        padding: 11px 14px;
        background: #01210e;
        color: #00e676;
        font-weight: 1000;
        cursor: pointer;
        white-space: nowrap;
      }

      .sticky-resumen-mobile button:disabled{
        opacity:.55;
        cursor:not-allowed;
      }
    }

  </style>
</head>

<body>
  <header>
    <div class="header-titulo">DELIVERY MAYORISTA</div>
    <button class="header-btn" onclick="location.href='catalogo.html'">Ver cat√°logo</button>
  </header>

  <main>
    <a class="volver-link" href="catalogo.html">‚Üê Ir al cat√°logo</a>
    <h1>Tu carrito</h1>

    <div class="carrito-layout">
      <section class="carrito-items" id="contenedor-items"></section>

      <aside class="carrito-resumen" id="resumen">
        <div class="resumen-titulo">Resumen</div>

        <div class="resumen-linea">
          <span>Cantidad de productos</span>
          <span id="cantidad-total">0</span>
        </div>

        <div class="resumen-total">
          Total: $<span id="total-carrito">0</span>
        </div>

        <div class="nota">Total estimado sujeto a stock disponible y √∫ltimas actualizaciones.</div>

        <button class="btn btn-outline" id="btn-seguir">‚Üê Seguir comprando</button>
        <button class="btn btn-rojo" id="btn-vaciar">Vaciar carrito</button>
        <button class="btn btn-verde" id="btn-whatsapp">Enviar pedido por WhatsApp</button>

        <!-- ‚úÖ Observaciones -->
        <label class="nota-label" for="nota-pedido">Observaciones del pedido</label>
        <textarea
          id="nota-pedido"
          class="nota-textarea"
          placeholder="Ej: entregar martes, factura A, revisar stock‚Ä¶"
        ></textarea>

        <div class="nota" style="margin-top:12px">
          Se enviar√° un detalle con <b>c√≥digo</b>, <b>nombre</b>, <b>cantidad</b> y <b>total</b> directamente a tu WhatsApp.
          <br /><br />
          <b>IMPORTANTE:</b> este pedido tambi√©n se guarda en tu Firestore (colecci√≥n "ventas") para que puedas llevar el control de pedidos desde el panel Admin.
        </div>
      </aside>
    </div>
  </main>


  <!-- ‚úÖ Sticky resumen mobile -->
  <div id="sticky-resumen-mobile" class="sticky-resumen-mobile" aria-hidden="true">
    <div class="sticky-left">
      <small>Total</small>
      $ <b id="sticky-total">0</b>
    </div>
    <button id="sticky-enviar">Enviar pedido</button>
  </div>

  <footer>Cat√°logo mayorista ¬∑ Delivery Mayorista</footer>

  <script type="module">
    import { db } from "./js/firebase-init.js";
    import { collection, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ‚úÖ UNIFICADO con catalogo.html / producto.html
    const CLAVE_CARRITO = "carrito_dm_v1";
    const CLAVE_CACHE_CATALOGO = "dm_catalogo_cache_v2";

    // ===== DOM =====
    const contenedorItems = document.getElementById("contenedor-items");
    const spanCantidad = document.getElementById("cantidad-total");
    const spanTotal = document.getElementById("total-carrito");
    const btnVaciar = document.getElementById("btn-vaciar");
    const btnWhatsapp = document.getElementById("btn-whatsapp");
    const btnSeguir = document.getElementById("btn-seguir");
    const notaPedido = document.getElementById("nota-pedido");

    // sticky
    const stickyWrap = document.getElementById("sticky-resumen-mobile");
    const stickyTotal = document.getElementById("sticky-total");
    const stickyEnviar = document.getElementById("sticky-enviar");

    function leerCarrito() {
      try {
        const raw = localStorage.getItem(CLAVE_CARRITO);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function guardarCarrito(carrito) {
      try {
        localStorage.setItem(CLAVE_CARRITO, JSON.stringify(carrito));
      } catch (e) {
        console.error("Error guardando carrito", e);
      }

      // üîî avisamos a cat√°logo/producto que cambi√≥ el carrito (stock visual vuelve)
      window.dispatchEvent(new CustomEvent("dm-carrito-update", { detail: carrito }));
    }

    function leerCatalogoCache() {
      try {
        const raw = localStorage.getItem(CLAVE_CACHE_CATALOGO);
        if (!raw) return [];
        const obj = JSON.parse(raw);
        return Array.isArray(obj?.data) ? obj.data : [];
      } catch { return []; }
    }

    function normalizarCodigo(x){
      return String(x?.codigo ?? x?.Codigo ?? x?.id ?? "").trim();
    }

    function syncStockDesdeCatalogoCache() {
      const cat = leerCatalogoCache();
      if (!cat.length) return;

      const stockMap = new Map();
      for (const p of cat) {
        const cod = normalizarCodigo(p);
        if (!cod) continue;
        const s = Number(p?.stock ?? p?.Stock ?? 0);
        if (Number.isFinite(s)) stockMap.set(cod, s);
      }

      const carrito = leerCarrito();
      let cambio = false;

      for (const it of carrito) {
        const cod = String(it?.codigo ?? "").trim();
        if (!cod) continue;
        if (!stockMap.has(cod)) continue;

        const nuevoStock = stockMap.get(cod);
        if (Number(it.stock) !== Number(nuevoStock)) {
          it.stock = nuevoStock;
          cambio = true;
        }
        // si la cantidad supera el stock, la bajamos
        if (Number.isFinite(Number(it.stock))) {
          const st = Number(it.stock);
          const q = Math.max(1, Number(it.cantidad || 1));
          if (st >= 0 && q > st) {
            it.cantidad = Math.max(1, st);
            cambio = true;
          }
        }
      }

      if (cambio) guardarCarrito(carrito);
    }

    function updateSticky(total, carritoLen){
      const empty = !carritoLen;
      if (stickyTotal) stickyTotal.textContent = String(formatearPrecio(total));
      if (stickyWrap){
        stickyWrap.style.display = (window.matchMedia("(max-width: 768px)").matches && !empty) ? "flex" : "none";
        stickyWrap.setAttribute("aria-hidden", String(empty));
      }
      if (stickyEnviar) stickyEnviar.disabled = empty;
    }

    function hasFiniteStock(it){
      const s = Number(it?.stock);
      return Number.isFinite(s) && s >= 0;
    }

    function stockInfo(it){
      if (!hasFiniteStock(it)) return null;
      const stock = Number(it.stock);
      const qty = Math.max(1, Number(it.cantidad || 1));
      const restante = Math.max(0, stock - qty);

      let cls = "stock-ok";
      let txt = `En stock ¬∑ quedan ${restante} u`;

      if (restante <= 0){
        cls = "stock-sin";
        txt = "Sin stock";
      } else if (restante <= 5){
        cls = "stock-bajo";
        txt = `Stock bajo ¬∑ quedan ${restante} u`;
      }

      return { stock, qty, restante, cls, txt };
    }

    function flashSinStock(itemEl){
      const el = itemEl?.querySelector("[data-stock-flash]");
      if (!el) return;
      el.classList.add("show");
      clearTimeout(el.__t);
      el.__t = setTimeout(() => el.classList.remove("show"), 900);
    }

    function formatearPrecio(valor) {
      return Number(valor || 0).toLocaleString("es-AR");
    }

    function totalizar(carrito) {
      let total = 0;
      let cant = 0;
      for (const it of carrito) {
        const q = Number(it.cantidad || 0);
        const p = Number(it.precio || 0);
        cant += q;
        total += p * q;
      }
      return { total, cant };
    }

    function renderCarrito() {
      const carrito = leerCarrito();

      if (!carrito.length) {
        contenedorItems.innerHTML =
          '<div class="carrito-vacio">Tu carrito est√° vac√≠o. Agreg√° productos desde el cat√°logo.</div>';
        spanCantidad.textContent = "0";
        spanTotal.textContent = "0";
        btnVaciar.disabled = true;
        btnWhatsapp.disabled = true;
        return;
      }

      btnVaciar.disabled = false;
      btnWhatsapp.disabled = false;

      contenedorItems.innerHTML = "";

      for (let i = 0; i < carrito.length; i++) {
        const it = carrito[i];

        const precio = Number(it.precio || 0);
        const qty = Math.max(1, Number(it.cantidad || 1));
        const sub = precio * qty;

        const info = stockInfo(it);
        const plusDisabled = info ? (info.qty >= info.stock || info.restante <= 0) : false;
        const stockHtml = info ? `
              <div class="stock-line ${info.cls}">
                ${info.txt}
                <span class="stock-flash-text" data-stock-flash>Sin stock</span>
              </div>
            ` : ``;

        const div = document.createElement("div");
        div.className = "item";

        const imgHtml = it.imagen
          ? `<img src="${it.imagen}" alt="${(it.nombre || it.codigo || "Producto")}" referrerpolicy="no-referrer" loading="lazy" decoding="async" />`
          : "";

        div.innerHTML = `
          <div class="item-img">${imgHtml}</div>

          <div class="item-info">
            <div class="item-nombre">${it.nombre || "Producto"}</div>
            <div class="item-codigo">C√≥digo: <b>${it.codigo || ""}</b></div>
            ${stockHtml}

            <div class="item-row">
              <div class="cant-box">
                <button class="btn-cant" data-i="${i}" data-d="-1">‚àí</button>
                <div class="cant-num">${qty}</div>
                <button class="btn-cant" data-i="${i}" data-d="1" ${plusDisabled ? "disabled" : ""}>+</button>
              </div>

              <div class="precio-box">
                <div class="precio-unit">$${formatearPrecio(precio)}</div>
                <div class="precio-sub">$${formatearPrecio(sub)}</div>
              </div>

              <button class="btn-del" data-del="${i}">Eliminar</button>
            </div>
          </div>
        `;

        contenedorItems.appendChild(div);
      }

      const { total, cant } = totalizar(carrito);
      spanCantidad.textContent = String(cant);
      spanTotal.textContent = formatearPrecio(total);

      // listeners qty
      contenedorItems.querySelectorAll(".btn-cant").forEach((b) => {
        b.addEventListener("click", () => {
          const i = Number(b.dataset.i);
          const d = Number(b.dataset.d);

          const c = leerCarrito();
          if (!c[i]) return;

          c[i].cantidad = Math.max(1, (Number(c[i].cantidad || 1) + d));
          guardarCarrito(c);
          renderCarrito();
        });
      });

      // listeners delete
      contenedorItems.querySelectorAll(".btn-del").forEach((b) => {
        b.addEventListener("click", () => {
          const i = Number(b.dataset.del);
          const c = leerCarrito();
          c.splice(i, 1);
          guardarCarrito(c);
          renderCarrito();
        });
      });
    }

    btnSeguir.addEventListener("click", () => {
      location.href = "catalogo.html";
    });

    btnVaciar.addEventListener("click", () => {
      if (!confirm("¬øVaciar carrito?")) return;
      guardarCarrito([]);
      renderCarrito();
    });

    btnWhatsapp.addEventListener("click", async () => {
      const carrito = leerCarrito();
      if (!carrito.length) return;

      let total = 0;
      let msg = "Hola! Pedido mayorista:%0A%0A";

      for (const it of carrito) {
        const sub = (Number(it.precio || 0) * Number(it.cantidad || 0));
        total += sub;
        msg += `‚Ä¢ ${it.codigo} - ${it.nombre} x ${it.cantidad}u = $${formatearPrecio(sub)}%0A`;
      }
      msg += `%0Aüîπ Total: $${formatearPrecio(total)}`;

      // guarda en Firestore (ventas)
      try {
        const coleccionVentas = collection(db, "ventas");
        await addDoc(coleccionVentas, {
          items: carrito,
          total,
          creadoEn: serverTimestamp(),
          estado: "pendiente",
          origen: "carrito_web"
        });
      } catch (e) {
        console.warn("No se pudo guardar en Firestore (ventas):", e);
      }

      // abrir WhatsApp (sin n√∫mero fijo -> wa.me/?text=)
      window.open(`https://wa.me/?text=${msg}`, "_blank");
    });

    // Inicio
    renderCarrito();
  </script>
</body>
</html>
