<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tu carrito | Delivery Mayorista</title>

  <style>
    :root {
      --color-fondo: #05030f;
      --color-card: #0d0c1a;
      --color-borde-card: #252444;
      --color-texto: #ffffff;
      --color-secundario: #b3b3d9;
      --color-rosa: #ff0080;
      --color-naranja: #ff9800;
      --color-verde: #00c853;
      --color-rojo: #ff5252;
      --radio-grande: 18px;
      --fuente: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--fuente);
      background: radial-gradient(circle at top, #16152b 0, var(--color-fondo) 60%);
      color: var(--color-texto);
    }

    header {
      background: linear-gradient(90deg, #ff005d, #ffa400);
      padding: 16px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    .header-titulo {
      font-weight: 700;
      letter-spacing: 0.06em;
      font-size: 18px;
    }

    .header-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.2);
      color: #fff;
    }

    main {
      max-width: 1024px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    .volver {
      font-size: 14px;
      margin-bottom: 10px;
    }

    .volver a {
      color: #c28cff;
      text-decoration: none;
    }

    .volver a:hover {
      text-decoration: underline;
    }

    h1.carrito-titulo {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 18px;
    }

    .carrito-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
      gap: 18px;
    }

    @media (max-width: 768px) {
      .carrito-layout {
        grid-template-columns: 1fr;
      }
    }

    .carrito-lista {
      background: rgba(7, 7, 22, 0.9);
      border-radius: var(--radio-grande);
      padding: 14px 12px 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.6);
      min-height: 120px;
      max-height: 450px;
      overflow-y: auto;
    }

    .carrito-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      grid-template-rows: auto auto;
      gap: 10px;
      padding: 10px 8px;
      border-radius: 14px;
      background: #101022;
      margin-bottom: 8px;
      align-items: center;
    }

    @media (max-width: 600px) {
      .carrito-item {
        grid-template-columns: 64px 1fr;
        grid-template-rows: auto auto auto;
      }
    }

    .carrito-item-img {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      background: #05040f;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      grid-row: 1 / span 2;
    }

    .carrito-item-img img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .carrito-item-info {
      font-size: 13px;
      color: var(--color-secundario);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .carrito-item-nombre {
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 2px;
    }

    .carrito-item-codigo {
      font-size: 12px;
      opacity: 0.85;
    }

    .carrito-item-detalle {
      font-size: 12px;
      opacity: 0.8;
    }

    .carrito-item-acciones {
      grid-column: 2 / 4;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      .carrito-item-acciones {
        grid-column: 1 / 3;
      }
    }

    .cantidad-control {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-cant {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      background: #26263d;
      color: #ffffff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .btn-cant:active {
      transform: translateY(1px);
    }

    .cantidad-display {
      min-width: 32px;
      height: 26px;
      border-radius: 999px;
      background: #fff;
      color: #111;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }

    .precio-info {
      font-size: 12px;
      text-align: right;
    }

    .precio-unitario {
      color: var(--color-secundario);
    }

    .precio-subtotal {
      font-weight: 600;
      color: #ffd570;
    }

    .btn-eliminar {
      border-radius: 999px;
      border: none;
      background: rgba(255, 82, 82, 0.18);
      color: #ff9ca9;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .carrito-vacio {
      text-align: center;
      padding: 18px 6px;
      color: var(--color-secundario);
      font-size: 14px;
    }

    .resumen-card {
      background: #0d0c1c;
      border-radius: var(--radio-grande);
      padding: 16px 14px 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.55);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      top: 12px;
    }

    .resumen-titulo {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .resumen-linea {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      font-size: 14px;
    }

    .resumen-linea span:last-child {
      font-weight: 600;
    }

    .resumen-total {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .resumen-subtexto {
      font-size: 11px;
      color: var(--color-secundario);
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .btn-grande {
      width: 100%;
      border-radius: 999px;
      padding: 12px 14px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #373757;
      color: #ffffff;
    }

    .btn-rojo {
      background: linear-gradient(90deg, #ff1744, #ff6f61);
      color: #ffffff;
    }

    .btn-verde {
      background: linear-gradient(90deg, #00c853, #00e676);
      color: #01210e;
    }

    .btn-grande:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-grande:active {
      transform: translateY(1px);
    }

    .texto-whatsapp {
      font-size: 12px;
      color: var(--color-secundario);
      margin-top: -4px;
      margin-bottom: 2px;
    }

    .texto-whatsapp strong {
      color: #ffffff;
    }

    .nota-firestore {
      margin-top: 8px;
      font-size: 11px;
      color: var(--color-secundario);
      opacity: 0.9;
    }

    .texto-destacado {
      color: #ffcb6b;
      font-weight: 500;
    }

    .texto-azulito {
      color: #80d8ff;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-titulo">DELIVERY MAYORISTA</div>
    <button class="header-btn" onclick="window.location.href='catalogo.html'">
      Ver cat√°logo
    </button>
  </header>

  <main>
    <div class="volver">
      <a href="catalogo.html">&larr; Ir al cat√°logo</a>
    </div>

    <h1 class="carrito-titulo">Tu carrito</h1>

    <div class="carrito-layout">
      <section class="carrito-lista" id="carrito-items">
        <!-- items din√°micos -->
      </section>

      <aside class="resumen-card">
        <div class="resumen-titulo">Resumen</div>
        <div class="resumen-linea">
          <span>Cantidad de productos</span>
          <span id="resumen-cantidad">0</span>
        </div>
        <div class="resumen-total">
          Total: $<span id="resumen-total">0</span>
        </div>
        <div class="resumen-subtexto">
          Total estimado sujeto a stock disponible y √∫ltimas actualizaciones.
        </div>

        <button class="btn-grande btn-outline" id="btn-seguir">
          ‚Üê Seguir comprando
        </button>

        <button class="btn-grande btn-rojo" id="btn-vaciar">
          Vaciar carrito
        </button>

        <button class="btn-grande btn-verde" id="btn-whatsapp">
          Enviar pedido por WhatsApp
        </button>

        <p class="texto-whatsapp">
          Se enviar√° un detalle con <strong>c√≥digo, nombre, cantidad y total</strong>
          directamente a tu WhatsApp.
        </p>

        <p class="nota-firestore">
          <span class="texto-destacado">IMPORTANTE:</span>
          este pedido tambi√©n se guarda en tu
          <span class="texto-azulito">Firestore (colecci√≥n "ventas")</span> para
          que puedas llevar el control de pedidos desde el panel Admin.
        </p>
      </aside>
    </div>
  </main>

  <script type="module">
    import { db } from "./js/firebase-init.js";
    import {
      collection,
      addDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è CAMBIO CLAVE AC√Å (ANTES ERA "dm_carrito")
    const CLAVE_CARRITO = "carrito";
    // ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è ESTA L√çNEA ES LA QUE LO SINCRONIZA CON EL CAT√ÅLOGO

    const TELEFONO_WHATSAPP = "5491112345678"; // pon√© ac√° tu n√∫mero

    const contenedorItems = document.getElementById("carrito-items");
    const spanCantidad = document.getElementById("resumen-cantidad");
    const spanTotal = document.getElementById("resumen-total");
    const btnSeguir = document.getElementById("btn-seguir");
    const btnVaciar = document.getElementById("btn-vaciar");
    const btnWhatsapp = document.getElementById("btn-whatsapp");

    function leerCarrito() {
      try {
        const raw = localStorage.getItem(CLAVE_CARRITO);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error("Error leyendo carrito", e);
        return [];
      }
    }

    function guardarCarrito(carrito) {
      try {
        localStorage.setItem(CLAVE_CARRITO, JSON.stringify(carrito));
      } catch (e) {
        console.error("Error guardando carrito", e);
      }
    }

    function formatearPrecio(valor) {
      return Number(valor || 0).toLocaleString("es-AR");
    }

    function renderCarrito() {
      const carrito = leerCarrito();

      if (!carrito.length) {
        contenedorItems.innerHTML =
          '<div class="carrito-vacio">Tu carrito est√° vac√≠o. Agreg√° productos desde el cat√°logo.</div>';
        spanCantidad.textContent = "0";
        spanTotal.textContent = "0";
        btnVaciar.disabled = true;
        btnWhatsapp.disabled = true;
        return;
      }

      btnVaciar.disabled = false;
      btnWhatsapp.disabled = false;

      contenedorItems.innerHTML = "";

      let totalCantidad = 0;
      let totalPrecio = 0;

      carrito.forEach((item, index) => {
        const codigo =
          item.codigo ?? item.Codigo ?? item.codigo_producto ?? item.cod ?? "";
        const nombre =
          item.nombre ?? item["Nombre Corto"] ?? item.descripcion ?? "Producto";
        const imagen = item.imagen ?? item.Imagen ?? "";
        const precio =
          Number(item.precioMayorista ??
            item.precio ??
            item.PrecioMayorista ??
            0);
        const cantidad = Number(item.cantidad ?? item.Cantidad ?? 1);

        const subtotal = precio * cantidad;
        totalCantidad += cantidad;
        totalPrecio += subtotal;

        const card = document.createElement("article");
        card.classList.add("carrito-item");

        const divImg = document.createElement("div");
        divImg.classList.add("carrito-item-img");
        if (imagen) {
          const img = document.createElement("img");
          img.src = imagen;
          img.alt = nombre;
          img.onerror = () => {
            img.remove();
            divImg.textContent = "Sin imagen";
            divImg.style.fontSize = "11px";
            divImg.style.color = "#77779b";
          };
          divImg.appendChild(img);
        } else {
          divImg.textContent = "Sin imagen";
          divImg.style.fontSize = "11px";
          divImg.style.color = "#77779b";
        }

        const info = document.createElement("div");
        info.classList.add("carrito-item-info");

        const titulo = document.createElement("div");
        titulo.classList.add("carrito-item-nombre");
        titulo.textContent = nombre;

        const codigoSpan = document.createElement("div");
        codigoSpan.classList.add("carrito-item-codigo");
        codigoSpan.textContent = codigo ? `C√≥digo: ${codigo}` : "";

        info.appendChild(titulo);
        info.appendChild(codigoSpan);

        const detalleExtra = document.createElement("div");
        detalleExtra.classList.add("carrito-item-detalle");
        detalleExtra.textContent = "";
        info.appendChild(detalleExtra);

        const acciones = document.createElement("div");
        acciones.classList.add("carrito-item-acciones");

        const contCant = document.createElement("div");
        contCant.classList.add("cantidad-control");

        const btnMenos = document.createElement("button");
        btnMenos.type = "button";
        btnMenos.classList.add("btn-cant");
        btnMenos.textContent = "‚àí";

        const spanCant = document.createElement("div");
        spanCant.classList.add("cantidad-display");
        spanCant.textContent = String(cantidad);

        const btnMas = document.createElement("button");
        btnMas.type = "button";
        btnMas.classList.add("btn-cant");
        btnMas.textContent = "+";

        contCant.appendChild(btnMenos);
        contCant.appendChild(spanCant);
        contCant.appendChild(btnMas);

        const precios = document.createElement("div");
        precios.classList.add("precio-info");

        const pUnit = document.createElement("div");
        pUnit.classList.add("precio-unitario");
        pUnit.textContent = `Unit: $${formatearPrecio(precio)}`;

        const pSub = document.createElement("div");
        pSub.classList.add("precio-subtotal");
        pSub.textContent = `Sub: $${formatearPrecio(subtotal)}`;

        precios.appendChild(pUnit);
        precios.appendChild(pSub);

        const btnEliminar = document.createElement("button");
        btnEliminar.type = "button";
        btnEliminar.classList.add("btn-eliminar");
        btnEliminar.textContent = "Eliminar";

        acciones.appendChild(contCant);
        acciones.appendChild(precios);
        acciones.appendChild(btnEliminar);

        card.appendChild(divImg);
        card.appendChild(info);
        card.appendChild(acciones);

        contenedorItems.appendChild(card);

        btnMenos.addEventListener("click", () => {
          modificarCantidad(index, -1);
        });

        btnMas.addEventListener("click", () => {
          modificarCantidad(index, +1);
        });

        btnEliminar.addEventListener("click", () => {
          eliminarItem(index);
        });
      });

      spanCantidad.textContent = String(totalCantidad);
      spanTotal.textContent = formatearPrecio(totalPrecio);
    }

    function modificarCantidad(index, delta) {
      const carrito = leerCarrito();
      if (!carrito[index]) return;

      const actual = Number(carrito[index].cantidad ?? 1);
      let nueva = actual + delta;
      if (nueva < 1) nueva = 1;

      carrito[index].cantidad = nueva;
      guardarCarrito(carrito);
      renderCarrito();
    }

    function eliminarItem(index) {
      const carrito = leerCarrito();
      if (!carrito[index]) return;

      carrito.splice(index, 1);
      guardarCarrito(carrito);
      renderCarrito();
    }

    btnSeguir.addEventListener("click", () => {
      window.location.href = "catalogo.html";
    });

    btnVaciar.addEventListener("click", () => {
      if (!confirm("¬øVaciar todo el carrito?")) return;
      guardarCarrito([]);
      renderCarrito();
    });

    btnWhatsapp.addEventListener("click", async () => {
      const carrito = leerCarrito();
      if (!carrito.length) return;

      let totalNum = 0;

      let texto = "Hola! Quiero hacer este pedido mayorista:%0A%0A";

      carrito.forEach((item) => {
        const codigo =
          item.codigo ?? item.Codigo ?? item.codigo_producto ?? item.cod ?? "";
        const nombre =
          item.nombre ?? item["Nombre Corto"] ?? "Producto sin nombre";
        const precio =
          Number(item.precioMayorista ?? item.precio ?? item.PrecioMayorista ?? 0);
        const cantidad = Number(item.cantidad ?? item.Cantidad ?? 1);
        const subtotal = precio * cantidad;
        totalNum += subtotal;

        texto += `‚Ä¢ ${codigo} - ${nombre} x ${cantidad}u = $${formatearPrecio(subtotal)}%0A`;
      });

      texto += `%0Aüîπ Total estimado: $${formatearPrecio(totalNum)}`;

      // 1) Guardar la venta en Firestore
      try {
        const coleccionVentas = collection(db, "ventas");
        await addDoc(coleccionVentas, {
          items: carrito,
          total: totalNum,
          creadoEn: serverTimestamp(),
          estado: "pendiente",
          origen: "carrito_web",
        });
      } catch (e) {
        console.error("Error guardando venta en Firestore ‚ùå", e);
      }

      // 2) Abrir WhatsApp con el pedido
      const url = `https://wa.me/${TELEFONO_WHATSAPP}?text=${texto}`;
      window.open(url, "_blank");
    });

    // Inicio
    renderCarrito();
  </script>
</body>
</html>
