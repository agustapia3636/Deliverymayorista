<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Delivery Mayorista - V3.2 Resizable</title>
    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --primary: #2563eb; 
            --secondary: #64748b;
            --success: #10b981; 
            --mixed: #8b5cf6;
            --text-main: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Ocupa toda la pantalla */
            overflow: hidden; /* Evita scroll doble */
        }

        /* HEADER */
        header {
            background: var(--bg-card);
            padding: 10px 30px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0; /* Altura fija */
            z-index: 10;
        }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); font-weight: 700; }
        .date-display { font-size: 0.9rem; color: var(--secondary); font-weight: 500; background: #f8fafc; padding: 5px 10px; border-radius: 20px; }

        /* CONTENEDOR PRINCIPAL */
        .main-wrapper {
            display: flex;
            flex-direction: column;
            flex: 1; /* Ocupa el resto del espacio vertical */
            overflow: hidden;
        }

        /* PARTE SUPERIOR (VENTA) */
        .top-section {
            flex: 1; /* Esto hace que ocupe todo el espacio disponible */
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
            padding-bottom: 5px; /* Menos padding abajo para el resizer */
            overflow: hidden; 
            min-height: 150px; /* M√≠nimo para que no desaparezca */
        }

        /* BARRA DE REDIMENSIONAMIENTO (RESIZER) */
        #drag-handle {
            height: 12px;
            background: #e2e8f0;
            cursor: ns-resize; /* FLECHA DOBLE NORTE-SUR */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s;
            border-top: 1px solid #cbd5e1;
            border-bottom: 1px solid #cbd5e1;
        }
        #drag-handle:hover {
            background: #cbd5e1; /* Color m√°s oscuro al pasar el mouse */
        }
        #drag-handle::after {
            content: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢"; /* Adorno visual */
            color: #64748b;
            font-size: 12px;
            letter-spacing: 3px;
            margin-top: -6px;
            font-weight: bold;
        }

        /* CATALOGO */
        .catalog-container {
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .grid-products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .card-img {
            width: 100%;
            height: 110px;
            object-fit: contain; 
            background: #fff;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #f0f0f0;
        }
        .card h3 { font-size: 0.85rem; margin: 0 0 5px; line-height: 1.3; font-weight: 600; }
        .price { font-weight: 700; color: var(--text-main); font-size: 1.1rem; }
        .stock-badge { font-size: 0.7rem; color: var(--secondary); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 5px; }

        /* CARRITO */
        .cart-panel {
            background: var(--bg-card);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            height: 100%;
            overflow: hidden;
        }

        .cart-header { padding: 12px 15px; border-bottom: 1px solid var(--border); font-weight: 600; background:#fafafa; }
        
        .cart-items { flex: 1; overflow-y: auto; padding: 0 15px; }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 0.9rem;
        }

        .cart-footer { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); }
        .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .total-label { color: var(--secondary); font-size: 0.9rem; }
        .total-amount { font-size: 1.6rem; font-weight: 800; color: var(--text-main); }
        .payment-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn { border: none; padding: 12px 2px; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; font-size: 0.85rem; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-cash { background: var(--success); }
        .btn-transfer { background: var(--primary); }
        .btn-mixed { background: var(--mixed); }

        /* PARTE DE ABAJO (HISTORIAL) */
        .bottom-section {
            background: white;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            
            /* ALTURA INICIAL (Se modifica con JS) */
            height: 300px; 
            flex-shrink: 0; /* No se achica sola */
        }

        .panel-card { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .panel-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .table-container { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        thead { background: #f1f5f9; position: sticky; top: 0; z-index: 2; }
        th { text-align: left; padding: 10px; color: var(--secondary); font-weight: 600; border-bottom: 1px solid #cbd5e1; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:hover { background-color: #f8fafc; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; display: inline-block; }
        .bg-cash { background: #dcfce7; color: #166534; }
        .bg-trans { background: #dbeafe; color: #1e40af; }
        .bg-mix { background: #f3e8ff; color: #6b21a8; }
        
        .summary-card {
            background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: center; gap: 10px;
        }
        .sum-row { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .sum-total { margin-top: 5px; padding-top: 10px; border-top: 2px solid #e2e8f0; font-weight: 800; font-size: 1.2rem; color: var(--primary); }

        @media (max-width: 900px) {
            .main-wrapper { display: block; overflow: auto; }
            #drag-handle { display: none; } /* En celular ocultamos el resizer */
            .bottom-section { height: auto; min-height: 400px; }
            .top-section { height: auto; min-height: 500px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>üì¶ Delivery Mayorista <span style="font-weight:400; font-size:0.8em; color:#94a3b8;">POS v3.2</span></h1>
        <div class="date-display" id="reloj">--:--</div>
    </header>

    <div class="main-wrapper">
        
        <div class="top-section">
            <div class="catalog-container">
                <div id="grid-productos" class="grid-products">
                    <p>Cargando cat√°logo...</p>
                </div>
            </div>

            <aside class="cart-panel">
                <div class="cart-header">Orden Actual</div>
                <div class="cart-items" id="lista-carrito">
                    <div style="text-align:center; color:var(--secondary); margin-top:40px; font-size:0.9rem;">
                        <span style="display:block; font-size:2rem; margin-bottom:10px;">üõí</span>
                        Escanea o selecciona productos
                    </div>
                </div>
                <div class="cart-footer">
                    <div class="total-row">
                        <span class="total-label">Total a Pagar</span>
                        <span class="total-amount">$<span id="total-precio">0</span></span>
                    </div>
                    <div class="payment-buttons">
                        <button class="btn btn-cash" onclick="iniciarCobro('efectivo')">üíµ Efec.</button>
                        <button class="btn btn-mixed" onclick="iniciarCobro('mixto')">‚öñÔ∏è Mixto</button>
                        <button class="btn btn-transfer" onclick="iniciarCobro('transferencia')">üè¶ Transf.</button>
                    </div>
                </div>
            </aside>
        </div>

        <div id="drag-handle" title="Arrastra para cambiar tama√±o"></div>

        <div class="bottom-section">
            <div class="panel-card">
                <div class="panel-header">
                    <span>üìë Historial de Hoy</span>
                    <button onclick="cargarHistorial()" style="border:none; background:none; color:var(--primary); cursor:pointer; font-weight:600;">üîÑ Refrescar</button>
                </div>
                <div class="table-container">
                    <table id="tabla-ventas">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Cliente</th>
                                <th>M√©todo</th>
                                <th>Detalle</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-ventas"></tbody>
                    </table>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-header">üí∞ Arqueo de Caja</div>
                <div class="summary-card">
                    <div class="sum-row">
                        <span>En Caja (Efectivo):</span>
                        <span id="sum-efectivo" style="font-weight:600; color:#166534;">$0</span>
                    </div>
                    <div class="sum-row">
                        <span>En Banco (Transf.):</span>
                        <span id="sum-transferencia" style="font-weight:600; color:#1e40af;">$0</span>
                    </div>
                    <div class="sum-row sum-total">
                        <span>VENTA TOTAL:</span>
                        <span id="sum-total">$0</span>
                    </div>
                </div>
                <p style="font-size:0.75rem; color:var(--secondary); margin-top:10px; text-align:center; line-height:1.4;">
                    * Calcula autom√°ticamente los pagos mixtos.
                </p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyCH2dJRTPXpOPUhaERNAkcj_avqbEYCSXE",
            authDomain: "deliverymayorista-8c042.firebaseapp.com",
            projectId: "deliverymayorista-8c042",
            storageBucket: "deliverymayorista-8c042.firebasestorage.app",
            messagingSenderId: "98776210634",
            appId: "1:98776210634:web:6938a8cdbf497b2353e833"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- L√ìGICA DEL RESIZER (ARRASTRAR BARRA) ---
        const resizer = document.getElementById('drag-handle');
        const bottomSection = document.querySelector('.bottom-section');

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.body.style.cursor = 'ns-resize'; // Cursor forzado
            document.body.style.userSelect = 'none'; // Evitar seleccionar texto
        });

        function onMouseMove(e) {
            // Calculamos nueva altura: Altura total ventana - Posici√≥n Mouse Y
            const newHeight = window.innerHeight - e.clientY;
            
            // L√≠mites: M√≠nimo 100px, M√°ximo 80% de la pantalla
            if (newHeight > 100 && newHeight < window.innerHeight * 0.8) {
                bottomSection.style.height = newHeight + 'px';
            }
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
        // ---------------------------------------------

        let carrito = [];
        
        // RELOJ
        setInterval(() => {
            const now = new Date();
            document.getElementById('reloj').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // CARGAR PRODUCTOS
        async function cargarProductos() {
            const grid = document.getElementById('grid-productos');
            try {
                const q = query(collection(db, "productos"));
                const snapshot = await getDocs(q);
                grid.innerHTML = "";

                if(snapshot.empty) { grid.innerHTML = "Sin productos."; return; }

                snapshot.forEach(doc => {
                    const p = doc.data();
                    p.id = doc.id;
                    const imgUrl = p.imagenUrl ? p.imagenUrl : 'https://placehold.co/400x300?text=Sin+Foto';

                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="${imgUrl}" class="card-img" onerror="this.onerror=null;this.src='https://placehold.co/400x300?text=Sin+Foto';">
                        <h3>${p.nombre}</h3>
                        <div class="stock-badge">Stock: ${p.stock || 0}</div>
                        <div style="flex:1"></div>
                        <div class="price">$${p.precio}</div>
                    `;
                    div.onclick = () => agregarAlCarrito(p);
                    grid.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                grid.innerHTML = "Error de conexi√≥n o permisos.";
            }
        }

        // CARRITO
        window.agregarAlCarrito = (p) => {
            const existe = carrito.find(i => i.id === p.id);
            if(existe) existe.cantidad++;
            else carrito.push({ ...p, cantidad: 1 });
            renderCarrito();
        }

        window.eliminarItem = (idx) => {
            carrito.splice(idx, 1);
            renderCarrito();
        }

        function renderCarrito() {
            const lista = document.getElementById('lista-carrito');
            const totalSpan = document.getElementById('total-precio');
            lista.innerHTML = "";
            let total = 0;

            carrito.forEach((item, idx) => {
                const sub = item.precio * item.cantidad;
                total += sub;
                const row = document.createElement('div');
                row.className = 'cart-item';
                row.innerHTML = `
                    <div>
                        <strong>${item.nombre}</strong><br>
                        <span style="color:var(--secondary)">${item.cantidad} x $${item.precio}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <b>$${sub}</b>
                        <span style="color:#ef4444; cursor:pointer; font-weight:bold;" onclick="eliminarItem(${idx})">‚úï</span>
                    </div>
                `;
                lista.appendChild(row);
            });

            if(carrito.length === 0) lista.innerHTML = `<div style="text-align:center; color:var(--secondary); margin-top:40px; font-size:0.9rem;">
                        <span style="display:block; font-size:2rem; margin-bottom:10px;">üõí</span>
                        Escanea o selecciona productos
                    </div>`;
            
            totalSpan.innerText = total.toLocaleString();
            return total;
        }

        // COBRO
        window.iniciarCobro = async (metodo) => {
            if(carrito.length === 0) return alert("Carrito vac√≠o");
            const total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);

            let datosVenta = {
                items: carrito,
                total: total,
                metodo: metodo,
                fecha: serverTimestamp(),
                cliente: { nombre: "Consumidor Final", telefono: "" }
            };

            if(metodo === 'efectivo') {
                const pagoStr = prompt(`Total: $${total}\n¬øCon cu√°nto paga?`);
                if(!pagoStr) return;
                const pago = parseFloat(pagoStr);
                if(isNaN(pago) || pago < total) return alert("Monto insuficiente");
                if(!confirm(`Vuelto: $${pago - total}\n¬øConfirmar?`)) return;
                datosVenta.pago_cliente = pago;
            }

            if(metodo === 'transferencia') {
                const nombre = prompt("Nombre del Cliente (Obligatorio):");
                if(!nombre) return alert("Falta nombre");
                datosVenta.cliente.nombre = nombre;
                datosVenta.cliente.telefono = prompt("Tel√©fono (Opcional):") || "";
            }

            if(metodo === 'mixto') {
                const nombre = prompt("Nombre del Cliente (Obligatorio):");
                if(!nombre) return alert("Falta nombre");
                datosVenta.cliente.nombre = nombre;
                datosVenta.cliente.telefono = prompt("Tel√©fono (Opcional):") || "";

                const cashStr = prompt(`Total: $${total}\n\n¬øCu√°nto paga en EFECTIVO?`);
                if(cashStr === null) return;
                const cash = parseFloat(cashStr);
                if(isNaN(cash) || cash >= total || cash < 0) return alert("Monto en efectivo inv√°lido.");
                const transfer = total - cash;
                if(!confirm(`CONFIRMAR PAGO MIXTO:\n\nüíµ Efectivo: $${cash}\nüè¶ Transferencia: $${transfer}\n\nTotal: $${total}`)) return;
                datosVenta.info_mixto = { efectivo: cash, transferencia: transfer };
            }

            try {
                await addDoc(collection(db, "ventas"), datosVenta);
                alert("‚úÖ Venta Guardada");
                carrito = [];
                renderCarrito();
                cargarHistorial();
            } catch (e) {
                console.error(e);
                alert("Error guardando venta. Revisa la consola.");
            }
        };

        // HISTORIAL
        window.cargarHistorial = async () => {
            const tbody = document.getElementById('tbody-ventas');
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            
            try {
                const q = query(collection(db, "ventas"), where("fecha", ">=", Timestamp.fromDate(hoy)), orderBy("fecha", "desc"));
                const snap = await getDocs(q);
                
                tbody.innerHTML = "";
                let sumEfectivo = 0;
                let sumTransfer = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    const hora = d.fecha ? d.fecha.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                    
                    let detallePago = "-";
                    let claseBadge = "";
                    let textoBadge = "";

                    if(d.metodo === 'efectivo') {
                        sumEfectivo += d.total;
                        claseBadge = "bg-cash"; textoBadge = "Efectivo";
                    } else if (d.metodo === 'transferencia') {
                        sumTransfer += d.total;
                        claseBadge = "bg-trans"; textoBadge = "Transf.";
                    } else if (d.metodo === 'mixto') {
                        const efec = d.info_mixto?.efectivo || 0;
                        const trans = d.info_mixto?.transferencia || 0;
                        sumEfectivo += efec;
                        sumTransfer += trans;
                        claseBadge = "bg-mix"; textoBadge = "Mixto";
                        detallePago = `<span style="font-size:0.75rem">üíµ${efec} / üè¶${trans}</span>`;
                    }

                    const row = `
                        <tr>
                            <td>${hora}</td>
                            <td>${d.cliente.nombre}</td>
                            <td><span class="badge ${claseBadge}">${textoBadge}</span></td>
                            <td>${detallePago}</td>
                            <td style="font-weight:bold;">$${d.total}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('sum-efectivo').innerText = `$${sumEfectivo.toLocaleString()}`;
                document.getElementById('sum-transferencia').innerText = `$${sumTransfer.toLocaleString()}`;
                document.getElementById('sum-total').innerText = `$${(sumEfectivo + sumTransfer).toLocaleString()}`;

            } catch (e) {
                console.error(e);
            }
        }

        cargarProductos();
        cargarHistorial();

    </script>
</body>
</html>
