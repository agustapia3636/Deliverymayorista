<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta | Delivery Mayorista</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff;
            --primary: #2563eb; --secondary: #64748b;
            --success: #10b981; --mixed: #8b5cf6; --danger: #ef4444;
            --text-main: #1e293b; --border: #cbd5e1;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        header { background: var(--bg-card); padding: 8px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 10; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        header h1 { margin: 0; font-size: 1.1rem; color: var(--primary); font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .search-box { background: #f8fafc; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 6px; width: 300px; display: flex; align-items: center; transition: all 0.2s; }
        .search-box:focus-within { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .search-box input { border: none; background: transparent; outline: none; width: 100%; font-size: 0.9rem; margin-left: 8px; }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .btn-header { background: #e2e8f0; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; color: var(--text-main); display: flex; align-items: center; gap: 5px; font-size: 0.85rem; transition: 0.2s; }
        .btn-header:hover { background: #cbd5e1; }
        .btn-historial { background: #e0f2fe; color: #0284c7; } .btn-historial:hover { background: #bae6fd; }
        .date-display { font-size: 0.85rem; color: var(--secondary); font-weight: 500; background: #f1f5f9; padding: 5px 12px; border-radius: 20px; }

        .main-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        .left-column { flex: 1; display: flex; flex-direction: column; min-width: 200px; overflow: hidden; transition: all 0.3s ease; }
        .right-column { width: 380px; min-width: 280px; display: flex; flex-direction: column; overflow: hidden; background: white; border-left: 1px solid var(--border); transition: all 0.3s ease; }
        .panel-top { flex: 1; overflow: hidden; padding: 15px; display: flex; flex-direction: column; }
        .panel-bottom { height: 240px; min-height: 100px; overflow: hidden; display: flex; flex-direction: column; background: white; border-top: 1px solid var(--border); transition: height 0.3s ease; }
        
        .fullscreen-mode .panel-bottom { display: none !important; }
        .fullscreen-mode .resizer-horiz { display: none !important; }

        .resizer-vert-main { width: 8px; background: transparent; cursor: ew-resize; flex-shrink: 0; display: flex; align-items: center; justify-content: center; z-index: 5; margin-left: -4px; }
        .resizer-horiz { height: 8px; background: transparent; cursor: ns-resize; display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 5; margin-top: -4px; }

        .catalog-container { flex: 1; overflow-y: auto; padding-right: 5px; }
        .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; padding-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 8px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; height: 100%; align-items: center; text-align: center; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 90px; object-fit: contain; background: #fff; margin-bottom: 5px; flex-shrink: 0; }
        .card h3 { font-size: 0.85rem; margin: 0 0 4px; line-height: 1.3; font-weight: 600; color: #334155; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; max-height: 3.9em; }
        .price { font-weight: 800; color: var(--text-main); font-size: 1rem; margin-top: auto; }
        .stock-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 6px; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .stock-critico { background: #fee2e2; color: #dc2626; } .stock-bajo { background: #ffedd5; color: #c2410c; } .stock-ok { background: #ecfdf5; color: #047857; }

        .cart-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .cart-header { padding: 10px 15px; font-weight: 700; background: #f8fafc; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .cart-items { flex: 1; overflow-y: auto; padding: 0 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .qty-controls { display: flex; align-items: center; gap: 5px; background: #f1f5f9; border-radius: 4px; padding: 2px; width: fit-content; margin-top: 4px; }
        .qty-btn { width: 22px; height: 22px; border: none; background: white; cursor: pointer; border-radius: 4px; font-weight: bold; color: var(--secondary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .qty-btn:hover { background: var(--primary); color: white; }
        .cart-footer { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); }
        .total-amount { font-size: 1.8rem; font-weight: 800; color: #0f172a; display: block; text-align: right; margin-bottom: 10px; }
        .payment-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn { border: none; padding: 12px 0; border-radius: 6px; font-weight: 700; cursor: pointer; color: white; font-size: 0.85rem; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-cash { background: var(--success); } .btn-transfer { background: var(--primary); } .btn-mixed { background: var(--mixed); }

        .panel-header { padding: 8px 15px; font-weight: 600; background: #f8fafc; border-bottom: 1px solid var(--border); font-size: 0.85rem; color: var(--secondary); display: flex; justify-content: space-between; align-items: center; }
        .table-container { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        thead { background: white; position: sticky; top: 0; z-index: 2; }
        th { text-align: left; padding: 8px 15px; color: var(--secondary); font-weight: 600; border-bottom: 1px solid #e2e8f0; }
        td { padding: 6px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .client-phone { display: block; font-size: 0.7rem; color: var(--secondary); }
        .sum-row { display: flex; justify-content: space-between; font-size: 0.9rem; color: #475569; margin-bottom: 5px; }
        .sum-total { margin-top: 10px; padding-top: 10px; border-top: 2px dashed #e2e8f0; font-weight: 800; font-size: 1.2rem; color: #0f172a; display: flex; justify-content: space-between; }
        .btn-close-box { background: #fee2e2; color: #dc2626; border: none; padding: 10px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-close-box:hover { background: #dc2626; color: white; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; transform: translateY(10px); transition: transform 0.2s; position: relative; }
        .modal-overlay.active .modal-card { transform: translateY(0); }
        .modal-header-hero { padding: 20px; text-align: center; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .modal-header-hero h2 { margin: 0; font-size: 0.9rem; text-transform: uppercase; color: #64748b; letter-spacing: 1px; }
        .modal-price-hero { font-size: 2.5rem; font-weight: 800; color: #1e293b; margin: 5px 0 0; }
        .modal-body { padding: 20px; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1.1rem; outline: none; box-sizing: border-box; }
        .input-field:focus { border-color: var(--primary); }
        .modal-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; }
        .btn-modal-cancel { background: white; border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; color: #475569; }
        .btn-modal-confirm { background: #1e293b; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .theme-cash .btn-confirm { background: var(--success); } .theme-trans .btn-confirm { background: var(--primary); } .theme-mixed .btn-confirm { background: var(--mixed); }
        .vuelto-box { margin-top: 10px; background: #dcfce7; color: #166534; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 1rem; display: none; }
        .hidden { display: none; }

        #alertModal .modal-card, #confirmModal .modal-card { max-width: 350px; text-align: center; }
        
        #reporteModal { align-items: flex-start; padding-top: 20px; overflow-y: auto; }
        .report-toolbar { background: white; padding: 10px; border-radius: 8px; display: flex; gap: 10px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 600px; justify-content: center; }
        .report-btn { padding: 8px 15px; border-radius: 6px; border: none; font-weight: bold; color: white; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .btn-print { background: #64748b; } .btn-dl { background: #0d9488; } .btn-close-day { background: #ef4444; }
        .close-x { position: absolute; right: 15px; top: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        .report-paper { background: white; width: 600px; padding: 40px; border-radius: 4px; min-height: 600px; font-family: 'Segoe UI', serif; color: #333; position: relative; margin-bottom: 50px; }
        .report-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
        .report-section h4 { border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; color: var(--secondary); font-size: 0.8rem; text-transform: uppercase; }
        .row-detail { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .row-detail.total { font-weight: 800; font-size: 1.2rem; border-top: 1px solid #000; padding-top: 5px; margin-top: 10px; }
        .audit-ok { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .audit-fail { background: #fee2e2; color: #dc2626; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        #historialCierresModal .modal-card { max-width: 800px; width: 95%; }
        #historialTable { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        #historialTable th { background: #f1f5f9; padding: 10px; text-align: left; }
        #historialTable td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

        @media (max-width: 900px) { .main-wrapper { display: block; overflow: auto; } .left-column, .right-column { width: 100%!important; height: auto!important; } .resizer-horiz, .resizer-vert-main { display: none; } .panel-top, .panel-bottom { height: auto!important; min-height: 300px; margin-bottom: 20px; } .search-box { width: 150px; } .close-x { right: 5px; top: 5px; } }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <h1>üì¶ Delivery Mayorista</h1>
            <div class="search-box"><span>üîç</span><input type="text" id="buscador" placeholder="Buscar..." onkeyup="filtrarProductos()"></div>
        </div>
        <div class="header-controls">
            <button class="btn-header btn-historial" onclick="abrirHistorialCierres()">üìú Historial Cierres</button>
            <button class="btn-header btn-toggle" onclick="togglePaneles()">üëÅÔ∏è Ocultar Paneles</button>
            <div class="date-display" id="reloj">--:--</div>
        </div>
    </header>

    <div class="main-wrapper" id="mainWrapper">
        <div class="left-column">
            <div class="panel-top">
                <div class="catalog-container"><div id="grid-productos" class="grid-products"></div></div>
            </div>
            <div class="resizer-horiz"></div>
            <div class="panel-bottom" id="historyPanel">
                 <div class="panel-header"><span>üìë Historial Hoy</span><button onclick="cargarHistorial()" style="border:none; background:none; cursor:pointer;">üîÑ</button></div>
                 <div class="table-container">
                    <table id="tabla-ventas"><thead><tr><th>Hora</th><th>Cliente</th><th>Pago</th><th>Total</th></tr></thead><tbody id="tbody-ventas"></tbody></table>
                 </div>
            </div>
        </div>
        <div class="resizer-vert-main"></div>
        <div class="right-column" id="rightColumn">
            <div class="panel-top">
                <div class="cart-panel">
                    <div class="cart-header">Orden Actual</div>
                    <div class="cart-items" id="lista-carrito"><div style="text-align:center; color:var(--secondary); margin-top:40px;">Carrito vac√≠o</div></div>
                    <div class="cart-footer">
                        <div class="total-amount">$<span id="total-precio">0</span></div>
                        <div class="payment-buttons">
                            <button class="btn btn-cash" onclick="abrirModalPago('efectivo')">üíµ Efec.</button>
                            <button class="btn btn-mixed" onclick="abrirModalPago('mixto')">‚öñÔ∏è Mixto</button>
                            <button class="btn btn-transfer" onclick="abrirModalPago('transferencia')">üè¶ Transf.</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resizer-horiz"></div>
            <div class="panel-bottom" id="summaryPanel">
                <div class="panel-header">üí∞ Caja</div>
                <div class="summary-content">
                    <div class="sum-row"><span>Efectivo:</span><span id="sum-efectivo">0</span></div>
                    <div class="sum-row"><span>Transferencia:</span><span id="sum-transferencia">0</span></div>
                    <div class="sum-total"><span>TOTAL:</span><span id="sum-total">0</span></div>
                    <button class="btn-close-box" onclick="iniciarCierreCaja()">üîí CERRAR CAJA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalPago" class="modal-overlay">
        <div class="modal-card" id="modalCard">
            <div class="modal-header-hero">
                <h2 id="modalPagoTitle">COBRO</h2>
                <div class="modal-price-hero">$<span id="modalPagoTotal">0</span></div>
                <div id="infoDinamico" style="font-size:0.9rem; color:var(--success); font-weight:bold; height:20px;"></div>
            </div>
            <div class="modal-body">
                <div id="grpMonto" class="input-group">
                    <label class="input-label" id="lblMonto">Monto Efectivo</label>
                    <input type="number" id="inpMonto" class="input-field" oninput="calcularDinamico()">
                </div>
                <div id="grpCliente" class="input-group hidden">
                    <label class="input-label">Cliente</label>
                    <input type="text" id="inpNombre" class="input-field" placeholder="Nombre (Obligatorio)" style="margin-bottom:8px;">
                    <input type="text" id="inpTel" class="input-field" placeholder="Tel√©fono">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="cerrarModales()">Cancelar</button>
                <button class="btn-modal-confirm" onclick="procesarPago()">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modalAlert" class="modal-overlay"><div class="modal-card"><div class="modal-body" style="text-align:center; padding-top:30px;"><div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div><div id="alertMsg" style="font-weight:bold;">Mensaje</div></div><div class="modal-footer" style="display:block; text-align:center;"><button class="btn-modal-confirm" onclick="document.getElementById('modalAlert').classList.remove('active')">ENTENDIDO</button></div></div></div>
    <div id="modalConfirm" class="modal-overlay"><div class="modal-card"><div class="modal-body" style="text-align:center;"><h3 id="confirmTitle" style="margin-bottom:10px;">Confirmar</h3><p id="confirmMsg" style="color:#64748b;">¬øSeguro?</p></div><div class="modal-footer"><button class="btn-modal-cancel" onclick="document.getElementById('modalConfirm').classList.remove('active')">Cancelar</button><button class="btn-modal-confirm" id="btnConfirmYes">SI, CONFIRMAR</button></div></div></div>

    <div id="modalArqueo" class="modal-overlay"><div class="modal-card"><div class="modal-header-hero" style="background:#fef2f2;"><h2 style="color:var(--danger);">‚ö†Ô∏è ARQUEO DE CAJA</h2></div><div class="modal-body"><label class="input-label">¬øCu√°nto efectivo hay en el caj√≥n?</label><input type="number" id="inpCajaReal" class="input-field" style="font-size:1.5rem; text-align:center;" placeholder="$ 0"></div><div class="modal-footer"><button class="btn-modal-cancel" onclick="cerrarModales()">Cancelar</button><button class="btn-modal-confirm" style="background:var(--danger);" onclick="generarReporte()">VER REPORTE</button></div></div></div>
    
    <div id="modalReporte" class="modal-overlay" style="background:rgba(20,20,20,0.9); overflow-y:auto;">
        <div class="report-container">
            <button class="close-x" onclick="cerrarModales()">√ó</button>
            <div class="report-paper" id="documentoImprimir">
                <div class="report-header"><div><div class="brand-title">FIXEDD<span class="brand-span">POS</span></div><div style="font-size:0.9rem;">Reporte Oficial de Cierre</div></div><div class="report-meta"><div class="report-tag">ID #<span id="repId">000</span></div><div id="repFecha">--/--</div></div></div>
                <div class="report-section"><h4>Resumen</h4><div class="row-detail"><span>Efectivo:</span><span id="repEfec">$0</span></div><div class="row-detail"><span>Transf:</span><span id="repTrans">$0</span></div><div class="row-detail total"><span>TOTAL:</span><span id="repTotal">$0</span></div></div>
                <div class="report-section"><h4>Auditor√≠a</h4><div class="row-detail"><span>Sistema:</span><span id="audEsp">$0</span></div><div class="row-detail"><span>Declarado:</span><span id="audReal">$0</span></div><div class="row-detail total"><span>DIFERENCIA:</span><span id="audDif">$0</span></div><div style="text-align:right; margin-top:5px;"><span id="audBadge"></span></div></div>
            </div>
            <div class="report-actions-bar"><button class="report-btn btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button><button class="report-btn btn-dl" onclick="descargarPDF()">üì• PDF</button><button class="report-btn btn-close-day" onclick="confirmarCierreFinal()">üîí CERRAR D√çA</button></div>
        </div>
    </div>

    <div id="historialCierresModal" class="modal-overlay"><div class="modal-card"><div class="modal-header-hero"><h2>HISTORIAL CIERRES</h2><button class="close-x" style="top:10px; right:15px; font-size:1.2rem; position:absolute;" onclick="cerrarModales()">√ó</button></div><div class="modal-body" style="max-height:400px; overflow-y:auto; padding:0;"><table id="historialTable"><thead><tr><th>Fecha</th><th>Efec.</th><th>Total</th></tr></thead><tbody id="tbody-cierres"></tbody></table></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, where, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCH2dJRTPXpOPUhaERNAkcj_avqbEYCSXE", authDomain: "deliverymayorista-8c042.firebaseapp.com", projectId: "deliverymayorista-8c042", storageBucket: "deliverymayorista-8c042.firebasestorage.app", messagingSenderId: "98776210634", appId: "1:98776210634:web:6938a8cdbf497b2353e833" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let carrito = []; let listaProductos = []; 
        let totalDiaEfectivo = 0, totalDiaTransf = 0, totalDiaGeneral = 0; let totalRaw = 0; let pagoMode = "";
        let panelesVisibles = true;

        setInterval(() => document.getElementById('reloj').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 1000);

        window.customAlert = (msg) => { document.getElementById('alertMsg').innerText = msg; document.getElementById('modalAlert').classList.add('active'); };
        window.customConfirm = (title, msg, callback) => {
            document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmMsg').innerText = msg;
            const btn = document.getElementById('btnConfirmYes');
            btn.onclick = () => { document.getElementById('modalConfirm').classList.remove('active'); callback(); };
            document.getElementById('modalConfirm').classList.add('active');
        };
        window.cerrarModales = () => { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); };
        window.togglePaneles = () => {
            panelesVisibles = !panelesVisibles;
            document.getElementById('mainWrapper').classList.toggle('fullscreen-mode');
            document.querySelector('.btn-toggle').innerHTML = panelesVisibles ? "üëÅÔ∏è Ocultar Paneles" : "üëÅÔ∏è Mostrar Paneles";
        };

        async function cargarProductos() {
            try { const q = query(collection(db, "productos")); const snap = await getDocs(q); listaProductos = []; snap.forEach(d => listaProductos.push({...d.data(), id: d.id})); renderCatalogo(listaProductos); } 
            catch(e){ document.getElementById('grid-products').innerHTML = `<p style="color:red;padding:20px;">ERROR: ${e.message}</p>`; }
        }
        function renderCatalogo(lista) {
            const grid = document.querySelector('.grid-products'); grid.innerHTML = "";
            lista.forEach(p => {
                let stock = 0;
                if(p.stock !== undefined) stock = p.stock;
                else if(p.Stock !== undefined) stock = p.Stock;
                else if(p.cantidad !== undefined) stock = p.cantidad;
                else if(p.Cantidad !== undefined) stock = p.Cantidad;
                else if(p.qty !== undefined) stock = p.qty;

                const img = p.imagenUrl || 'https://placehold.co/200x150?text=Sin+Foto';
                const div = document.createElement('div'); div.className = 'card';
                div.innerHTML = `<img src="${img}" class="card-img"><h3>${p.nombre}</h3><div style="flex:1"></div><div class="stock-badge ${stock==0?'stock-critico':'stock-ok'}">Stock: ${stock}</div><div class="price">$${p.precio}</div>`;
                div.onclick = () => addCart(p);
                document.querySelector('.grid-products').appendChild(div);
            });
        }
        window.filtrarProductos = () => { renderCatalogo(listaProductos.filter(p => p.nombre.toLowerCase().includes(document.getElementById('buscador').value.toLowerCase()))); };

        window.addCart = (p) => {
            const ex = carrito.find(i => i.id === p.id); if(ex) ex.cantidad++; else carrito.push({...p, cantidad: 1});
            if(document.getElementById('buscador').value) { document.getElementById('buscador').value=""; renderCatalogo(listaProductos); }
            renderCart();
        };
        window.modQty = (i, delta) => { carrito[i].cantidad += delta; if(carrito[i].cantidad <= 0) carrito.splice(i,1); renderCart(); };
        window.eliminarItem = (i) => { carrito.splice(i,1); renderCart(); };

        function renderCart() {
            const list = document.getElementById('lista-carrito'); list.innerHTML = ""; let t = 0;
            carrito.forEach((p, i) => {
                t += p.precio * p.cantidad;
                list.innerHTML += `<div class="cart-item"><div><b>${p.nombre}</b><br><div class="qty-controls"><button class="qty-btn" onclick="modQty(${i},-1)">-</button><span class="qty-val">${p.cantidad}</span><button class="qty-btn" onclick="modQty(${i},1)">+</button><small>x $${p.precio}</small></div></div><div style="text-align:right"><b>$${(p.precio*p.cantidad).toLocaleString('es-AR')}</b><br><span style="color:var(--danger);cursor:pointer;font-size:0.8rem;" onclick="eliminarItem(${i})">Eliminar</span></div></div>`;
            });
            totalRaw = t; document.getElementById('total-precio').innerText = t.toLocaleString('es-AR');
            if(carrito.length===0) list.innerHTML = `<div style="text-align:center;margin-top:40px;color:gray">Carrito vac√≠o</div>`;
        }

        window.abrirModalPago = (metodo) => {
            if(carrito.length===0) return customAlert("Carrito vac√≠o");
            pagoMode = metodo;
            document.getElementById('modalPagoTotal').innerText = totalRaw.toLocaleString('es-AR');
            document.getElementById('inpMonto').value = ""; document.getElementById('inpNombre').value = ""; document.getElementById('inpTel').value = ""; document.getElementById('infoDinamico').innerHTML = "";
            const grpM = document.getElementById('grpMonto'); const grpC = document.getElementById('grpCliente');
            
            if(metodo === 'efectivo') { grpM.style.display='block'; grpC.style.display='none'; document.getElementById('lblMonto').innerText = "¬øCon cu√°nto paga?"; }
            else if(metodo === 'transferencia') { grpM.style.display='none'; grpC.style.display='block'; }
            else { grpM.style.display='block'; grpC.style.display='block'; document.getElementById('lblMonto').innerText = "Parte en EFECTIVO"; }
            
            document.getElementById('modalPago').classList.add('active');
            setTimeout(() => (metodo==='transferencia' ? document.getElementById('inpNombre') : document.getElementById('inpMonto')).focus(), 100);
        };

        window.calcularDinamico = () => {
            const val = parseFloat(document.getElementById('inpMonto').value) || 0;
            const info = document.getElementById('infoDinamico');
            if(pagoMode === 'efectivo') {
                if(val >= totalRaw) info.innerHTML = `VUELTO: $${(val - totalRaw).toLocaleString('es-AR')}`;
                else info.innerHTML = "";
            } else if(pagoMode === 'mixto') {
                if(val < totalRaw && val > 0) info.innerHTML = `FALTA TRANSF: $${(totalRaw - val).toLocaleString('es-AR')}`;
                else info.innerHTML = "";
            }
        };

        window.procesarPago = async () => {
            const nom = document.getElementById('inpNombre').value; const tel = document.getElementById('inpTel').value;
            let data = { items: carrito, total: totalRaw, metodo: pagoMode, fecha: serverTimestamp(), cliente: {nombre: nom||"Consumidor Final", telefono: tel||""} };

            if(pagoMode === 'efectivo') {
                const pago = parseFloat(document.getElementById('inpMonto').value);
                if(!pago || pago < totalRaw) return customAlert("Monto insuficiente");
                data.pago_cliente = pago;
            } else if(pagoMode === 'transferencia') {
                if(!nom) return customAlert("Nombre obligatorio");
                cerrarModales();
                return customConfirm("CONFIRMAR TRANSFERENCIA", `Cliente: ${nom}\nMonto: $${totalRaw.toLocaleString('es-AR')}\n\n¬øEst√° acreditado?`, () => guardarVenta(data));
            } else if(pagoMode === 'mixto') {
                const efec = parseFloat(document.getElementById('inpMonto').value);
                if(!efec || efec >= totalRaw || efec <= 0) return customAlert("Monto efectivo inv√°lido");
                if(!nom) return customAlert("Nombre obligatorio");
                data.info_mixto = { efectivo: efec, transferencia: totalRaw - efec };
                cerrarModales();
                return customConfirm("PAGO MIXTO", `Efectivo: $${efec}\nTransf: $${totalRaw-efec}\n\n¬øConfirmar?`, () => guardarVenta(data));
            }
            guardarVenta(data);
        };

        async function guardarVenta(data) {
            try {
                await addDoc(collection(db, "ventas"), data);
                carrito = []; renderCart(); cargarHistorial(); cerrarModales();
                customAlert("‚úÖ Venta Exitosa");
            } catch(e) { customAlert("Error al guardar (Permisos): " + e.message); }
        }

        window.iniciarCierreCaja = () => {
            if(totalDiaGeneral === 0) return customAlert("Caja en 0");
            document.getElementById('inpCajaReal').value = "";
            document.getElementById('modalArqueo').classList.add('active');
            setTimeout(()=>document.getElementById('inpCajaReal').focus(),100);
        };

        window.generarReporte = () => {
            const real = parseFloat(document.getElementById('inpCajaReal').value) || 0;
            const dif = real - totalDiaEfectivo;
            document.getElementById('repId').innerText = Math.floor(Math.random()*9999);
            document.getElementById('repFecha').innerText = new Date().toLocaleDateString();
            document.getElementById('repHora').innerText = new Date().toLocaleTimeString();
            document.getElementById('repEfec').innerText = "$" + totalDiaEfectivo.toLocaleString('es-AR');
            document.getElementById('repTrans').innerText = "$" + totalDiaTransf.toLocaleString('es-AR');
            document.getElementById('repTotal').innerText = "$" + totalDiaGeneral.toLocaleString('es-AR');
            document.getElementById('audEsp').innerText = "$" + totalDiaEfectivo.toLocaleString('es-AR');
            document.getElementById('audReal').innerText = "$" + real.toLocaleString('es-AR');
            document.getElementById('audDif').innerText = "$" + dif.toLocaleString('es-AR');
            const badge = document.getElementById('audBadge');
            if(dif === 0) { badge.innerText = "EXACTO"; badge.className = "badge-audit audit-ok"; }
            else { badge.innerText = dif > 0 ? "SOBRANTE" : "FALTANTE"; badge.className = dif > 0 ? "badge-audit audit-ok" : "badge-audit audit-fail"; }
            cerrarModales();
            document.getElementById('modalReporte').classList.add('active');
        };

        window.confirmarCierreFinal = async () => {
            if(!confirm("¬øSeguro que deseas cerrar el turno? Esto borrar√° el historial de hoy.")) return;
            const btn = document.querySelector('.btn-close-day'); btn.disabled = true; btn.innerText = "CERRANDO...";
            try { await addDoc(collection(db, "cierres_caja"), { fecha: serverTimestamp(), total_efectivo: totalDiaEfectivo, total_transferencia: totalDiaTransf, total_general: totalDiaGeneral, usuario: "Cajero" }); window.location.reload(); } catch(e) { alert("Error: " + e.message); btn.disabled = false; btn.innerText = "REINTENTAR"; }
        };

        window.descargarPDF = () => { html2pdf().from(document.getElementById('hojaReporte')).save("Cierre.pdf"); };

        window.cargarHistorial = async () => {
            const q = query(collection(db, "ventas"), where("fecha", ">=", Timestamp.fromDate(new Date(new Date().setHours(0,0,0,0)))), orderBy("fecha", "desc"));
            const snap = await getDocs(q); const tb = document.getElementById('tbody-ventas'); tb.innerHTML = ""; totalDiaEfectivo=0; totalDiaTransf=0;
            snap.forEach(d => { const dt = d.data();
                if(dt.metodo==='efectivo') totalDiaEfectivo += dt.total; else if(dt.metodo==='transferencia') totalDiaTransf += dt.total; else { totalDiaEfectivo += dt.info_mixto.efectivo; totalDiaTransf += dt.info_mixto.transferencia; }
                const hora = dt.fecha.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const tel = dt.cliente.telefono ? `<span class="client-phone">üìû${dt.cliente.telefono}</span>` : "";
                tb.innerHTML += `<tr><td>${hora}</td><td>${dt.cliente.nombre}${tel}</td><td>${dt.metodo}</td><td>$${dt.total.toLocaleString('es-AR')}</td></tr>`;
            });
            totalDiaGeneral = totalDiaEfectivo + totalDiaTransf;
            document.getElementById('sum-efectivo').innerText = `$${totalDiaEfectivo.toLocaleString('es-AR')}`;
            document.getElementById('sum-transferencia').innerText = `$${totalDiaTransf.toLocaleString('es-AR')}`;
            document.getElementById('sum-total').innerText = `$${totalDiaGeneral.toLocaleString('es-AR')}`;
        };

        window.abrirHistorialCierres = async () => {
            const modal = document.getElementById('historialCierresModal');
            const tbody = document.getElementById('tbody-cierres'); tbody.innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";
            modal.classList.add('active');
            try {
                const q = query(collection(db, "cierres_caja"), orderBy("fecha", "desc"), limit(10));
                const snap = await getDocs(q); tbody.innerHTML = "";
                snap.forEach(doc => { const d = doc.data();
                    const fecha = d.fecha.toDate().toLocaleString();
                    tbody.innerHTML += `<tr><td>${fecha}</td><td>$${d.total_efectivo}</td><td><b>$${d.total_general}</b></td></tr>`;
                });
            } catch(e) { tbody.innerHTML = "<tr><td colspan='4'>Error cargando historial</td></tr>"; }
        };

        const r1 = document.querySelector('.resizer-horiz');
        const r2 = document.querySelector('.resizer-vert-main');
        const r3 = document.querySelectorAll('.resizer-horiz')[1];
        const makeResizer = (resizer, type, target) => {
            resizer.onmousedown = (e) => {
                e.preventDefault();
                document.onmousemove = (e) => {
                    if(type === 'h') {
                        const h = window.innerHeight - e.clientY;
                        if(h > 50) target.style.height = h + 'px';
                    } else {
                        const w = window.innerWidth - e.clientX;
                        if(w > 200) target.style.width = w + 'px';
                    }
                };
                document.onmouseup = () => document.onmousemove = null;
            };
        };
        makeResizer(r1, 'h', document.getElementById('historyPanel'));
        makeResizer(r2, 'v', document.getElementById('rightColumn'));
        makeResizer(r3, 'h', document.getElementById('summaryPanel'));

        cargarProductos(); cargarHistorial();
    </script>
</body>
</html>
