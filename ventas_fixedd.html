<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Delivery Mayorista - V3</title>
    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --primary: #2563eb; 
            --secondary: #64748b;
            --success: #10b981; 
            --mixed: #8b5cf6; /* Color violeta para Mixto */
            --text-main: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER */
        header {
            background: var(--bg-card);
            padding: 15px 30px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); font-weight: 700; }
        .date-display { font-size: 0.9rem; color: var(--secondary); font-weight: 500; background: #f8fafc; padding: 5px 10px; border-radius: 20px; }

        /* CONTENEDOR PRINCIPAL */
        .main-wrapper {
            display: grid;
            grid-template-rows: 1fr auto; /* Arriba venta, Abajo historial */
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        .top-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        /* CATALOGO */
        .catalog-container {
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .grid-products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .card-img {
            width: 100%;
            height: 100px;
            object-fit: contain; /* Para que se vea toda la foto */
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .card h3 { font-size: 0.9rem; margin: 0 0 5px; line-height: 1.3; }
        .price { font-weight: 700; color: var(--text-main); font-size: 1.1rem; }
        .stock-badge { font-size: 0.75rem; color: var(--secondary); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 5px; }

        /* CARRITO (Derecha) */
        .cart-panel {
            background: var(--bg-card);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            height: 100%;
        }

        .cart-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 600; }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 0.9rem;
        }

        .cart-footer {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            border-radius: 0 0 16px 16px;
        }

        .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .total-label { color: var(--secondary); }
        .total-amount { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

        .payment-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn { border: none; padding: 12px 5px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; font-size: 0.9rem; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        
        .btn-cash { background: var(--success); }
        .btn-transfer { background: var(--primary); }
        .btn-mixed { background: var(--mixed); }

        /* --- PARTE DE ABAJO (MEJORADA) --- */
        .bottom-section {
            background: white; /* Ahora es blanco, no oscuro */
            border-top: 1px solid var(--border);
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 220px; /* Altura fija */
        }

        .panel-card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-main);
        }

        /* TABLA M√ÅS BONITA */
        .table-container { flex: 1; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead { background: #f8fafc; position: sticky; top: 0; }
        th { text-align: left; padding: 10px; color: var(--secondary); font-weight: 600; font-size: 0.8rem; border-bottom: 1px solid var(--border); }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .bg-cash { background: #dcfce7; color: #166534; }
        .bg-trans { background: #dbeafe; color: #1e40af; }
        .bg-mix { background: #f3e8ff; color: #6b21a8; }

        /* RESUMEN CAJA */
        .summary-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }
        .sum-row { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .sum-total { margin-top: 5px; padding-top: 10px; border-top: 1px solid #cbd5e1; font-weight: 800; font-size: 1.1rem; color: var(--primary); }

        @media (max-width: 900px) {
            .top-section { grid-template-columns: 1fr; overflow-y: scroll; }
            .cart-panel { height: fit-content; margin-bottom: 20px; }
            .bottom-section { grid-template-columns: 1fr; height: auto; }
            .main-wrapper { display: block; height: auto; overflow: auto; }
        }
    </style>
</head>
<body>

    <header>
        <h1>üì¶ Delivery Mayorista <span style="font-weight:400; font-size:0.8em; color:#94a3b8;">POS v3.0</span></h1>
        <div class="date-display" id="reloj">--:--</div>
    </header>

    <div class="main-wrapper">
        
        <div class="top-section">
            <div class="catalog-container">
                <div id="grid-productos" class="grid-products">
                    <p>Cargando productos...</p>
                </div>
            </div>

            <aside class="cart-panel">
                <div class="cart-header">Orden Actual</div>
                <div class="cart-items" id="lista-carrito">
                    <div style="text-align:center; color:var(--secondary); margin-top:40px;">
                        Carrito vac√≠o
                    </div>
                </div>
                <div class="cart-footer">
                    <div class="total-row">
                        <span class="total-label">Total a Pagar</span>
                        <span class="total-amount">$<span id="total-precio">0</span></span>
                    </div>
                    <div class="payment-buttons">
                        <button class="btn btn-cash" onclick="iniciarCobro('efectivo')">üíµ Efec.</button>
                        <button class="btn btn-mixed" onclick="iniciarCobro('mixto')">‚öñÔ∏è Mixto</button>
                        <button class="btn btn-transfer" onclick="iniciarCobro('transferencia')">üè¶ Transf.</button>
                    </div>
                </div>
            </aside>
        </div>

        <div class="bottom-section">
            <div class="panel-card">
                <div class="panel-header">
                    <span>üìë Historial de Hoy</span>
                    <button onclick="cargarHistorial()" style="border:none; background:none; color:var(--primary); cursor:pointer;">üîÑ Refrescar</button>
                </div>
                <div class="table-container">
                    <table id="tabla-ventas">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Cliente</th>
                                <th>M√©todo</th>
                                <th>Detalle Pago</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-ventas">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-header">üí∞ Arqueo de Caja</div>
                <div class="summary-card">
                    <div class="sum-row">
                        <span>En Caja (Efectivo):</span>
                        <span id="sum-efectivo" style="font-weight:600;">$0</span>
                    </div>
                    <div class="sum-row">
                        <span>En Banco (Transf.):</span>
                        <span id="sum-transferencia" style="font-weight:600;">$0</span>
                    </div>
                    <div class="sum-row sum-total">
                        <span>VENTA TOTAL:</span>
                        <span id="sum-total">$0</span>
                    </div>
                </div>
                <p style="font-size:0.75rem; color:var(--secondary); margin-top:10px; text-align:center;">
                    * Calcula autom√°ticamente los pagos mixtos.
                </p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCH2dJRTPXpOPUhaERNAkcj_avqbEYCSXE",
    authDomain: "deliverymayorista-8c042.firebaseapp.com",
    projectId: "deliverymayorista-8c042",
    storageBucket: "deliverymayorista-8c042.firebasestorage.app",
    messagingSenderId: "98776210634",
    appId: "1:98776210634:web:6938a8cdbf497b2353e833"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let carrito = [];
        let productosCache = [];

        // Reloj
        setInterval(() => {
            const now = new Date();
            document.getElementById('reloj').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // 1. Cargar Productos
        async function cargarProductos() {
            const grid = document.getElementById('grid-productos');
            try {
                const q = query(collection(db, "productos"));
                const snapshot = await getDocs(q);
                grid.innerHTML = "";
                productosCache = [];

                if(snapshot.empty) { grid.innerHTML = "Sin productos."; return; }

                snapshot.forEach(doc => {
                    const p = doc.data();
                    p.id = doc.id;
                    productosCache.push(p);

                    // Card de producto
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="${p.imagenUrl || 'https://via.placeholder.com/150'}" class="card-img">
                        <h3>${p.nombre}</h3>
                        <div class="stock-badge">Stock: ${p.stock || 0}</div>
                        <div style="flex:1"></div>
                        <div class="price">$${p.precio}</div>
                    `;
                    div.onclick = () => agregarAlCarrito(p);
                    grid.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                grid.innerHTML = "Error de conexi√≥n.";
            }
        }

        // 2. Carrito
        window.agregarAlCarrito = (p) => {
            const existe = carrito.find(i => i.id === p.id);
            if(existe) existe.cantidad++;
            else carrito.push({ ...p, cantidad: 1 });
            renderCarrito();
        }

        window.eliminarItem = (idx) => {
            carrito.splice(idx, 1);
            renderCarrito();
        }

        function renderCarrito() {
            const lista = document.getElementById('lista-carrito');
            const totalSpan = document.getElementById('total-precio');
            lista.innerHTML = "";
            let total = 0;

            carrito.forEach((item, idx) => {
                const sub = item.precio * item.cantidad;
                total += sub;
                const row = document.createElement('div');
                row.className = 'cart-item';
                row.innerHTML = `
                    <div>
                        <strong>${item.nombre}</strong><br>
                        <span style="color:var(--secondary)">${item.cantidad} x $${item.precio}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <b>$${sub}</b>
                        <span style="color:#ef4444; cursor:pointer;" onclick="eliminarItem(${idx})">‚úï</span>
                    </div>
                `;
                lista.appendChild(row);
            });

            if(carrito.length === 0) lista.innerHTML = `<div style="text-align:center; color:var(--secondary); margin-top:40px;">Carrito vac√≠o</div>`;
            totalSpan.innerText = total.toLocaleString();
            return total;
        }

        // 3. COBRO (CON MIXTO)
        window.iniciarCobro = async (metodo) => {
            if(carrito.length === 0) return alert("Carrito vac√≠o");
            const total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);

            let datosVenta = {
                items: carrito,
                total: total,
                metodo: metodo,
                fecha: serverTimestamp(),
                cliente: { nombre: "Consumidor Final", telefono: "" }
            };

            // L√ìGICA EFECTIVO
            if(metodo === 'efectivo') {
                const pagoStr = prompt(`Total: $${total}\n¬øCon cu√°nto paga?`);
                if(!pagoStr) return;
                const pago = parseFloat(pagoStr);
                if(isNaN(pago) || pago < total) return alert("Monto insuficiente");
                
                if(!confirm(`Vuelto: $${pago - total}\n¬øConfirmar?`)) return;
                datosVenta.pago_cliente = pago;
            }

            // L√ìGICA TRANSFERENCIA
            if(metodo === 'transferencia') {
                const nombre = prompt("Nombre del Cliente (Obligatorio para Transferencia):");
                if(!nombre) return alert("Falta nombre");
                datosVenta.cliente.nombre = nombre;
                datosVenta.cliente.telefono = prompt("Tel√©fono (Opcional):") || "";
            }

            // L√ìGICA MIXTO (NUEVO)
            if(metodo === 'mixto') {
                const nombre = prompt("Nombre del Cliente (Obligatorio para Mixto):");
                if(!nombre) return alert("Falta nombre");
                datosVenta.cliente.nombre = nombre;
                datosVenta.cliente.telefono = prompt("Tel√©fono (Opcional):") || "";

                // Preguntar cu√°nto en efectivo
                const cashStr = prompt(`Total: $${total}\n\n¬øCu√°nto paga en EFECTIVO?`);
                if(cashStr === null) return;
                const cash = parseFloat(cashStr);
                
                if(isNaN(cash) || cash >= total || cash < 0) return alert("Monto en efectivo inv√°lido.");

                const transfer = total - cash;

                if(!confirm(`CONFIRMAR PAGO MIXTO:\n\nüíµ Efectivo: $${cash}\nüè¶ Transferencia: $${transfer}\n\nTotal: $${total}`)) return;

                // Guardamos los detalles del split
                datosVenta.info_mixto = {
                    efectivo: cash,
                    transferencia: transfer
                };
            }

            // GUARDAR
            try {
                await addDoc(collection(db, "ventas"), datosVenta);
                alert("‚úÖ Venta Guardada");
                carrito = [];
                renderCarrito();
                cargarHistorial();
            } catch (e) {
                console.error(e);
                alert("Error guardando venta: " + e.message);
            }
        };

        // 4. HISTORIAL Y ARQUEO INTELIGENTE
        window.cargarHistorial = async () => {
            const tbody = document.getElementById('tbody-ventas');
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            
            try {
                const q = query(collection(db, "ventas"), where("fecha", ">=", Timestamp.fromDate(hoy)), orderBy("fecha", "desc"));
                const snap = await getDocs(q);
                
                tbody.innerHTML = "";
                let sumEfectivo = 0;
                let sumTransfer = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    const hora = d.fecha ? d.fecha.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                    
                    // C√°lculo de totales
                    let detallePago = "";
                    let claseBadge = "";
                    let textoBadge = "";

                    if(d.metodo === 'efectivo') {
                        sumEfectivo += d.total;
                        claseBadge = "bg-cash"; textoBadge = "Efectivo";
                        detallePago = "-";
                    } 
                    else if (d.metodo === 'transferencia') {
                        sumTransfer += d.total;
                        claseBadge = "bg-trans"; textoBadge = "Transf.";
                        detallePago = "-";
                    }
                    else if (d.metodo === 'mixto') {
                        // Sumar pedacitos
                        const efec = d.info_mixto?.efectivo || 0;
                        const trans = d.info_mixto?.transferencia || 0;
                        sumEfectivo += efec;
                        sumTransfer += trans;
                        
                        claseBadge = "bg-mix"; textoBadge = "Mixto";
                        detallePago = `<small>üíµ $${efec} / üè¶ $${trans}</small>`;
                    }

                    const row = `
                        <tr>
                            <td>${hora}</td>
                            <td>${d.cliente.nombre}</td>
                            <td><span class="badge ${claseBadge}">${textoBadge}</span></td>
                            <td>${detallePago}</td>
                            <td style="font-weight:bold;">$${d.total}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('sum-efectivo').innerText = `$${sumEfectivo.toLocaleString()}`;
                document.getElementById('sum-transferencia').innerText = `$${sumTransfer.toLocaleString()}`;
                document.getElementById('sum-total').innerText = `$${(sumEfectivo + sumTransfer).toLocaleString()}`;

            } catch (e) {
                console.error(e);
            }
        }

        // INIT
        cargarProductos();
        cargarHistorial();

    </script>
</body>
</html>
