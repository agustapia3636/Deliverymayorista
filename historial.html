// js/historial.js
import { auth, db } from "./firebase-init.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// ----------------------
// DOM
// ----------------------
const tituloCliente = document.getElementById("tituloCliente"); // puede ser null
const tablaHistorial = document.getElementById("tablaHistorial");
const btnLogout = document.getElementById("logoutBtn");

// ----------------------
// OBTENER ID CLIENTE DESDE LA URL
// ----------------------
const urlParams = new URLSearchParams(window.location.search);

// aceptamos ?cliente= o ?clienteId=
const clienteId =
  urlParams.get("cliente") ||
  urlParams.get("clienteId");

const clienteNombreParam = urlParams.get("nombre");

// si hay un título y viene el nombre por la URL, lo ponemos
if (tituloCliente && clienteNombreParam) {
  tituloCliente.textContent = `Historial de compras - ${clienteNombreParam}`;
}

if (!clienteId) {
  // si no hay ID, mostramos mensaje y no seguimos
  if (tablaHistorial) {
    tablaHistorial.innerHTML =
      "<tr><td colspan='6'>ID de cliente no válido.</td></tr>";
  }
}

// ----------------------
// SESIÓN
// ----------------------
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  if (clienteId) {
    await cargarHistorial();
  }
});

if (btnLogout) {
  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "login.html";
  });
}

// ----------------------
// CARGAR HISTORIAL
// ----------------------
async function cargarHistorial() {
  if (!tablaHistorial) return;

  tablaHistorial.innerHTML =
    "<tr><td colspan='6'>Cargando...</td></tr>";

  try {
    const ref = collection(db, "ventas");
    const q = query(ref, where("clienteId", "==", clienteId));

    const snap = await getDocs(q);

    if (snap.empty) {
      tablaHistorial.innerHTML =
        "<tr><td colspan='6'>Este cliente no tiene compras registradas.</td></tr>";
      return;
    }

    let rows = "";
    let nombreDetectado = clienteNombreParam || null;

    snap.forEach((docSnap) => {
      const v = docSnap.data();

      // fecha legible
      let fechaLegible = "-";
      if (v.fecha) {
        try {
          fechaLegible = new Date(v.fecha).toLocaleString();
        } catch {
          fechaLegible = v.fecha;
        }
      }

      rows += `
        <tr>
          <td>${fechaLegible}</td>
          <td>${v.productoCodigo || ""} - ${v.productoNombre || ""}</td>
          <td>${v.cantidad || 0}</td>
          <td>$${v.total || 0}</td>
          <td>${v.estado || "-"}</td>
          <td>${v.notas || "-"}</td>
        </tr>
      `;

      if (!nombreDetectado && v.clienteNombre) {
        nombreDetectado = v.clienteNombre;
      }
    });

    tablaHistorial.innerHTML = rows;

    // actualizar título si existe el h1/h2 y encontramos nombre
    if (tituloCliente && nombreDetectado) {
      tituloCliente.textContent = `Historial de compras - ${nombreDetectado}`;
    }
  } catch (e) {
    console.error("Error al cargar historial:", e);
    tablaHistorial.innerHTML =
      "<tr><td colspan='6'>Ocurrió un error al cargar el historial.</td></tr>";
  }
}
