<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Mayorista | Cat√°logo</title>

  <style>
    /* Ocultamos selects reales (se usan internamente) */
    #filtro-categoria,
    #filtro-subcategoria { display: none !important; }

    :root{
      --bg: #0f0f1a;
      --card: #0c0c17;
      --card2: #0a0a12;
      --txt: #ffffff;
      --muted: rgba(255,255,255,.75);
      --muted2: rgba(255,255,255,.55);
      --accent: #ffa400;
      --btn: #202432;
      --shadow: rgba(0,0,0,.55);
    }

    body {
      background: var(--bg);
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--txt);
    }

    /* FULL 3: Header m√°s compacto */
    header {
      background: linear-gradient(90deg, #ff005d, #ffa400);
      padding: 10px 18px;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* ===========================
       TOOLBAR (STICKY PREMIUM)
    ============================*/
    .toolbar {
      display: flex;
      gap: 12px;
      padding: 14px 18px;
      justify-content: flex-start;
      align-items: center;
      flex-wrap: wrap;

      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
      background: rgba(10, 10, 18, 0.55);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .toolbar input {
      padding: 12px 18px;
      border-radius: 30px;
      border: none;
      outline: none;
      font-size: 15px;
      min-width: 260px;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.08);
    }

    /* ===========================
       MEGA MEN√ö CATEGOR√çAS
    ============================*/
    .mega-dropdown { position: relative; min-width: 260px; }

    .mega-toggle {
      width: 100%;
      padding: 12px 18px;
      border-radius: 30px;
      border: none;
      outline: none;
      font-size: 15px;
      background: #ffffff;
      color: #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 8px 22px rgba(0,0,0,.18);
    }

    .mega-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 230px;
      text-align: left;
    }

    .mega-arrow { font-size: 10px; margin-left: 8px; }

    .mega-menu {
      position: absolute;
      top: 110%;
      left: 0;
      background: #111217;
      color: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      display: none;
      min-width: 420px;
      max-width: 720px;
      padding: 12px 8px 40px;
      z-index: 999;
      column-gap: 4px;
    }

    .mega-dropdown.open .mega-menu { display: flex; }

    .mega-col {
      flex: 1;
      padding: 4px 8px;
      border-right: 1px solid rgba(255, 255, 255, 0.08);
    }
    .mega-col:last-child { border-right: none; }

    .mega-col h4 {
      font-size: 13px;
      margin: 4px 4px 8px;
      opacity: 0.75;
    }

    .mega-col ul {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 260px;
      overflow-y: auto;
    }

    .mega-item, .mega-subitem, .mega-tagitem {
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      margin: 2px 0;
      transition: background 0.12s ease, color 0.12s ease, transform .08s ease;
    }

    .mega-item:hover, .mega-subitem:hover, .mega-tagitem:hover { background: #1f2430; transform: translateY(-1px); }

    .mega-item-activo, .mega-subitem-activo, .mega-tagitem-activo {
      background: var(--accent);
      color: #000;
      font-weight: 700;
    }

    .mega-item { position: relative; padding-left: 30px; }
    .mega-item::before {
      content: attr(data-icon);
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 15px;
      opacity: 0.95;
    }

    .mega-reset-btn {
      position: absolute;
      right: 14px;
      bottom: 10px;
      padding: 5px 12px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: transparent;
      color: var(--accent);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .mega-reset-btn span { font-size: 12px; }
    .mega-reset-btn:hover { background: var(--accent); color: #000; }

    .chk-catalogo {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: #c9c9ff;
      user-select: none;
    }
    .chk-catalogo input { accent-color: #ff5ca8; }

    /* ===========================
       GRID + CARDS (PREMIUM)
    ============================*/
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      padding: 18px 18px 12px;
      align-items: stretch;
      grid-auto-rows: 1fr;
    }

    .producto-card {
      position: relative;
      background: radial-gradient(1200px 600px at 50% -100px, rgba(255,164,0,.06), transparent 60%),
                  var(--card);
      border-radius: 18px;
      padding: 10px 8px 8px;
      text-align: center;
      height: 100%;
      display: flex;
      flex-direction: column;

      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 10px 26px rgba(0,0,0,0.35);
      text-decoration: none;
      color: inherit;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      overflow: hidden;
    }

    .producto-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.06), 0 16px 36px rgba(0,0,0,0.55);
    }

    .producto-imagen-wrapper {
      width: 100%;
      height: 160px;
      border-radius: 18px;
      background: var(--card2);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      margin-bottom: 10px;
      color: #7777a7;
      font-size: 13px;
    }

    .producto-imagen {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 16px;
      display: block;
      cursor: pointer;
      transform: translateZ(0);

      /* blur-up */
      filter: blur(10px);
      opacity: 0.85;
      transition: filter .25s ease, opacity .25s ease;
    }
    .producto-imagen.is-loaded { filter: blur(0); opacity: 1; }

    .producto-titulo {
      margin-top: 2px;
      font-size: 15px;
      line-height: 1.15;
      cursor: pointer;
      padding: 0 4px;

      /* clamp 2 l√≠neas */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 36px;
    }

    .producto-descripcion {
      opacity: 0.85;
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.25;

      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 34px;
    }

    .producto-precio-row {
      margin-top: auto;
      padding-top: 10px;
    }

    .producto-precio {
      color: var(--accent);
      font-weight: 900;
      margin-top: 4px;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .producto-stock {
      opacity: 0.9;
      font-size: 12px;
      margin-top: 6px;
      color: var(--muted);
    }

    .cantidad-container {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .btn-cantidad {
      border-radius: 999px;
      border: none;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      background: var(--btn);
      color: #fff;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      transition: transform .08s ease, filter .08s ease;
    }
    .btn-cantidad:hover { filter: brightness(1.07); transform: translateY(-1px); }

    .input-cantidad {
      width: 58px;
      text-align: center;
      border-radius: 999px;
      border: none;
      padding: 6px 8px;
      font-size: 14px;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }

    .btn-agregar-carrito {
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      background: var(--btn);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      transition: transform .08s ease, filter .08s ease;
    }
    .btn-agregar-carrito:hover { filter: brightness(1.06); transform: translateY(-1px); }

    .btn-agregar-carrito-activo { background: #1ebe57; }

    .badge-stock {
      display: inline-block;
      padding: 0.22rem 0.62rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 800;
    }
    .badge-stock.stock-ok { background: rgba(0, 200, 120, 0.16); color: #7cffb5; }
    .badge-stock.stock-bajo { background: rgba(255, 180, 0, 0.16); color: #ffdd7c; }
    .badge-stock.stock-cero { background: rgba(255, 0, 80, 0.16); color: #ff7a9c; }

    .chip-destacado {
      font-size: 0.7rem;
      padding: 0.22rem 0.62rem;
      border-radius: 999px;
      background: rgba(255, 184, 0, 0.16);
      color: #ffd56c;
      margin-left: 0.5rem;
      font-weight: 800;
    }

    /* ===========================
       SKELETON LOADER
    ============================*/
    .skeleton-card {
      background: radial-gradient(1200px 600px at 50% -100px, rgba(255,164,0,.06), transparent 60%),
                  var(--card);
      border-radius: 22px;
      padding: 16px 14px 14px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 10px 26px rgba(0,0,0,0.35);
      overflow: hidden;
      position: relative;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sk-img { height: 160px; border-radius: 18px; background: rgba(255,255,255,0.06); }
    .sk-line { height: 12px; border-radius: 999px; background: rgba(255,255,255,0.06); }
    .sk-line.lg { height: 14px; }
    .sk-line.w80 { width: 80%; margin: 0 auto; }
    .sk-line.w60 { width: 60%; margin: 0 auto; }
    .sk-line.w40 { width: 40%; margin: 0 auto; }

    .skeleton-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.2s infinite;
    }

    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }

    /* ===========================
       MINI CARRITO
    ============================*/
    .mini-carrito {
      position: fixed;
      right: 16px;
      bottom: 90px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.22);
      cursor: pointer;
      z-index: 9999;
      font-size: 13px;
      color: #000;
      transition: transform .08s ease, filter .08s ease;
    }
    .mini-carrito:hover { filter: brightness(1.02); transform: translateY(-1px); }

    .mini-carrito-icono { font-size: 18px; position: relative; }
    .mini-badge {
      position: absolute;
      top: -8px;
      right: -10px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      background: #ff005d;
      color: #fff;
      font-size: 11px;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .mini-carrito-texto { display: flex; flex-direction: column; line-height: 1.1; }
    .mini-carrito-linea { white-space: nowrap; font-weight: 800; }

    /* ===========================
       PAGINADOR
    ============================*/
    .paginador-contenedor {
      margin-top: 32px;
      padding: 18px 0 40px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .paginador-resumen {
      font-size: 12px;
      opacity: 0.6;
      color: #c9c9ff;
      text-align: center;
    }

    .paginador-contenedor::before {
      content: "";
      position: absolute;
      top: 0;
      width: 160px;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.25), transparent);
    }

    .paginador {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .paginador-btn, .paginador-numero {
      border-radius: 999px;
      border: none;
      min-width: 32px;
      height: 32px;
      padding: 0 10px;
      font-size: 13px;
      cursor: pointer;
      background: var(--btn);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.08s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.2);
    }

    .paginador-btn:hover:not(:disabled),
    .paginador-numero:hover {
      background: #2c3244;
      transform: translateY(-1px);
      box-shadow: 0 14px 22px rgba(0, 0, 0, 0.35);
    }

    .paginador-btn:disabled { opacity: 0.4; cursor: default; transform: none; box-shadow: none; }
    .paginador-numero--activo { background: var(--accent); color: #000; font-weight: 900; }

    .paginador-numeros {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* ===========================
       WHATSAPP
    ============================*/
    .btn-wa-flotante {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 99999;
      background: #25d366;
      padding: 14px;
      border-radius: 50%;
      display: flex !important;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
      transition: transform 0.1s ease, filter 0.1s ease;
    }
    .btn-wa-flotante:hover { filter: brightness(1.06); transform: translateY(-1px); }

    /* ===========================
       RESPONSIVE
    ============================*/
    @media (max-width: 768px) {
      header { text-align: center; font-size: 18px; }

      .toolbar {
        padding: 12px 12px 10px;
        gap: 10px;
        flex-direction: column;
        align-items: flex-start;
      }

      .toolbar input {
        width: 100%;
        max-width: 520px;
        font-size: 14px;
      }

      .mega-dropdown { width: 100%; max-width: 520px; }
      .mega-menu { max-width: 100%; min-width: 100%; }

      .grid {
        padding: 14px 12px 10px;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
      }
    }

    @media (max-width: 480px) {
      .grid { grid-template-columns: 1fr; gap: 18px; }
      .btn-wa-flotante { bottom: 140px; right: 14px; }
      .mini-carrito { bottom: 80px; right: 14px; }
      .paginador-resumen { display: none; }
    }
  </style>
</head>

<body>
  <header>DELIVERY MAYORISTA</header>

  <div class="toolbar">
    <input id="buscador" type="text" placeholder="Buscar por c√≥digo o descripci√≥n" />

    <div class="mega-dropdown" id="megaDropdown">
      <button id="categoriaToggle" class="mega-toggle" type="button">
        <span class="mega-label">Todas las categor√≠as</span>
        <span class="mega-arrow">‚ñæ</span>
      </button>

      <div id="megaMenu" class="mega-menu">
        <div class="mega-col">
          <h4>Categor√≠as</h4>
          <ul id="megaCategorias"></ul>
        </div>

        <div class="mega-col">
          <h4 id="megaSubTitle">Subcategor√≠as</h4>
          <ul id="megaSubcategorias"></ul>
        </div>

        <div class="mega-col">
          <h4 id="megaTagTitle">Etiquetas</h4>
          <ul id="megaEtiquetas"></ul>
        </div>

        <button id="megaReset" class="mega-reset-btn" type="button">
          <span>üîÑ</span> Limpiar filtros
        </button>
      </div>
    </div>

    <label class="chk-catalogo">
      <input type="checkbox" id="chkSoloDestacados" />
      Solo destacados
    </label>

    <label class="chk-catalogo">
      <input type="checkbox" id="chkSoloConStock" />
      Solo con stock
    </label>

    <select id="filtro-categoria"></select>
    <select id="filtro-subcategoria"></select>
  </div>

  <div id="catalogoGrid" class="grid"></div>

  <div class="paginador-contenedor">
    <div id="resumen-resultados" class="paginador-resumen"></div>

    <div id="paginador" class="paginador">
      <button id="btn-pagina-anterior" class="paginador-btn" type="button" disabled>‚Äπ</button>
      <div id="paginador-numeros" class="paginador-numeros"></div>
      <button id="btn-pagina-siguiente" class="paginador-btn" type="button" disabled>‚Ä∫</button>
    </div>
  </div>

  <!-- MINI CARRITO -->
  <div id="mini-carrito" class="mini-carrito" onclick="irAlCarrito()">
    <div class="mini-carrito-icono">
      üõí
      <span id="mini-badge" class="mini-badge">0</span>
    </div>
    <div class="mini-carrito-texto">
      <span class="mini-carrito-linea">
        <span id="mini-carrito-cantidad">0</span> productos
      </span>
      <span class="mini-carrito-linea">
        $<span id="mini-carrito-total">0</span>
      </span>
    </div>
  </div>

  <!-- WHATSAPP -->
  <a
    id="wa-flotante"
    class="btn-wa-flotante"
    href="https://wa.me/?text=Hola%20%21%20Quiero%20consultar%20por%20el%20cat%C3%A1logo%20mayorista."
    target="_blank"
    aria-label="WhatsApp"
    rel="noopener"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#ffffff" viewBox="0 0 32 32">
      <path d="M16.019 2.594c-7.453 0-13.438 6.063-13.438 13.531 0 2.375.625 4.656 1.844 6.719l-1.969 7.219 7.453-1.969c1.969 1.063 4.219 1.625 6.375 1.625h.031c7.438 0 13.438-6.063 13.438-13.531 0-3.594-1.406-6.938-3.969-9.469-2.531-2.531-5.906-4.125-9.656-4.125zm0 24.844h-.031c-1.938 0-3.813-.5-5.469-1.406l-.406-.219-4.438 1.188 1.188-4.344-.25-.406c-1.188-1.906-1.813-4.094-1.813-6.375 0-6.563 5.344-11.906 11.906-11.906 3.188 0 6.156 1.25 8.406 3.5 2.25 2.25 3.5 5.219 3.5 8.406-.031 6.531-5.375 11.875-11.906 11.875zm6.344-8.531c-.344-.188-2.031-1-2.344-1.094-.313-.094-.531-.156-.75.188-.219.344-.875 1.094-1.063 1.313-.188.188-.375.219-.719.031-.344-.188-1.438-.531-2.75-1.656-1-.875-1.656-1.938-1.844-2.281-.188-.344-.016-.531.156-.719.156-.156.344-.406.5-.594.156-.188.219-.313.344-.531.094-.219.031-.406-.031-.594-.063-.188-.75-1.844-1.031-2.5-.281-.656-.563-.563-.75-.563h-.656c-.219 0-.594.094-.906.438-.313.344-1.188 1.156-1.188 2.813s1.219 3.25 1.406 3.469c.188.219 2.406 3.656 5.844 5 3.438 1.344 3.438.875 4.063.813.625-.063 2.031-.813 2.313-1.594.281-.781.281-1.438.219-1.594-.063-.156-.281-.25-.625-.438z"/>
    </svg>
  </a>

  <script type="module">
    import { db } from "./js/firebase-init.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // =========================
    // CONFIG / CONSTANTES
    // =========================
    const COL_PRODUCTOS = "productos";
    const BASE_IMG = "https://raw.githubusercontent.com/agustapia3636/deliverymayorista-img/main";

    const CACHE_KEY = "dm_catalogo_cache_v2";
    const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 horas
    const CACHE_IMG_NAME = "dm_img_cache_v1";

    const CART_KEY = "carrito_dm_v1";
    const UI_STATE_KEY = "dm_catalogo_ui_state_v2";

    // =========================
    // PAGINACI√ìN
    // =========================
    function calcularItemsPorPagina() { return window.innerWidth >= 1200 ? 28 : 16; }
    let ITEMS_POR_PAGINA = calcularItemsPorPagina();

    // =========================
    // DOM
    // =========================
    const grid = document.getElementById("catalogoGrid");
    const buscador = document.getElementById("buscador");
    const chkSoloDestacados = document.getElementById("chkSoloDestacados");
    const chkSoloConStock = document.getElementById("chkSoloConStock");

    const megaDropdown = document.getElementById("megaDropdown");
    const categoriaToggle = document.getElementById("categoriaToggle");
    const megaCategorias = document.getElementById("megaCategorias");
    const megaSubcategorias = document.getElementById("megaSubcategorias");
    const megaEtiquetas = document.getElementById("megaEtiquetas");
    const megaReset = document.getElementById("megaReset");

    const resumenResultados = document.getElementById("resumen-resultados");
    const btnAnterior = document.getElementById("btn-pagina-anterior");
    const btnSiguiente = document.getElementById("btn-pagina-siguiente");
    const paginadorNumeros = document.getElementById("paginador-numeros");

    const miniCantidad = document.getElementById("mini-carrito-cantidad");
    const miniTotal = document.getElementById("mini-carrito-total");
    const toolbar = document.querySelector(".toolbar");

    // =========================
    // ORDEN (inyectable)
    // =========================
    let ordenarSelect = document.getElementById("ordenar");
    if (!ordenarSelect && toolbar) {
      ordenarSelect = document.createElement("select");
      ordenarSelect.id = "ordenar";
      ordenarSelect.className = "toolbar-select";
      ordenarSelect.innerHTML = `
        <option value="destacados">Orden: Destacados</option>
        <option value="nombre_az">Orden: Nombre A‚ÜíZ</option>
        <option value="nombre_za">Orden: Nombre Z‚ÜíA</option>
        <option value="precio_asc">Orden: Precio ‚Üë</option>
        <option value="precio_desc">Orden: Precio ‚Üì</option>
        <option value="stock_desc">Orden: Stock ‚Üì</option>
      `;
      const selCat = document.getElementById("filtro-categoria");
      toolbar.insertBefore(ordenarSelect, selCat || null);

      if (!document.querySelector("style[data-toolbar-select]")) {
        const st = document.createElement("style");
        st.setAttribute("data-toolbar-select", "1");
        st.textContent = `
          .toolbar-select{
            padding: 12px 18px;
            border-radius: 30px;
            border: none;
            outline: none;
            font-size: 15px;
            background: #ffffff;
            color: #000;
            cursor: pointer;
            min-width: 220px;
            box-shadow: 0 8px 22px rgba(0,0,0,.18);
          }
          @media (max-width: 768px){
            .toolbar-select{ width:100%; max-width:520px; }
          }
        `;
        document.head.appendChild(st);
      }
    }

    // =========================
    // STATE
    // =========================
    let catalogo = [];
    let filtrados = [];

    let filtroCategoria = "";
    let filtroSubcategoria = "";
    let filtroEtiqueta = "";
    let pagina = 1;

    // =========================
    // HELPERS
    // =========================
    const norm = (s) => String(s ?? "").trim();
    const lower = (s) => norm(s).toLowerCase();

    function parsearPrecio(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string") {
        const limpio = v.replace(/\./g, "").replace(",", ".");
        const n = Number(limpio);
        return Number.isFinite(n) ? n : null;
      }
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function formatoARS(n) {
      if (n == null || !Number.isFinite(n)) return "";
      return n.toLocaleString("es-AR", { maximumFractionDigits: 0 });
    }

    function stockBadge(stock) {
      const st = Number(stock);
      if (!Number.isFinite(st) || st <= 0) return { cls: "stock-cero", txt: "Sin stock" };
      if (st <= 5) return { cls: "stock-bajo", txt: "Stock bajo" };
      return { cls: "stock-ok", txt: "En stock" };
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeHtmlAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

    function normalizarProducto(raw) {
      const p = raw || {};
      const codigo = p.codigo ?? p.Codigo ?? p.id ?? "";
      const nombre = p.nombre ?? p.Nombre ?? "";
      const categoria = p.categoria ?? p.Categoria_Princ ?? "";
      const subcategoria = p.subcategoria ?? p.Sub_Categoria ?? "";
      const etiquetas = p.etiquetas ?? p.Etiquetas ?? p.tags ?? "";
      const destacado = Boolean(p.destacado ?? p.Destacado ?? false);

      const descripcion = p.descripcion ?? p.Descripcion ?? p.descripcionLarga ?? "";
      const precio = parsearPrecio(p.precio ?? p.PrecioMayorista);
      const stock = Number(p.stock ?? p.Stock ?? 0);
      const imagen = p.imagen ?? p.Imagen ?? "";

      const tagsArr = Array.isArray(etiquetas)
        ? etiquetas.map(norm).filter(Boolean)
        : String(etiquetas || "")
            .split(/[;,|]/g)
            .map(norm)
            .filter(Boolean);

      const productosTexto =
        `${codigo} ${nombre} ${descripcion} ${categoria} ${subcategoria} ${tagsArr.join(" ")}`.toLowerCase();

      return {
        ...p,
        codigo: String(codigo),
        nombre,
        categoria,
        subcategoria,
        tagsArr,
        destacado,
        descripcion,
        precio,
        stock,
        imagen,
        productosTexto
      };
    }

    // =========================
    // SKELETON
    // =========================
    function renderSkeleton(count) {
      const n = Math.max(8, Math.floor(count || ITEMS_POR_PAGINA));
      grid.innerHTML = new Array(n).fill(0).map(() => `
        <div class="skeleton-card">
          <div class="sk-img"></div>
          <div class="sk-line lg w80"></div>
          <div class="sk-line w60"></div>
          <div class="sk-line w40"></div>
        </div>
      `).join("");
    }

    // =========================
    // CACHE (cat√°logo)
    // =========================
    function cacheLeer() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.data) || !obj.ts) return null;
        if ((Date.now() - obj.ts) > CACHE_TTL_MS) return null;
        return obj.data;
      } catch { return null; }
    }

    function cacheGuardar(data) {
      try { localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch {}
    }

    // =========================
    // IM√ÅGENES
    // =========================
    function candidatosImagen(p) {
      const codigo = p.codigo || "";
      const directa = p.imagen || "";
      const base = [
        directa,
        `${BASE_IMG}/${codigo}.jpg`,
        `${BASE_IMG}/${codigo}.JPG`,
        `${BASE_IMG}/${codigo}.jpeg`,
        `${BASE_IMG}/${codigo}.JPEG`,
        `${BASE_IMG}/${codigo}.png`,
        `${BASE_IMG}/${codigo}.PNG`,
        `${BASE_IMG}/${codigo}.webp`,
        `${BASE_IMG}/${codigo}.WEBP`,
      ].filter(Boolean);
      return [...new Set(base)];
    }

    async function warmCacheImage(url) {
      try {
        if (!("caches" in window)) return;
        const cache = await caches.open(CACHE_IMG_NAME);
        const hit = await cache.match(url, { ignoreSearch: true });
        if (hit) return;
        await cache.add(url);
      } catch {}
    }

    function preloadFirstOk(cands) {
      return new Promise((resolve) => {
        if (!cands?.length) return resolve("");
        let i = 0;
        const tryNext = () => {
          if (i >= cands.length) return resolve("");
          const url = cands[i++];
          const img = new Image();
          img.decoding = "async";
          img.loading = "eager";
          img.referrerPolicy = "no-referrer";
          img.onload = async () => { warmCacheImage(url); resolve(url); };
          img.onerror = tryNext;
          img.src = url;
        };
        tryNext();
      });
    }

    async function precargarPagina(items) {
      const top = items.slice(0, Math.min(12, items.length));
      for (const p of top) {
        const cands = candidatosImagen(p);
        if (cands[0]) warmCacheImage(cands[0]);
        preloadFirstOk(cands).catch(() => {});
      }
    }

    // =========================
    // FIRESTORE
    // =========================
    async function cargarCatalogoFirestore() {
      const ref = collection(db, COL_PRODUCTOS);
      const snap = await getDocs(ref);
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      return arr;
    }

    // =========================
    // UI STATE + URL
    // =========================
    function uiStateReadLocal() {
      try {
        const raw = localStorage.getItem(UI_STATE_KEY);
        if (!raw) return null;
        const s = JSON.parse(raw);
        return s && typeof s === "object" ? s : null;
      } catch { return null; }
    }

    function uiStateWriteLocal(s) {
      try { localStorage.setItem(UI_STATE_KEY, JSON.stringify(s)); } catch {}
    }

    function uiStateReadURL() {
      const sp = new URLSearchParams(location.search);
      const hasAny = ["q","cat","sub","tag","dest","stock","ord","page"].some(k => sp.has(k));
      if (!hasAny) return null;

      return {
        q: sp.get("q") ?? "",
        cat: sp.get("cat") ?? "",
        sub: sp.get("sub") ?? "",
        tag: sp.get("tag") ?? "",
        dest: (sp.get("dest") ?? "0") === "1",
        stock: (sp.get("stock") ?? "0") === "1",
        ord: sp.get("ord") ?? "destacados",
        page: Math.max(1, Number(sp.get("page") || 1))
      };
    }

    function uiStateToObject() {
      return {
        q: buscador.value || "",
        cat: filtroCategoria || "",
        sub: filtroSubcategoria || "",
        tag: filtroEtiqueta || "",
        dest: !!chkSoloDestacados.checked,
        stock: !!chkSoloConStock.checked,
        ord: ordenarSelect ? (ordenarSelect.value || "destacados") : "destacados",
        page: pagina || 1,
        ts: Date.now()
      };
    }

    function uiStateApply(s) {
      if (!s) return;
      buscador.value = s.q ?? "";
      chkSoloDestacados.checked = !!s.dest;
      chkSoloConStock.checked = !!s.stock;

      if (ordenarSelect && s.ord) ordenarSelect.value = s.ord;

      filtroCategoria = s.cat ?? "";
      filtroSubcategoria = s.sub ?? "";
      filtroEtiqueta = s.tag ?? "";
      pagina = Math.max(1, Number(s.page) || 1);

      const label = filtroCategoria ? filtroCategoria : "Todas las categor√≠as";
      const lb = megaDropdown?.querySelector(".mega-label");
      if (lb) lb.textContent = label;
    }

    let uiSaveTimer = null;
    function uiStateSaveDebounced() {
      clearTimeout(uiSaveTimer);
      uiSaveTimer = setTimeout(uiStateSaveNow, 220);
    }

    function uiStateSaveNow() {
      const s = uiStateToObject();
      uiStateWriteLocal(s);

      const url = new URL(location.href);
      const sp = url.searchParams;

      ["q","cat","sub","tag","dest","stock","ord","page"].forEach(k => sp.delete(k));

      if (s.q) sp.set("q", s.q);
      if (s.cat) sp.set("cat", s.cat);
      if (s.sub) sp.set("sub", s.sub);
      if (s.tag) sp.set("tag", s.tag);
      if (s.dest) sp.set("dest", "1");
      if (s.stock) sp.set("stock", "1");
      if (s.ord && s.ord !== "destacados") sp.set("ord", s.ord);
      if (s.page && s.page !== 1) sp.set("page", String(s.page));

      history.replaceState(null, "", url.toString());
    }

    // =========================
    // MEGA MENU
    // =========================
    function iconoCategoria(cat) {
      const c = lower(cat);
      if (c.includes("beb")) return "ü•§";
      if (c.includes("limp")) return "üßΩ";
      if (c.includes("gallet") || c.includes("snack")) return "üç™";
      if (c.includes("almac")) return "üß∫";
      if (c.includes("perf") || c.includes("hig")) return "üß¥";
      return "üì¶";
    }

    function buildMegaMenu() {
      const cats = new Map(); // cat -> {sub:Set, tags:Set}
      for (const p of catalogo) {
        const c = norm(p.categoria) || "Sin categor√≠a";
        const s = norm(p.subcategoria) || "";
        if (!cats.has(c)) cats.set(c, { sub: new Set(), tags: new Set() });
        if (s) cats.get(c).sub.add(s);
        for (const t of (p.tagsArr || [])) cats.get(c).tags.add(t);
      }

      const categorias = [...cats.keys()].sort((a,b)=>a.localeCompare(b,"es"));
      megaCategorias.innerHTML = `
        <li class="mega-item ${filtroCategoria==="" ? "mega-item-activo":""}" data-icon="‚ú®" data-cat="">
          Todas
        </li>
        ${categorias.map(c => `
          <li class="mega-item ${filtroCategoria===c ? "mega-item-activo":""}" data-icon="${iconoCategoria(c)}" data-cat="${escapeHtmlAttr(c)}">
            ${escapeHtml(c)}
          </li>
        `).join("")}
      `;

      function renderSubsTags(cat) {
        const obj = cats.get(cat) || { sub:new Set(), tags:new Set() };
        const subs = [...obj.sub].sort((a,b)=>a.localeCompare(b,"es"));
        const tags = [...obj.tags].sort((a,b)=>a.localeCompare(b,"es"));

        megaSubcategorias.innerHTML = `
          <li class="mega-subitem ${filtroSubcategoria==="" ? "mega-subitem-activo":""}" data-sub="">
            Todas
          </li>
          ${subs.map(s => `
            <li class="mega-subitem ${filtroSubcategoria===s ? "mega-subitem-activo":""}" data-sub="${escapeHtmlAttr(s)}">
              ${escapeHtml(s)}
            </li>
          `).join("")}
        `;

        megaEtiquetas.innerHTML = `
          <li class="mega-tagitem ${filtroEtiqueta==="" ? "mega-tagitem-activo":""}" data-tag="">
            Todas
          </li>
          ${tags.map(t => `
            <li class="mega-tagitem ${filtroEtiqueta===t ? "mega-tagitem-activo":""}" data-tag="${escapeHtmlAttr(t)}">
              #${escapeHtml(t)}
            </li>
          `).join("")}
        `;
      }

      const catActual = filtroCategoria || categorias[0] || "Sin categor√≠a";
      renderSubsTags(catActual);

      megaCategorias.querySelectorAll(".mega-item").forEach(li => {
        li.addEventListener("click", () => {
          filtroCategoria = li.getAttribute("data-cat") || "";
          filtroSubcategoria = "";
          filtroEtiqueta = "";
          pagina = 1;

          const label = filtroCategoria ? filtroCategoria : "Todas las categor√≠as";
          megaDropdown.querySelector(".mega-label").textContent = label;

          buildMegaMenu();
          aplicarFiltros();
          render();
          uiStateSaveNow();
        });
      });

      megaSubcategorias.querySelectorAll(".mega-subitem").forEach(li => {
        li.addEventListener("click", () => {
          filtroSubcategoria = li.getAttribute("data-sub") || "";
          pagina = 1;
          buildMegaMenu();
          aplicarFiltros();
          render();
          uiStateSaveNow();
        });
      });

      megaEtiquetas.querySelectorAll(".mega-tagitem").forEach(li => {
        li.addEventListener("click", () => {
          filtroEtiqueta = li.getAttribute("data-tag") || "";
          pagina = 1;
          buildMegaMenu();
          aplicarFiltros();
          render();
          uiStateSaveNow();
        });
      });

      megaReset.onclick = () => {
        filtroCategoria = "";
        filtroSubcategoria = "";
        filtroEtiqueta = "";
        pagina = 1;
        megaDropdown.querySelector(".mega-label").textContent = "Todas las categor√≠as";
        buildMegaMenu();
        aplicarFiltros();
        render();
        uiStateSaveNow();
      };
    }

    // =========================
    // FILTRADO + ORDEN
    // =========================
    function aplicarFiltros() {
      const texto = lower(buscador.value || "");

      filtrados = catalogo.filter(p => {
        if (texto && !p.productosTexto.includes(texto)) return false;

        if (filtroCategoria) {
          const c = norm(p.categoria) || "Sin categor√≠a";
          if (c !== filtroCategoria) return false;
        }
        if (filtroSubcategoria) {
          const s = norm(p.subcategoria) || "";
          if (s !== filtroSubcategoria) return false;
        }
        if (filtroEtiqueta) {
          const tags = p.tagsArr || [];
          if (!tags.includes(filtroEtiqueta)) return false;
        }

        if (chkSoloDestacados.checked && !p.destacado) return false;
        if (chkSoloConStock.checked && !(Number(p.stock) > 0)) return false;

        return true;
      });

      const mode = ordenarSelect ? (ordenarSelect.value || "destacados") : "destacados";
      const getNombre = (x) => (x.nombre || x.codigo || "").toString();
      const getPrecio = (x) => (Number.isFinite(Number(x.precio)) ? Number(x.precio) : Infinity);
      const getStock = (x) => (Number.isFinite(Number(x.stock)) ? Number(x.stock) : -1);

      filtrados.sort((a,b) => {
        if (mode === "destacados") {
          const da = a.destacado ? 1 : 0;
          const dbb = b.destacado ? 1 : 0;
          if (da !== dbb) return dbb - da;
          return getNombre(a).localeCompare(getNombre(b), "es");
        }
        if (mode === "nombre_az") return getNombre(a).localeCompare(getNombre(b), "es");
        if (mode === "nombre_za") return getNombre(b).localeCompare(getNombre(a), "es");
        if (mode === "precio_asc") return getPrecio(a) - getPrecio(b);
        if (mode === "precio_desc") return getPrecio(b) - getPrecio(a);
        if (mode === "stock_desc") return getStock(b) - getStock(a);
        return 0;
      });
    }

    // =========================
    // CARRITO
    // =========================
    function leerCarrito() {
      try {
        const raw = localStorage.getItem(CART_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function guardarCarrito(arr) {
      try { localStorage.setItem(CART_KEY, JSON.stringify(arr)); } catch {}
      actualizarMiniCarrito();

      // üîî clave: avisamos a todo el cat√°logo que cambi√≥ el carrito
      window.dispatchEvent(new CustomEvent("dm-carrito-update", { detail: arr }));
    }

    function carritoAgregar(p, cantidad) {
      const qty = Math.max(1, Math.floor(Number(cantidad) || 1));
      const cart = leerCarrito();
      const idx = cart.findIndex(x => String(x.codigo) === String(p.codigo));
      if (idx >= 0) cart[idx].cantidad = (Number(cart[idx].cantidad) || 0) + qty;
      else cart.push({
        codigo: p.codigo,
        nombre: p.nombre,
        precio: p.precio ?? null,
        stock: p.stock ?? 0,
        imagen: p.imagen ?? "",
        cantidad: qty
      });
      guardarCarrito(cart);
    }

    function actualizarMiniCarrito() {
      const cart = leerCarrito();
      let cant = 0, total = 0;
      for (const it of cart) {
        const q = Number(it.cantidad) || 0;
        cant += q;
        const pr = Number(it.precio);
        if (Number.isFinite(pr)) total += pr * q;
      }
      miniCantidad.textContent = String(cant);
      miniTotal.textContent = formatoARS(total);

      const miniBadge = document.getElementById("mini-badge");
      if (miniBadge) miniBadge.textContent = String(cant);
    }

    window.irAlCarrito = function() {
      location.href = "carrito.html";
    };

    // =========================
    // STOCK VISUAL DESDE CARRITO (sube/baja)
    // =========================
    function actualizarStockVisualDesdeCarrito() {
      const cart = leerCarrito();

      // map codigo -> cantidad en carrito
      const enCarrito = {};
      cart.forEach(it => {
        const cod = String(it.codigo);
        enCarrito[cod] = (enCarrito[cod] || 0) + (Number(it.cantidad) || 0);
      });

      grid.querySelectorAll(".producto-card").forEach(card => {
        const codigo = card.getAttribute("data-codigo");
        const stockBox = card.querySelector(".producto-stock");
        const stockNum = stockBox?.querySelector(".stock-num");
        const badge = stockBox?.querySelector(".badge-stock");
        const btnAgregar = card.querySelector(".btn-agregar-carrito");

        if (!codigo || !stockBox || !stockNum) return;

        const stockOriginal = Number(stockBox.getAttribute("data-stock-original"));
        if (!Number.isFinite(stockOriginal)) return;

        const usado = enCarrito[String(codigo)] || 0;
        const stockActual = Math.max(0, stockOriginal - usado);

        stockBox.setAttribute("data-stock", stockActual);
        stockNum.textContent = stockActual;

        if (badge) {
          if (stockActual <= 0) {
            badge.textContent = "Sin stock";
            badge.className = "badge-stock stock-cero";
            if (btnAgregar) { btnAgregar.disabled = true; btnAgregar.textContent = "Sin stock"; }
          } else if (stockActual <= 5) {
            badge.textContent = "Stock bajo";
            badge.className = "badge-stock stock-bajo";
            if (btnAgregar) { btnAgregar.disabled = false; btnAgregar.textContent = "üõí Agregar"; }
          } else {
            badge.textContent = "En stock";
            badge.className = "badge-stock stock-ok";
            if (btnAgregar) { btnAgregar.disabled = false; btnAgregar.textContent = "üõí Agregar"; }
          }
        }
      });
    }

    window.addEventListener("dm-carrito-update", () => {
      actualizarStockVisualDesdeCarrito();
    });

    // =========================
    // BACK (volver a cat√°logo desde producto)
    // =========================
    function irAProductoConBack(codigo){
      const back = encodeURIComponent(location.pathname + location.search);
      location.href = `producto.html?codigo=${encodeURIComponent(codigo)}&back=${back}`;
    }

    // =========================
    // HANDLERS POR CARD
    // =========================
    function attachCardHandlers() {
      grid.querySelectorAll(".producto-card").forEach(card => {
        const codigo = card.getAttribute("data-codigo") || "";
        const input = card.querySelector(".input-cantidad");
        const btnMenos = card.querySelector('[data-act="menos"]');
        const btnMas = card.querySelector('[data-act="mas"]');
        const btnAgregar = card.querySelector(".btn-agregar-carrito");
        const img = card.querySelector(".producto-imagen");

        // imagen blur-up + fallback
        if (img) {
          img.addEventListener("load", () => img.classList.add("is-loaded"), { once: true });

          const raw = img.getAttribute("data-cands") || "[]";
          let cands = [];
          try { cands = JSON.parse(raw) || []; } catch {}
          let idx = 0;
          img.onerror = () => {
            idx++;
            if (idx < cands.length) {
              img.classList.remove("is-loaded");
              img.src = cands[idx];
            }
          };
        }

        // click a producto (con back)
        card.querySelector(".producto-imagen-wrapper")?.addEventListener("click", () => irAProductoConBack(codigo));
        card.querySelector(".producto-titulo")?.addEventListener("click", () => irAProductoConBack(codigo));

        btnMenos?.addEventListener("click", () => {
          const v = Math.max(1, (Number(input?.value) || 1) - 1);
          if (input) input.value = String(v);
        });

        btnMas?.addEventListener("click", () => {
          const v = Math.max(1, (Number(input?.value) || 1) + 1);
          if (input) input.value = String(v);
        });

        btnAgregar?.addEventListener("click", () => {
          const p = catalogo.find(x => String(x.codigo) === String(codigo));
          if (!p) return;

          const qty = Math.max(1, Number(input?.value) || 1);

          // si ya estaba disabled, no hacemos nada
          if (btnAgregar.disabled) return;

          // üõí carrito (esto dispara dm-carrito-update tambi√©n)
          carritoAgregar(p, qty);

          // üìâ bajar stock visual de ESTA card (respuesta instant√°nea)
          const stockBox = card.querySelector(".producto-stock");
          const stockNum = stockBox?.querySelector(".stock-num");

          if (stockBox && stockNum) {
            let stockActual = Number(stockBox.getAttribute("data-stock")) || 0;
            if (stockActual <= 0) return;

            stockActual = Math.max(0, stockActual - qty);
            stockBox.setAttribute("data-stock", stockActual);
            stockNum.textContent = stockActual;

            const badge = stockBox.querySelector(".badge-stock");
            if (badge) {
              if (stockActual <= 0) {
                badge.textContent = "Sin stock";
                badge.className = "badge-stock stock-cero";
                btnAgregar.disabled = true;
                btnAgregar.textContent = "Sin stock";
              } else if (stockActual <= 5) {
                badge.textContent = "Stock bajo";
                badge.className = "badge-stock stock-bajo";
                btnAgregar.disabled = false;
              } else {
                badge.textContent = "En stock";
                badge.className = "badge-stock stock-ok";
                btnAgregar.disabled = false;
              }
            }
          }

          // feedback bot√≥n (solo si NO qued√≥ sin stock)
          if (!btnAgregar.disabled) {
            btnAgregar.classList.add("btn-agregar-carrito-activo");
            btnAgregar.textContent = "‚úÖ Agregado";
            setTimeout(() => {
              btnAgregar.classList.remove("btn-agregar-carrito-activo");
              btnAgregar.textContent = "üõí Agregar";
            }, 900);
          }
        });
      });
    }

    // =========================
    // RENDER
    // =========================
    function render() {
      const total = filtrados.length;
      const totalPaginas = Math.max(1, Math.ceil(total / ITEMS_POR_PAGINA));
      pagina = Math.min(Math.max(1, pagina), totalPaginas);

      const desde = (pagina - 1) * ITEMS_POR_PAGINA;
      const hasta = Math.min(desde + ITEMS_POR_PAGINA, total);

      const pageItems = filtrados.slice(desde, hasta);

      resumenResultados.textContent =
        total === 0 ? "Sin resultados." : `Mostrando ${desde + 1}‚Äì${hasta} de ${total} productos`;

      btnAnterior.disabled = pagina <= 1;
      btnSiguiente.disabled = pagina >= totalPaginas;

      // numeritos
      paginadorNumeros.innerHTML = "";
      const maxBtns = 7;
      const half = Math.floor(maxBtns / 2);
      let start = Math.max(1, pagina - half);
      let end = Math.min(totalPaginas, start + maxBtns - 1);
      start = Math.max(1, end - maxBtns + 1);

      for (let p = start; p <= end; p++) {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "paginador-numero" + (p === pagina ? " paginador-numero--activo" : "");
        b.textContent = String(p);
        b.onclick = () => {
          pagina = p;
          uiStateSaveNow();
          renderSkeleton(ITEMS_POR_PAGINA);
          setTimeout(() => {
            render();
            window.scrollTo({ top: 0, behavior: "smooth" });
          }, 60);
        };
        paginadorNumeros.appendChild(b);
      }

      btnAnterior.onclick = () => {
        pagina--;
        uiStateSaveNow();
        renderSkeleton(ITEMS_POR_PAGINA);
        setTimeout(() => { render(); window.scrollTo({ top: 0, behavior: "smooth" }); }, 60);
      };

      btnSiguiente.onclick = () => {
        pagina++;
        uiStateSaveNow();
        renderSkeleton(ITEMS_POR_PAGINA);
        setTimeout(() => { render(); window.scrollTo({ top: 0, behavior: "smooth" }); }, 60);
      };

      // cards
      grid.innerHTML = pageItems.map(p => {
        const badge = stockBadge(Number(p.stock));
        const chip = p.destacado ? `<span class="chip-destacado">Destacado</span>` : "";
        const desc = p.descripcion ? escapeHtml(p.descripcion) : "";

        const imgCands = candidatosImagen(p);
        const img0 = imgCands[0] || "";

        return `
          <div class="producto-card" data-codigo="${escapeHtmlAttr(p.codigo)}">
            <div class="producto-imagen-wrapper">
              <img class="producto-imagen"
                data-cands="${escapeHtmlAttr(JSON.stringify(imgCands))}"
                src="${escapeHtmlAttr(img0)}"
                alt="${escapeHtmlAttr(p.nombre || p.codigo)}"
                loading="lazy"
                decoding="async"
                referrerpolicy="no-referrer"
              />
            </div>

            <div class="producto-titulo" title="${escapeHtmlAttr(p.nombre || "")}">
              ${escapeHtml(p.nombre || "Producto")} ${chip}
            </div>

            <div class="producto-descripcion">${desc}</div>

            <div class="producto-stock"
                 data-stock="${Number(p.stock)}"
                 data-stock-original="${Number(p.stock)}">
              <span class="badge-stock ${badge.cls}">${badge.txt}</span>
              ¬∑ <span class="stock-num">${Number(p.stock)}</span> u
            </div>

            <div class="cantidad-container">
              <button class="btn-cantidad" type="button" data-act="menos">‚àí</button>
              <input class="input-cantidad" type="number" min="1" value="1" />
              <button class="btn-cantidad" type="button" data-act="mas">+</button>
            </div>

            <button class="btn-agregar-carrito" type="button">üõí Agregar</button>
          </div>
        `;
      }).join("");

      attachCardHandlers();
      precargarPagina(pageItems).catch(() => {});

      // ‚úÖ recalcula stock visual considerando lo que ya hay en carrito (SUBE/BAJA)
      actualizarStockVisualDesdeCarrito();
    }

    // =========================
    // EVENTS
    // =========================
    categoriaToggle.addEventListener("click", () => {
      megaDropdown.classList.toggle("open");
    });

    document.addEventListener("click", (e) => {
      if (!megaDropdown.contains(e.target)) megaDropdown.classList.remove("open");
    });

    buscador.addEventListener("input", () => {
      pagina = 1;
      aplicarFiltros();
      render();
      uiStateSaveDebounced();
    });

    chkSoloDestacados.addEventListener("change", () => {
      pagina = 1;
      aplicarFiltros();
      render();
      uiStateSaveDebounced();
    });

    chkSoloConStock.addEventListener("change", () => {
      pagina = 1;
      aplicarFiltros();
      render();
      uiStateSaveDebounced();
    });

    if (ordenarSelect) {
      ordenarSelect.addEventListener("change", () => {
        pagina = 1;
        aplicarFiltros();
        render();
        uiStateSaveDebounced();
      });
    }

    window.addEventListener("resize", () => {
      const nuevo = calcularItemsPorPagina();
      if (nuevo !== ITEMS_POR_PAGINA) {
        ITEMS_POR_PAGINA = nuevo;
        pagina = 1;
        uiStateSaveNow();
        renderSkeleton(ITEMS_POR_PAGINA);
        setTimeout(() => render(), 60);
      }
    });

    // =========================
    // INIT
    // =========================
    async function init() {
      actualizarMiniCarrito();
      renderSkeleton(ITEMS_POR_PAGINA);

      const sUrl = uiStateReadURL();
      const sLocal = uiStateReadLocal();
      uiStateApply(sUrl || sLocal);

      const cached = cacheLeer();
      if (cached?.length) {
        catalogo = cached.map(normalizarProducto);
        aplicarFiltros();
        buildMegaMenu();
        render();
        uiStateSaveNow();

        cargarCatalogoFirestore()
          .then(arr => {
            cacheGuardar(arr);
            catalogo = arr.map(normalizarProducto);
            aplicarFiltros();
            buildMegaMenu();
            render();
            uiStateSaveNow();
          })
          .catch(() => {});
        return;
      }

      try {
        const arr = await cargarCatalogoFirestore();
        cacheGuardar(arr);
        catalogo = arr.map(normalizarProducto);
        aplicarFiltros();
        buildMegaMenu();
        render();
        uiStateSaveNow();
      } catch (e) {
        console.error("Error cat√°logo:", e);
        grid.innerHTML = `
          <div style="opacity:.9;color:#ff7a9c;padding:8px 2px;">
            Error cargando cat√°logo desde Firestore.
          </div>
        `;
      }
    }

    init();
  </script>
</body>
</html>
