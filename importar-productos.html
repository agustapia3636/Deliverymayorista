<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Importador Firestore v2</title>
  <style>
    body { background: #000; color: white; font-family: sans-serif; padding: 40px; }
    button { padding: 10px 20px; font-size: 18px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Importar productos.json a Firestore</h1>
  <button id="importarBtn">IMPORTAR AHORA</button>

  <pre id="log"></pre>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCH2dJRTpXpOPUhAERnAkcj_avqbEYCSXE",
      authDomain: "deliverymayorista-8c042.firebaseapp.com",
      projectId: "deliverymayorista-8c042",
      storageBucket: "deliverymayorista-8c042.firebasestorage.app",
      messagingSenderId: "98776210634",
      appId: "1:98776210634:web:5e89cecdb641988d53e833"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const logBox = document.getElementById("log");
    function log(msg) {
      logBox.textContent += msg + "\n";
      console.log(msg);
    }

    function sanitize(product) {
      let obj = {};

      for (let k in product) {
        let v = product[k];

        if (v === null || v === undefined) v = "";
        if (typeof v === "string" && !isNaN(Number(v)) && k.toLowerCase().includes("precio")) {
          v = Number(v);
        }
        obj[k] = v;
      }

      return obj;
    }

    async function importar() {
      log("Leyendo productos.json...");
      const resp = await fetch("data/productos.json");
      const data = await resp.json();

      let ok = 0;
      let fail = 0;

      for (let p of data) {
        try {
          const safe = sanitize(p);
          const codigo = safe.codigo || "sin-codigo-" + Date.now();
          await setDoc(doc(db, "productos", codigo), safe);
          ok++;
        } catch (err) {
          fail++;
          log("‚ùå Error: " + err.message);
        }
      }

      log("=================================");
      log("üì¶ Importados correctamente: " + ok);
      log("‚ùå Fallidos: " + fail);
      log("=================================");
    }

    document.getElementById("importarBtn").addEventListener("click", importar);
  </script>
</body>
</html>
